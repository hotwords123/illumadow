{"version":3,"sources":["input/KeyboardManager.ts","map/LevelManager.ts","base/math.ts","scene/Scene.ts","render/TextureManager.ts","model/Sprite.ts","model/Model.ts","model/Entity.ts","map/interfaces.ts","render/Animation.ts","model/Particle.ts","assets/entity/melee-wave.png","assets/entity/dive-attack-wave.png","assets/entity/dive-side-attack-wave.png","assets/entity/damage-burst.png","assets/entity/witch-teleport.png","model/Mob.ts","model/Terrain.ts","assets/terrain/brick.png","assets/terrain/spikes.png","assets/terrain/water.png","scene/Subtitle.ts","model/Player.ts","assets/entity/player.png","scene/Camera.ts","ai/PlatformWalkGoal.ts","model/StateMachine.ts","model/Item.ts","model/enemy/Scout.ts","assets/entity/flower.png","assets/entity/ruby.png","assets/entity/scout.png","assets/entity/skeleton-scout.png","model/enemy/Guard.ts","assets/entity/guard.png","scene/SelectMenu.ts","model/Decoration.ts","assets/decoration/tree.png","assets/decoration/brick-wall.png","assets/decoration/brick-wall-light.png","assets/decoration/sign.png","model/projectile/index.ts","model/projectile/Arrow.ts","model/enemy/Archer.ts","assets/entity/arrow.png","assets/entity/archer.png","assets/entity/skeleton-archer.png","scene/Background.ts","assets/background/forest1.png","assets/background/forest2.png","assets/background/cloud.png","assets/background/castle.png","scene/Landmark.ts","scene/SpawnPoint.ts","scene/FocusCircle.ts","scene/Trigger.ts","model/enemy/Witch.ts","assets/entity/witch.png","assets/entity/witch-curse.png","assets/entity/witch-summon.png","scene/LevelScene.ts","assets/hud/health.png","render/Renderer.ts","assets/background/help.png","scene/AboutScene.ts","scene/HelpScene.ts","scene/LoadingScene.ts","scene/StartScene.ts","assets/background/start.png","GameManager.ts","App.tsx","editor/ItemEditor.tsx","editor/parseImage.ts","editor/TerrainCanvas.tsx","editor/MapEditor.tsx","reportWebVitals.ts","index.tsx"],"names":["normalizeKey","key","test","toUpperCase","COMMAND_MAP","COMMANDS","Object","keys","USED_KEYS","Set","map","command","flat","KEY_MAP","Map","filter","includes","KeyboardManager","constructor","gameManager","pressedKeys","this","keydownHandler","bind","keyupHandler","window","addEventListener","cleanup","removeEventListener","evt","commands","get","preventDefault","add","onKeyEvent","repeat","delete","isKeyPressed","some","has","levelManager","levels","addLevel","set","id","addLevels","maps","name","levelTest0","levelTest","level1","level2","Side","Direction","Facing","Axis","Coord","x","y","clone","coord","plus","vector","plus2","minus","diff","base","Vector","setPlus","setMinus","expand","left","top","right","bottom","AABB","inside","rect","round","Math","Segment","l","r","intersects","other","contains","value","reset","length","sqrt","setPlus2","scale","k","setScale","sort2","a","b","center","width","height","horizontal","vertical","offset","offset2","grow","flipX","SCENE_WIDTH","SCENE_HEIGHT","Scene","keyHandlers","globalKeyHandlers","listenKey","handler","handlers","push","listenAllKeys","removeGlobalListener","fn","event","tick","debugText","textureManager","tasks","textures","loadTexture","path","promise","Promise","resolve","reject","img","Image","src","onload","texture","Texture","onerror","Error","message","loadTextures","items","all","untilAllLoaded","then","textureName","clipName","split","getClip","clips","naturalWidth","naturalHeight","clip","clipArea","TextureClip","defineClip","defineClips","names","offsetX","offsetY","forEach","row","drawTo","rctx","flipped","run","ctx","translate","drawImage","origin","Sprite","position","visible","render","info","getRenderInfo","box","Number","isInteger","Model","data","super","tags","EscapeBehaviour","Entity","type","velocity","oldPosition","oldCollisionBox","facing","onGround","airTicks","impulseX","impulseY","impulseTicks","isMob","isPlayer","isProjectile","isItem","coordByFacing","coordByFacing2","boxByFacing","collisionBox","collisionBoxR","getRenderInfoR","underGravity","accelerate","accel","maxSpeed","v","min","max","applyFriction","friction","setImpulse","ticks","knockback","source","speed","deltaY","random","scene","move","interactTerrains","collideTerrains","boundary","triggerCrossBorder","side","fullOut","onCrossBorder","block","deleteEntity","none","axis","fitTerrain","terrain","terrains","collideEntity","interactEntity","onCollideTerrain","debug","pixelSize","cbox","lineWidth","strokeStyle","strokeRect","MapTerrainType","MapEntityType","MapItemType","MapTriggerType","GeneratorAnimation","generator","first","next","done","current","result","FrameSequence","frames","frameCount","index","loop","clipNames","ranges","fromClips","flatMap","count","Array","fill","setLoop","flag","textureMeleeWave","textureDiveAttack","textureDiveSideAttack","textureDamageBurst","textureWitchTeleport","Particle","animation","renderBoxR","destroy","deleteParticle","MeleeWave","DiveAttackWave","DiveSideAttackWave","DamageBurst","WitchTeleport","fromClipRanges","Mob","init","maxHealth","health","invincible","immuneTicks","isEnemy","player","hurtBox","hurtBoxR","dead","hurtImmuneTicks","damage","amount","evenIfInvincible","onDamage","die","addParticle","cure","Infinity","textureBrick","textureSpikes","textureWater","Terrain","cell","brick","TerrainBrick","variant","spikes","TerrainSpikes","fragile","TerrainFragile","water","TerrainWater","surface","console","warn","boundingBox","canCollideWith","entity","setTexture","selfBox","vel","pos","oldBox","newBox","onCollideEntity","TEXTURE_MAP","wood","dirt","grass","tree","HarmingTerrain","onHurtEntity","hbox","witch","FragileTerrain","collapseTicks","collapsingTicks","collapsed","collapse","mapWidth","onCollapsed","deleteTerrain","collapseOffset","recoveringTicks","recoverTicks","terrainBox","getEntitiesInArea","floor","globalAlpha","STRINGS","Subtitle","opacity","show","content","animate","i","font","fillStyle","textAlign","textBaseline","shadowColor","shadowBlur","fillText","text","texturePlayer","State","Player","state","walk","meleeDamage","meleeSpeed","jumpPressedAt","jumpReleasedAt","meleePressedAt","jumpedAt","meleeCooldown","outOfControlTicks","createAnimation","normal","meleeBoxHorizontal","diveBoxCenter","diveBoxLeft","diveBoxRight","getMovement","receiveInput","shortPause","attack","attackReversed","movement","acceleration","ticksAfterJumped","meleeAttack","canAttack","target","arrow","hit","dir","targets","was","onPlayerRespawn","playerFallenIntoWater","showSubtitle","respawn","spawnPoint","gameOver","ORIGIN_BOX","FOCUS_ANCHOR_R","MIN_SPEED","CameraState","Camera","stateX","still","stateY","snappedY","update","viewBox","rumble","playerPos","playerPosOld","playerOffset","playerOffsetOld","delta","signFacing","signDelta","sign","signAccel","abs","accelerating","decelerating","callback","beginPath","moveTo","lineTo","stroke","PlatformWalkGoal","self","canPassThrough","canStandOn","findFoothold","startY","ceil","mapHeight","slice","find","checkEmptyArea","boxHeight","checkFoothold","isConnected","coord1","coord2","x1","x2","ground","aboveGround","keepDistance","minDistance","maxDistance","deltaX","foothold","footholdTarget","heading","distance","blockX","StateMachine","states","interrupted","interrupt","textureFlower","textureRuby","textureScout","textureSkeletonScout","EntityItem","item","flower","ItemFlower","ruby","ItemRuby","onPickup","double","p1","p2","seed","addEntity","skeletonDroppedFlower","Variant","EnemyScout","stabbingTicks","attackCooldown","attackSpeed","attackDamage","platformWalkGoal","skeleton","idle","stabbing","stabbed","attackBox","playerInTouch","trySpawnAt","textureGuard","EnemyGuard","SelectMenu","selectedIndex","validateItems","findFirstItem","keyHandler","disabled","selectedItem","getItems","setItems","start","includeFirst","isFirst","textureTree","VARIANTS","Decoration","variantMeta","renderBox","lines","Projectile","owner","entities","onHitMob","textureArrow","textureArcher","textureSkeletonArcher","Arrow","power","stoppedTicks","canHarmMob","mob","EnemyArcher","chargeTicks","chargeSpeed","drawing","shot","shootPos","playerBox","playerInReach","canShoot","Background","picture","getPosition","params","cameraOffset","factor","textureSize","end","cameraSize","marginL","marginR","sceneSize","camera","textureWidth","textureHeight","positionX","positionY","Landmark","SpawnPoint","effectBox","FocusCircle","radiusGenerator","generateRadius","radius","OpeningFocusCircle","step","DespawningFocusCircle","RespawningFocusCirle","Trigger","triggered","condition","reachPlace","TriggerReachPlace","landmarkTag","entityKilled","TriggerEntityKilled","entityTag","checkCondition","execute","log","getLandmark","levelComplete","getLandmarksWithTag","landmark","getEntitiesWithTag","textureWitch","textureWitchCurse","textureWitchSummon","CURSE_PREPARE_TICKS","EnemyWitch","cursing","summoning","curseTicks","summonTicks","cooldownTicks","damageCount","curseTarget","teleport","abort","cursePeriodTicks","types","scout","archer","splice","summon","choices","newPos","onTickEnd","createEntity","skeletonSummoned","pow","total","solid","cos","PI","setLineDash","lineDashOffset","sin","arc","onBossDie","textureHealth","LevelScene","decorations","backgrounds","landmarks","spawnPoints","triggers","particles","tickEndHandlers","subtitle","focusCircle","despawning","won","totalTicks","pauseTicks","tickTime","paused","pauseMenu","gameOverMenu","gameCompletedMenu","args","togglePause","create","animateOpening","guard","tag","e","particle","p","setBoundary","action","retry","restart","backToTitle","startTime","performance","now","trigger","endTime","animateRespawn","animateLevelComplete","boss","animateBossDie","j","onLevelComplete","animateGameOver","gameComplete","startGame","fillRect","background","renderTerrain","decoration","renderHud","renderMenu","heartCount","menu","title","toFixed","RendererContext","save","restore","Renderer","canvas","memCanvas","memCtx","canvasWidth","canvasHeight","timer","debugMode","getContext","document","createElement","adjustSize","renderHandler","stop","requestAnimationFrame","cancelAnimationFrame","pixelRatio","devicePixelRatio","logicWidth","body","clientWidth","logicHeight","clientHeight","deviceWidth","deviceHeight","imageSmoothingEnabled","style","setScene","clearRect","padStart","join","maxWidth","measureText","textY","setDebug","toggleDebug","textureBg","bg","AboutScene","HelpScene","renderLines","line","renderLine","LoadingScene","StartScene","buttonHandler","button","showHelp","showAbout","header","GameManager","renderer","keyboardManager","tickHandler","resizeHandler","switchScene","getCanvas","getScene","prompt","startLevel","setInterval","clearInterval","level","App","React","PureComponent","refCanvas","createRef","componentDidMount","componentWillUnmount","className","ref","display","autoPlay","EditError","ItemEditor","Component","props","error","modifyHandler","field","onModify","setState","err","onInput","currentTarget","fontSize","COLORS","PATTERNS","pixels","more","s","parseInt","parseImage","imgWidth","imgHeight","imgData","getImageData","pixelAt","mapDecorations","mapTerrain","_","A","B","C","D","toString","TerrainCanvas","pxGrid","ratio","imageRendering","ENTITY_TEMPLATES","ENTITY_TYPES","TOOLS","category","MapEditor","currentItemId","refFileInput","refContainer","loaded","mapCounter","mapId","backgroundDrafts","triggerDrafts","pxAtom","selectedItems","itemDraft","currentTool","sidebarDock","dragCorner","dragCorner2","mouseCoord","debugRender","importHandler","exportHandler","fileHandler","mouseHandler","itemMouseHandler","itemModifyHandler","click","input","files","file","endsWith","url","URL","createObjectURL","indexOf","loadMap","alert","revokeObjectURL","reader","FileReader","JSON","parse","readAsText","createItem","keepItems","makeBackgroundDraft","makeTriggerDraft","exportMap","blob","Blob","stringify","href","download","appendChild","removeChild","toggleSidebarDock","editMapId","str","getBoundingClientRect","clientX","clientY","sceneX","sceneY","selectItems","placeItem","corner","corner2","cornered","getItemsInRect","sprite","HTMLInputElement","HTMLTextAreaElement","dx","dy","L","R","U","makeItemDraft","switchTool","ctrlKey","getItemToPlace","tool","stopPropagation","entry","parsed","size","isNaN","assign","backgroundsEditHandler","backgroundAddHandler","backgroundRemoveHandler","triggersEditHandler","triggerAddHandler","triggerRemoveHandler","toggleDebugRender","Toolbar","parent","Sidebar","Container","refMain","onClick","classList","toggledSide","dragCoord","draft","PX","dragArea","onMouseDown","onMouseUp","onMouseMove","onContextMenu","mapItem","reportWebVitals","onPerfEntry","Function","getCLS","getFID","getFCP","getLCP","getTTFB","location","searchParams","ReactDOM","StrictMode","getElementById"],"mappings":"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","file":"static/js/main.f28fb8d7.chunk.js","sourcesContent":["import GameManager from \"../GameManager\";\n\nfunction normalizeKey({ key }: KeyboardEvent) {\n  return /^[A-Za-z]$/.test(key) ? key.toUpperCase() : key;\n}\n\nconst COMMAND_MAP: Record<string, string[]> = {\n  \"ui.confirm\":  [\"C\", \"Enter\"],\n  \"ui.cancel\":   [\"X\"],\n  \"ui.pause\":    [\"Escape\"],\n  \"move.up\":     [\"W\", \"ArrowUp\"],\n  \"move.left\":   [\"A\", \"ArrowLeft\"],\n  \"move.down\":   [\"S\", \"ArrowDown\"],\n  \"move.right\":  [\"D\", \"ArrowRight\"],\n  \"move.jump\":   [\"W\", \" \"],\n  \"skill.melee\": [\"J\"],\n  \"skill.dash\":  [\"K\"],\n  \"debug.toggle\": [\"F3\"],\n  \"debug.level\":  [\"F4\"]\n};\n\nconst COMMANDS = Object.keys(COMMAND_MAP);\nconst USED_KEYS = [...new Set(\n  COMMANDS.map((command) => COMMAND_MAP[command]).flat()\n)];\nconst KEY_MAP = new Map(USED_KEYS.map(\n  key => [key, COMMANDS.filter(command => COMMAND_MAP[command].includes(key))]\n));\n\nexport default class KeyboardManager {\n  private pressedKeys: Set<string> = new Set();\n\n  constructor(private gameManager: GameManager) {\n    this.keydownHandler = this.keydownHandler.bind(this);\n    this.keyupHandler = this.keyupHandler.bind(this);\n\n    window.addEventListener(\"keydown\", this.keydownHandler, false);\n    window.addEventListener(\"keyup\", this.keyupHandler, false);\n  }\n\n  cleanup() {\n    window.removeEventListener(\"keydown\", this.keydownHandler, false);\n    window.removeEventListener(\"keyup\", this.keyupHandler, false);\n  }\n\n  private keydownHandler(evt: KeyboardEvent) {\n    const key = normalizeKey(evt);\n    const commands = KEY_MAP.get(key);\n    if (!commands) return;\n    evt.preventDefault();\n    this.pressedKeys.add(key);\n    for (const command of commands)\n      this.gameManager.onKeyEvent(command, evt.repeat ? \"repeat\" : \"down\");\n  }\n\n  private keyupHandler(evt: KeyboardEvent) {\n    const key = normalizeKey(evt);\n    const commands = KEY_MAP.get(key);\n    if (!commands) return;\n    evt.preventDefault();\n    this.pressedKeys.delete(key);\n    for (const command of commands)\n      this.gameManager.onKeyEvent(command, \"up\");\n  }\n\n  isKeyPressed(command: string) {\n    return command in COMMAND_MAP && COMMAND_MAP[command].some(key => this.pressedKeys.has(key));\n  }\n}","import { MapData } from \"./interfaces\";\nimport levelTest0 from \"../assets/levels/test0.json\";\nimport levelTest from \"../assets/levels/test.json\";\nimport level1 from \"../assets/levels/level1.json\";\nimport level2 from \"../assets/levels/level2.json\";\n\n\nclass LevelManager {\n  levels = new Map<string, MapData>();\n\n  addLevel(map: MapData) {\n    this.levels.set(map.id, map);\n    return this;\n  }\n\n  addLevels(maps: MapData[]) {\n    for (const map of maps) this.addLevel(map);\n  }\n\n  get(name: string) {\n    return this.levels.get(name);\n  }\n}\n\nconst levelManager = new LevelManager();\n\nlevelManager.addLevels([\n  levelTest0,\n  levelTest,\n  level1,\n  level2,\n] as any);\n\nexport default levelManager;\n","\nexport enum Side {\n  left = 0,\n  top = 1,\n  right = 2,\n  bottom = 3,\n};\n\nexport enum Direction {\n  left = 0,\n  up = 1,\n  right = 2,\n  down = 3\n};\n\nexport enum Facing {\n  left = 0,\n  right = 1\n}\n\nexport enum Axis {\n  x = 0, y = 1\n}\n\nexport const SIDE_MASK = {\n  left: 1,\n  top: 2,\n  right: 4,\n  bottom: 8\n};\n\nexport class Coord {\n  constructor(public x: number, public y: number) {}\n\n  clone() { return new Coord(this.x, this.y); }\n\n  /** operator = */\n  set(coord: Coord) {\n    this.x = coord.x;\n    this.y = coord.y;\n  }\n\n  /** operator + */\n  plus(vector: Vector) {\n    return new Coord(this.x + vector.x, this.y + vector.y);\n  }\n\n  /** operator + */\n  plus2(x: number, y: number) {\n    return new Coord(this.x + x, this.y + y);\n  }\n\n  /** operator - */\n  minus(vector: Vector) {\n    return new Coord(this.x - vector.x, this.y - vector.y);\n  }\n\n  /** operator - */\n  diff(base: Coord) {\n    return new Vector(this.x - base.x, this.y - base.y);\n  }\n\n  /** operator += */\n  setPlus(vector: Vector) {\n    this.x += vector.x;\n    this.y += vector.y;\n  }\n\n  /** operator -= */\n  setMinus(vector: Vector) {\n    this.x -= vector.x;\n    this.y -= vector.y;\n  }\n\n  expand(left: number, top: number, right: number = left, bottom: number = top) {\n    return new AABB(\n      this.x - left, this.y - top,\n      this.x + right, this.y + bottom\n    );\n  }\n\n  inside(rect: AABB) {\n    return this.x >= rect.left && this.x <= rect.right &&\n      this.y >= rect.top && this.y <= rect.bottom;\n  }\n\n  round() {\n    return new Coord(Math.round(this.x), Math.round(this.y));\n  }\n}\n\nexport class Dimension {\n  constructor(public width: number, public height: number) {}\n}\n\nexport class Segment {\n  constructor(public l: number, public r: number) {}\n\n  intersects(other: Segment) {\n    return this.l < other.r && other.l < this.r;\n  }\n\n  contains(value: number) {\n    return value >= this.l && value <= this.r;\n  }\n}\n\nexport class Vector {\n  constructor(public x: number, public y: number) {}\n\n  static fromCoord(coord: Coord) {\n    return new Vector(coord.x, coord.y);\n  }\n\n  /** operator = */\n  set(vector: Vector) {\n    this.x = vector.x;\n    this.y = vector.y;\n  }\n\n  reset() {\n    this.x = this.y = 0;\n  }\n\n  clone() { return new Vector(this.x, this.y); }\n\n  get length() { return Math.sqrt(this.x ** 2 + this.y ** 2); }\n\n  /** operator += */\n  setPlus(vector: Vector) {\n    this.x += vector.x;\n    this.y += vector.y;\n  }\n  /** operator += */\n  setPlus2(x: number, y: number) {\n    this.x += x;\n    this.y += y;\n  }\n\n  /** operator * */\n  scale(k: number) {\n    return new Vector(this.x * k, this.y * k);\n  }\n  /** operator *= */\n  setScale(k: number) {\n    this.x *= k;\n    this.y *= k;\n  }\n\n  round() {\n    return new Vector(Math.round(this.x), Math.round(this.y));\n  }\n}\n\nexport const DIRECTION_VECTORS = [\n  new Vector(-1, 0),\n  new Vector(0, -1),\n  new Vector(1, 0),\n  new Vector(0, 1)\n];\n\nfunction sort2(a: number, b: number): [number, number] {\n  return a < b ? [a, b] : [b, a];\n}\n\nexport class AABB {\n  constructor(public left: number, public top: number, public right: number, public bottom: number) {}\n\n  static centered(center: Coord, width: number, height: number) {\n    return center.expand(width / 2, height / 2)\n  }\n\n  static offset(left: number, top: number, width: number, height: number) {\n    return new AABB(left, top, left + width, top + height);\n  }\n\n  static origin(width: number, height: number) {\n    return new AABB(0, 0, width, height);\n  }\n\n  static cornered(a: Coord, b: Coord) {\n    const [left, right] = sort2(a.x, b.x);\n    const [top, bottom] = sort2(a.y, b.y);\n    return new AABB(left, top, right, bottom);\n  }\n\n  get width() { return this.right - this.left; }\n  get height() { return this.bottom - this.top; }\n\n  get horizontal() { return new Segment(this.left, this.right); }\n  get vertical() { return new Segment(this.top, this.bottom); }\n\n  get center() { return new Coord((this.left + this.right) / 2, (this.top + this.bottom) / 2); }\n\n  clone() {\n    return new AABB(this.left, this.top, this.right, this.bottom);\n  }\n\n  inside(other: AABB) {\n    return this.left >= other.left && this.top >= other.top &&\n      this.right <= other.right && this.bottom <= other.bottom;\n  }\n\n  offset(offset: Coord | Vector) {\n    return this.offset2(offset.x, offset.y);\n  }\n\n  offset2(x: number, y: number) {\n    return new AABB(this.left + x, this.top + y, this.right + x, this.bottom + y);\n  }\n\n  intersects(other: AABB) {\n    return (this.left < other.right && other.left < this.right &&\n      this.top < other.bottom && other.top < this.bottom);\n  }\n\n  grow(x: number, y: number = x) {\n    return new AABB(\n      this.left - x, this.top - y,\n      this.right + x, this.bottom + y\n    );\n  }\n\n  flipX(x: number) {\n    return new AABB(\n      2 * x - this.right, this.top,\n      2 * x - this.left, this.bottom\n    );\n  }\n}\n","import GameManager from \"../GameManager\";\nimport { Drawable, RendererContext } from \"../render/Renderer\";\n\nexport const SCENE_WIDTH = 320;\nexport const SCENE_HEIGHT = 180;\n\ntype KeyHandler = (event: string) => void;\ntype KeyGlobalHandler = (command: string, event: string) => void;\n\nexport default abstract class Scene implements Drawable {\n  keyHandlers: Map<string, KeyHandler[]> = new Map();\n  globalKeyHandlers: KeyGlobalHandler[] = [];\n\n  constructor(protected gameManager: GameManager) {}\n\n  cleanup() {}\n\n  listenKey(command: string, handler: KeyHandler) {\n    let handlers = this.keyHandlers.get(command);\n    if (!handlers) {\n      handlers = [];\n      this.keyHandlers.set(command, handlers);\n    }\n    handlers.push(handler);\n  }\n\n  listenAllKeys(handler: KeyGlobalHandler) {\n    this.globalKeyHandlers.push(handler);\n  }\n\n  removeGlobalListener(handler: KeyGlobalHandler) {\n    this.globalKeyHandlers = this.globalKeyHandlers.filter(fn => fn !== handler);\n  }\n\n  onKeyEvent(command: string, event: string) {\n    for (const handler of this.globalKeyHandlers)\n      handler(command, event);\n    for (const handler of this.keyHandlers.get(command) ?? [])\n      handler(event);\n  }\n\n  isKeyPressed(command: string) {\n    return this.gameManager.isKeyPressed(command);\n  }\n\n  tick() {}\n\n  abstract render(rctx: RendererContext): void;\n\n  get debugText(): string[] { return []; }\n}","import { AABB } from \"../base/math\";\nimport { RendererContext } from \"./Renderer\";\n\nexport type TextureLike = Texture | TextureClip;\n\nclass TextureManager {\n  private tasks: Promise<Texture>[] = [];\n  private textures = new Map<string, Texture>();\n\n  loadTexture(name: string, path: string): Promise<Texture> {\n    const promise = new Promise<Texture>((resolve, reject) => {\n      const img = new Image();\n      img.src = path;\n      img.onload = () => {\n        const texture = new Texture(img, name);\n        this.textures.set(name, texture);\n        resolve(texture);\n      };\n      img.onerror = ((evt: ErrorEvent) => reject(new Error(evt.message))) as any;\n    });\n    this.tasks.push(promise);\n    return promise;\n  }\n\n  loadTextures(items: [name: string, path: string][]): Promise<Texture[]> {\n    return Promise.all(items.map(([name, path]) => this.loadTexture(name, path)));\n  }\n\n  untilAllLoaded(): Promise<void> {\n    return Promise.all(this.tasks).then(() => {});\n  }\n\n  get(name: string): TextureLike {\n    const [textureName, clipName] = name.split(':');\n    const texture = this.textures.get(textureName);\n    if (!texture)\n      throw new Error(`texture not found: \"${name}\"`);\n    return clipName ? texture.getClip(clipName) : texture;\n  }\n}\n\nexport const textureManager = new TextureManager();\n\nexport class Texture {\n  clips = new Map<string, TextureClip>();\n\n  constructor(public img: HTMLImageElement, public name: string) {}\n\n  get width() { return this.img.naturalWidth; }\n  get height() { return this.img.naturalHeight; }\n\n  clip(clipArea: AABB) {\n    return new TextureClip(this.img, clipArea);\n  }\n\n  defineClip(name: string, left: number, top: number, width: number, height: number) {\n    this.clips.set(name, this.clip(AABB.offset(left, top, width, height)));\n    return this;\n  }\n\n  defineClips(names: (string | null)[][], width: number, height: number, offsetX: number = 0, offsetY: number = 0) {\n    names.forEach((row, y) => row.forEach((name, x) => {\n      if (name !== null) {\n        this.defineClip(name, offsetX + width * x, offsetY + height * y, width, height);\n      }\n    }));\n  }\n\n  getClip(name: string): TextureClip {\n    const clip = this.clips.get(name);\n    if (!clip)\n      throw new Error(`texture clip not found: \"${name}:${clip}\"`);\n    return clip;\n  }\n\n  drawTo(rctx: RendererContext, x: number, y: number, flipped = false) {\n    rctx.run(({ ctx }) => {\n      ctx.translate(x, y);\n      if (flipped) ctx.scale(-1, 1);\n      ctx.drawImage(this.img, 0, 0);\n    });\n  }\n}\n\nexport class TextureClip {\n  constructor(public img: HTMLImageElement, public clipArea: AABB) {\n    if (!clipArea.inside(AABB.origin(img.width, img.height)))\n      throw new Error(\"clipArea should be inside image box\");\n  }\n\n  get width() { return this.clipArea.width; }\n  get height() { return this.clipArea.height; }\n\n  drawTo(rctx: RendererContext, x: number, y: number, flipped = false) {\n    rctx.run(({ ctx }) => {\n      const { left, top, width, height } = this.clipArea;\n      ctx.translate(x, y);\n      if (flipped) ctx.scale(-1, 1);\n      ctx.drawImage(\n        this.img,\n        left, top, width, height,\n        0, 0, width, height\n      );\n    });\n  }\n}\n","import { AABB, Coord } from \"../base/math\";\nimport { Drawable, RendererContext } from \"../render/Renderer\";\nimport { TextureLike } from \"../render/TextureManager\";\n\nexport interface RenderInfo {\n  /** The bounding box of texture relative to the position */\n  box: AABB;\n  /** Whether texture and box should be flipped horizontally */\n  flipped?: boolean;\n  /** The Texture or TextureClip to render */\n  texture: TextureLike;\n}\n\n/**\n * Sprite:\n * - elements in scene\n * - rendered with rectangular texture\n */\nexport default abstract class Sprite implements Drawable {\n  visible: boolean = true;\n\n  constructor(public position: Coord) {}\n\n  get x() { return this.position.x; }\n  get y() { return this.position.y; }\n  set x(value: number) { this.position.x = value; }\n  set y(value: number) { this.position.y = value; }\n\n  /**\n   * Returns necessary information for rendering.\n   * \n   * Derived classes should implement this method.\n   * \n   * Note that `box` field accepts integer coordinates only,\n   * and that it should contain absolute coordinates.\n   */\n  abstract getRenderInfo(): RenderInfo | null;\n\n  render(rctx: RendererContext) {\n    if (this.visible) {\n      const info = this.getRenderInfo();\n      if (info) {\n        const { box, flipped = false, texture } = info;\n        if (!Number.isInteger(box.left) || !Number.isInteger(box.top))\n          throw new Error(`render area should have integer coordinates: got (${box.left},${box.top})`);\n        if (box.width !== texture.width || box.height !== texture.height)\n          throw new Error(`texture size does not match: expected ${box.width}x${box.height}, actual ${texture.width}x${texture.height}`);\n        texture.drawTo(rctx, flipped ? box.right : box.left, box.top, flipped);\n      }\n    }\n  }\n}","import { Coord } from \"../base/math\";\nimport { MapSprite } from \"../map/interfaces\";\nimport Sprite from \"./Sprite\";\n\n/**\n * Sprite models in map.\n */\nexport default abstract class Model extends Sprite {\n  tags: string[];\n\n  constructor(data: MapSprite) {\n    super(new Coord(data.x, data.y));\n    this.tags = data.tags;\n  }\n}","import { AABB, Axis, Coord, Facing, Side, Vector } from \"../base/math\";\nimport { MapEntity, MapEntityType } from \"../map/interfaces\";\nimport { RendererContext } from \"../render/Renderer\";\nimport { TextureLike } from \"../render/TextureManager\";\nimport LevelScene from \"../scene/LevelScene\";\nimport EntityItem from \"./Item\";\nimport Mob from \"./Mob\";\nimport Model from \"./Model\";\nimport Player from \"./Player\";\nimport Projectile from \"./projectile\";\nimport { Terrain } from \"./Terrain\";\n\nexport const GRAVITY = 0.2;\n\nexport interface RenderInfoR {\n  box: AABB;\n  texture: TextureLike;\n}\n\n/**\n * The behaviour entity will follow when escaping the world border.\n */\nexport enum EscapeBehaviour {\n  /** do nothing */ none,\n  /** blocked by the border */ block,\n  /** deleted if completely out of scene */ delete\n}\n\n/**\n * Entity:\n * - moveable\n * - interacts with terrain\n * - has facing (left or right).\n *\n * Note that all methods with names ended with 'R' should:\n * - Assume that the entity is facing right, and\n * - Return coordinates relative to `this.position`.\n */\nexport default abstract class Entity extends Model {\n  type: MapEntityType;\n\n  velocity: Vector;\n  oldPosition: Coord;\n  oldCollisionBox!: AABB;\n\n  /** The facing of the entity. */\n  facing = Facing.right;\n\n  /** whether the entity is standing on solid ground */\n  onGround: boolean;\n  /** ticks in air, used for jumping check */\n  airTicks = 0;\n\n  /** impulse applied to the entity, will override velocity in a few ticks */\n  impulseX: number | null = null;\n  impulseY: number | null = null;\n  /** ticks left when the impulse will apply */\n  impulseTicks: number = 0;\n\n  constructor(data: MapEntity) {\n    super(data);\n\n    this.type = data.type;\n\n    this.velocity = new Vector(0, 0);\n    this.onGround = true;\n\n    this.oldPosition = this.position;\n  }\n\n  /* ======== Basic ======== */\n\n  isMob(): this is Mob { return false; }\n  isPlayer(): this is Player { return false; }\n  isProjectile(): this is Projectile { return false; }\n  isItem(): this is EntityItem { return false; }\n\n  /**\n   * Flip coordinates if facing left.\n   *\n   * Note that `vector` should be relative to `this.position`,\n   * and the coordinates returned will be absolute.\n   */\n  coordByFacing(vector: Vector) {\n    return this.position.plus2(this.facing === Facing.right ? vector.x : -vector.x, vector.y);\n  }\n  coordByFacing2(x: number, y: number) {\n    return this.position.plus2(this.facing === Facing.right ? x : -x, y);\n  }\n\n  /**\n   * Flip box if facing left.\n   *\n   * Note that `box` should be relative to `this.position`,\n   * and the box returned will contain absolute coordinates.\n   */\n  boxByFacing(box: AABB) {\n    return (this.facing === Facing.right ? box : box.flipX(0)).offset(this.position);\n  }\n\n  get collisionBox() {\n    return this.boxByFacing(this.collisionBoxR);\n  }\n  /**\n   * Returns collision box of entity, assuming it is facing right.\n   */\n  abstract get collisionBoxR(): AABB;\n\n  getRenderInfo() {\n    const info = this.getRenderInfoR();\n    if (!info) return null;\n    const flipped = this.facing === Facing.left;\n    return {\n      box: (flipped ? info.box.flipX(0) : info.box).offset(this.position.round()),\n      flipped,\n      texture: info.texture\n    };\n  }\n  /**\n   * Returns information used for rendering, assuming entity is facing right.\n   * Note that `box` should be **relative to** `this.position`.\n   */\n  abstract getRenderInfoR(): RenderInfoR | null;\n\n  /* ======== Movement ======== */\n\n  /**\n   * Whether movement of this entity should be affected by gravity.\n   */\n  get underGravity() { return true; }\n\n  accelerate(facing: Facing, accel: number, maxSpeed: number) {\n    const v = this.velocity;\n    if (facing === Facing.right && v.x < maxSpeed)\n      v.x = Math.min(maxSpeed, v.x + accel);\n    if (facing === Facing.left && v.x > -maxSpeed)\n      v.x = Math.max(-maxSpeed, v.x - accel);\n  }\n\n  applyFriction(friction: number) {\n    const v = this.velocity;\n    if (v.x > 0)\n      v.x = Math.max(0, v.x - friction);\n    if (v.x < 0)\n      v.x = Math.min(0, v.x + friction);\n  }\n\n  setImpulse(impulseX: number | null, impulseY: number | null, ticks: number) {\n    this.impulseX = impulseX;\n    this.impulseY = impulseY;\n    this.impulseTicks = ticks;\n  }\n\n  knockback(source: Coord, facing: Facing, speed: number, ticks: number = 4) {\n    let deltaY = this.collisionBox.bottom - source.y;\n    let impulseY = deltaY <= 1 ? -0.5 : deltaY >= 3 ? 0.5 : 0;\n    impulseY += Math.random() * 0.2 - 0.1;\n    let impulseX = (facing === Facing.right ? 1 : -1) * Math.sqrt(1 - impulseY ** 2);\n\n    speed = speed * (0.8 + Math.random() * 0.4);\n    this.setImpulse(speed * impulseX, speed * impulseY, ticks);\n  }\n\n  /* ======== Logic ======== */\n\n  /**\n   * Performs movement and terrain interaction logic.\n   */\n  tick(scene: LevelScene) {\n    this.move(scene);\n    this.interactTerrains(scene);\n\n    if (this.onGround) {\n      this.airTicks = 0;\n    } else {\n      this.airTicks++;\n      if (this.underGravity)\n        this.velocity.y += GRAVITY;\n    }\n  }\n\n  /**\n   * Move the entity and do the collision check.\n   */\n  move(scene: LevelScene) {\n    this.onGround = false;\n\n    // Impulse\n    if (this.impulseTicks > 0) {\n      if (this.impulseX !== null)\n        this.velocity.x = this.impulseX;\n      if (this.impulseY !== null)\n        this.velocity.y = this.impulseY;\n      this.impulseTicks--;\n    } else {\n      this.impulseX = this.impulseY = null;\n    }\n\n    // Terrain\n    this.oldPosition = this.position.clone();\n\n    this.oldCollisionBox = this.collisionBox;\n    this.position.x += this.velocity.x;\n    this.collideTerrains(scene, Axis.x);\n\n    this.oldCollisionBox = this.collisionBox;\n    this.position.y += this.velocity.y;\n    this.collideTerrains(scene, Axis.y);\n\n    // Map border\n    const { collisionBox } = this;\n    const { boundary } = scene;\n\n    if (collisionBox.left < boundary.left)\n      this.triggerCrossBorder(scene, Side.left,\n        collisionBox.left - boundary.left, collisionBox.right <= boundary.left);\n\n    if (collisionBox.right > boundary.right)\n      this.triggerCrossBorder(scene, Side.right,\n        collisionBox.right - boundary.right, collisionBox.left >= boundary.right);\n\n    if (collisionBox.top < boundary.top)\n      this.triggerCrossBorder(scene, Side.top,\n        collisionBox.top - boundary.top, collisionBox.bottom <= boundary.top);\n\n    if (collisionBox.bottom > boundary.bottom)\n      this.triggerCrossBorder(scene, Side.bottom,\n        collisionBox.bottom - boundary.bottom, collisionBox.top >= boundary.bottom);\n  }\n\n  private triggerCrossBorder(scene: LevelScene, side: Side, offset: number, fullOut: boolean) {\n    switch (this.onCrossBorder(scene, side, fullOut)) {\n      case EscapeBehaviour.block:\n        if (side === Side.left || side === Side.right)\n          this.position.x -= offset;\n        else\n          this.position.y -= offset;\n        break;\n\n      case EscapeBehaviour.delete:\n        if (fullOut)\n          scene.deleteEntity(this);\n        break;\n    }\n  }\n\n  /**\n   * Called when the entity crosses the border of the world.\n   * @param fullOut Whether the entity has completely moved out of the world\n   */\n  onCrossBorder(scene: LevelScene, side: Side, fullOut: boolean): EscapeBehaviour {\n    return EscapeBehaviour.none;\n  }\n\n  collideTerrains(scene: LevelScene, axis: Axis) {\n    const box = scene.fitTerrain(this.collisionBox.grow(1));\n\n    for (let y = box.top; y < box.bottom; y++) {\n      for (let x = box.left; x < box.right; x++) {\n        const terrain = scene.terrains[y][x];\n        terrain?.collideEntity(scene, this, axis);\n      }\n    }\n  }\n\n  /**\n   * Interacts with terrain.\n   */\n  interactTerrains(scene: LevelScene) {\n    const box = scene.fitTerrain(this.collisionBox.grow(1));\n\n    for (let y = box.top; y < box.bottom; y++) {\n      for (let x = box.left; x < box.right; x++) {\n        const terrain = scene.terrains[y][x];\n        terrain?.interactEntity(scene, this);\n      }\n    }\n  }\n\n  onCollideTerrain(scene: LevelScene, terrain: Terrain, side: Side) {}\n\n  render(rctx: RendererContext) {\n    super.render(rctx);\n    if (rctx.debug) {\n      rctx.run(({ ctx, pixelSize }) => {\n        const { collisionBox: cbox } = this;\n        ctx.lineWidth = 2 / pixelSize;\n        ctx.strokeStyle = this.onGround ? '#0f0' : '#00f';\n        ctx.strokeRect(cbox.left, cbox.top, cbox.width, cbox.height);\n      });\n    }\n  }\n}","import { Side } from \"../base/math\";\n\n/* ======== Map ======== */\n\n/**\n * \n */\nexport interface MapSprite {\n  /**  */\n  tags: string[];\n  x: number;\n  y: number;\n}\n\n/**\n * \n */\nexport interface MapData {\n  id: string;\n  width: number;\n  height: number;\n\n  /** terrain[y][x] */\n  terrain: (MapTerrain | null)[][];\n  /**  */\n  entities: MapEntity[];\n  /**  */\n  decorations: MapDecoration[];\n  /**  */\n  triggers: MapTrigger[];\n  /**  */\n  backgrounds: MapBackground[];\n  /**  */\n  landmarks: MapLandmark[];\n  /**  */\n  spawnPoints: MapSpawnPoint[];\n}\n\n/* ======== Terrain ======== */\n\n/**  */\nexport const TERRAIN_SIZE = 8;\n\nexport enum MapTerrainType {\n  brick = \"brick\",\n  spikes = \"spikes\",\n  fragile = \"fragile\",\n  water = \"water\"\n}\n\nexport interface MapTerrain {\n  type: MapTerrainType;\n}\n\n/**  */\nexport interface MapTerrainBrick extends MapTerrain {\n  /**  */\n  variant: string;\n}\n\n/**  */\nexport interface MapTerrainSpikes extends MapTerrain {\n  /**  */\n  side: Side;\n}\n\n/**  */\nexport interface MapTerrainFragile extends MapTerrain {\n  variant: string;\n}\n\n/**  */\nexport interface MapTerrainWater extends MapTerrain {\n  /**  */\n  surface: boolean;\n}\n\n/* ======== Entity ======== */\n\nexport enum MapEntityType {\n  /** Mob */\n  player = \"player\",\n  scout = \"scout\",\n  guard = \"guard\",\n  archer = \"archer\",\n  witch = \"witch\",\n  boss = \"boss\",\n\n  /** Projectile */\n  arrow = \"arrow\",\n\n  /** Item */\n  item = \"item\"\n}\n\nexport interface MapEntity extends MapSprite {\n  type: MapEntityType;\n  [key: string]: any;\n}\n\nexport interface MapEntityScout extends MapEntity {\n  skeleton?: boolean;\n}\n\nexport interface MapEntityArcher extends MapEntity {\n  skeleton?: boolean;\n}\n\nexport interface MapEntityPlayer extends MapEntity {\n  health: number;\n  maxHealth: number;\n}\n\nexport enum MapItemType {\n  flower = \"flower\",\n  ruby = \"ruby\"\n}\n\nexport interface MapEntityItem extends MapEntity {\n  item: MapItemType;\n}\n\nexport interface MapEntityItemFlower extends MapEntityItem {\n  double: boolean;\n}\n\n/* ======== Decoration ======== */\n\nexport interface MapDecoration extends MapSprite {\n  variant: string;\n}\n\nexport interface MapDecorationSign extends MapDecoration {\n  text: string;\n}\n\n/* ======== Trigger ======== */\n\nexport interface MapTrigger {\n  id: string;\n  condition: MapTriggerCondition;\n}\n\nexport enum MapTriggerType {\n  reachPlace = \"reachPlace\",\n  entityKilled = \"entityKilled\"\n}\n\nexport type MapTriggerCondition = {\n  type: MapTriggerType.reachPlace,\n  landmarkTag: string;\n} | {\n  type: MapTriggerType.entityKilled;\n  entityTag: string;\n};\n\n/* ======== Background ======== */\n\nexport interface MapBackground {\n  picture: string;\n  opacity: number;\n  horizontal: MapBackgroundAxis;\n  vertical: MapBackgroundAxis;\n}\n\nexport type MapBackgroundAxis = {\n  repeat: true;\n  factor: number;\n  offset: number;\n} | {\n  repeat: false;\n  marginL: number;\n  marginR: number;\n}\n\n/* ======== Landmark ======== */\n\nexport interface MapLandmark extends MapSprite {\n  width: number;\n  height: number;\n}\n\n/* ======== Spawn Point ======== */\n\nexport interface MapSpawnPoint extends MapSprite {\n}","import { Texture, TextureLike, textureManager } from \"./TextureManager\";\n\ninterface AnimationBase<T> {\n  /** current animation value */\n  current(): T;\n}\n\nexport interface ForwardAnimation<T> extends AnimationBase<T> {\n  /**\n   * Returns true if the animation has ended; false otherwise.\n   */\n  next(): boolean;\n}\n\nexport interface RandomAnimation<T> extends ForwardAnimation<T> {\n  /**\n   * Set the current index of the animation.\n   */\n  set(index: number): boolean;\n}\n\nexport class GeneratorAnimation<T> implements ForwardAnimation<T> {\n  value: T;\n\n  constructor(private generator: Generator<T>) {\n    const first = generator.next();\n    if (first.done)\n      throw new Error(\"generator ended on first iteration\");\n    this.value = first.value;\n  }\n\n  current() {\n    return this.value;\n  }\n\n  next() {\n    const result = this.generator.next();\n    if (result.done) return true;\n    this.value = result.value;\n    return false;\n  }\n}\n\nexport class FrameSequence implements RandomAnimation<TextureLike> {\n  frameCount: number;\n  index = 0;\n  loop = false;\n\n  constructor(public frames: TextureLike[]) {\n    if (frames.length === 0)\n      throw new Error(\"frame sequence should contain at least one frame\");\n    this.frameCount = frames.length;\n  }\n\n  static fromClips(textureName: string, clipNames: string[]) {\n    const texture = textureManager.get(textureName) as Texture;\n    return new FrameSequence(clipNames.map(name => texture.getClip(name)));\n  }\n\n  static fromClipRanges(textureName: string, ranges: [string, number][]) {\n    return this.fromClips(textureName,\n      ranges.flatMap(([name, count]) => new Array(count).fill(name)));\n  }\n\n  setLoop(flag: boolean): this {\n    this.loop = flag;\n    return this;\n  }\n\n  current() {\n    return this.frames[this.index];\n  }\n\n  set(index: number) {\n    if (this.loop) {\n      this.index = index % this.frameCount;\n      return false;\n    } else {\n      if (index >= this.frameCount)\n        return true;\n      this.index = index;\n      return false;\n    }\n  }\n\n  next() {\n    return this.set(this.index + 1);\n  }\n}","import { AABB, Coord, Facing, Vector } from \"../base/math\";\nimport { FrameSequence } from \"../render/Animation\";\nimport { Texture, textureManager } from \"../render/TextureManager\";\nimport LevelScene from \"../scene/LevelScene\";\nimport Sprite from \"./Sprite\";\nimport imgMeleeWave from \"../assets/entity/melee-wave.png\";\nimport imgDiveAttackWave from \"../assets/entity/dive-attack-wave.png\";\nimport imgDiveSideAttackWave from \"../assets/entity/dive-side-attack-wave.png\";\nimport imgDamageBurst from \"../assets/entity/damage-burst.png\";\nimport imgWitchTeleport from \"../assets/entity/witch-teleport.png\";\n\nlet textureMeleeWave: Texture;\nlet textureDiveAttack: Texture;\nlet textureDiveSideAttack: Texture;\nlet textureDamageBurst: Texture;\nlet textureWitchTeleport: Texture;\n\ntextureManager.loadTextures([\n  [\"entity/melee-wave\", imgMeleeWave],\n  [\"entity/dive-attack-wave\", imgDiveAttackWave],\n  [\"entity/dive-side-attack-wave\", imgDiveSideAttackWave],\n  [\"entity/damage-burst\", imgDamageBurst],\n  [\"entity/witch-teleport\", imgWitchTeleport],\n]).then(textures => {\n  [textureMeleeWave, textureDiveAttack, textureDiveSideAttack, textureDamageBurst, textureWitchTeleport] = textures;\n  textureMeleeWave.defineClips([\n    [\"0\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\", \"8\", \"9\", \"10\", \"11\"]\n  ], 24, 12);\n  textureDiveAttack.defineClips([\n    [\"0\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\"]\n  ], 12, 16);\n  textureDiveSideAttack.defineClips([\n    [\"0\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\"]\n  ], 12, 16);\n  textureDamageBurst.defineClips([\n    [\"0\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\"]\n  ], 16, 12);\n  textureWitchTeleport.defineClips([\n    [\"0\", \"1\", \"2\", \"3\", \"4\"]\n  ], 20, 20);\n});\n\nexport default abstract class Particle extends Sprite {\n  velocity = new Vector(0, 0);\n  facing = Facing.right;\n  animation!: FrameSequence;\n\n  getRenderInfo() {\n    const box = this.renderBoxR;\n    if (!box) return null;\n    const flipped = this.facing === Facing.left;\n    return {\n      box: (flipped ? box.flipX(0) : box).offset(this.position.round()),\n      flipped,\n      texture: this.animation.current()\n    };\n  }\n\n  /**\n   * Returns information used for rendering, assuming particle is facing right.\n   * Note that `box` should be **relative to** `this.position`.\n   */\n  abstract get renderBoxR(): AABB | null;\n\n  tick(scene: LevelScene) {\n    if (this.animation.next())\n      this.destroy(scene);\n    this.position.setPlus(this.velocity);\n  }\n\n  destroy(scene: LevelScene) {\n    scene.deleteParticle(this);\n  }\n}\n\nexport class MeleeWave extends Particle {\n  constructor(position: Coord, facing: Facing) {\n    super(position);\n\n    this.facing = facing;\n    this.animation = FrameSequence.fromClips(\"entity/melee-wave\",\n      [\"0\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\", \"8\", \"9\", \"10\", \"11\"]);\n  }\n\n  get renderBoxR() {\n    return new AABB(2, -12, 26, 0);\n  }\n}\n\nexport class DiveAttackWave extends Particle {\n  constructor(position: Coord) {\n    super(position);\n\n    this.animation = FrameSequence.fromClips(\"entity/dive-attack-wave\",\n      [\"0\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\"]);\n  }\n\n  get renderBoxR() {\n    return new AABB(-6, 2, 6, 18);\n  }\n}\n\nexport class DiveSideAttackWave extends Particle {\n  constructor(position: Coord, facing: Facing) {\n    super(position);\n\n    this.facing = facing;\n    this.animation = FrameSequence.fromClips(\"entity/dive-side-attack-wave\",\n      [\"0\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\"]);\n  }\n\n  get renderBoxR() {\n    return new AABB(0, 2, 12, 18);\n  }\n}\n\nexport class DamageBurst extends Particle {\n  constructor(position: Coord) {\n    super(position);\n\n    this.animation = FrameSequence.fromClips(\"entity/damage-burst\",\n      [\"0\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\"]);\n  }\n\n  get renderBoxR() {\n    return new AABB(-8, -6, 8, 6);\n  }\n}\n\nexport class WitchTeleport extends Particle {\n  constructor(position: Coord) {\n    super(position);\n\n    this.animation = FrameSequence.fromClipRanges(\"entity/witch-teleport\", [\n      [\"0\", 2],\n      [\"1\", 2],\n      [\"2\", 2],\n      [\"3\", 2],\n      [\"4\", 2],\n      [\"3\", 2],\n      [\"2\", 2],\n      [\"1\", 2],\n      [\"0\", 2],\n    ]);\n  }\n\n  get renderBoxR() {\n    return new AABB(-10, -10, 10, 10);\n  }\n}\n","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASAAAAAMCAYAAADCmmB5AAAAAXNSR0IArs4c6QAAAUlJREFUaIHtmsENgzAQBE2gFOgA+i8AOoBSiMgLhMBCCnjHsrmR8kgeTO6wN7Fx4Yxb9OO8OOdc11SF2qH2HF1KH1ET2TcjIfpxXtaX2qG6/upYUdey91AuZV1E78j7Q4y3V0CFAzX4cqjl6KEmbeoBQfSMvC+vCDkqHHIYfD6XhdB9V6rjgHakvnLw8SFlxHq8a6pimL7b+7YuT/sbCpSeY00qKI+P0L0jaqEdqjHWj/PS1qV8rvhCbgsgolDKk/uEpUKVcrV1qby88Qd0yKH/gAzDMPZUvg+pX/Vh+ib9mHRNdRqyb4Qr1rLPOKO6311TFZdHV2I9Wk7VEcuTwyZ0jhvEtgkd6AsQE0npscfwYTzUpFV4fD0jHCGvv/dED4dcoA4J2kHEZy4q6FQ1UX2zcHhOsvsvsblczwZ2qD1Hl9JH1ET2zXjGD63BRMvcc/5JAAAAAElFTkSuQmCC\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAAAQCAYAAADpunr5AAAAAXNSR0IArs4c6QAAANdJREFUWIXtmN0NhCAMgPFkFN1A9x8AN8BRMNwTCamt/FzxiPZ7lCDary2iUkJfGOu8sc7/+zleibHOB0TCPXyogWUaVY6EUDEijImSgMYVI1VTh4YX1lkPrRajBLVcs3dOAmrZ9uMykMY6v0wjOYbNfYOwn18kBCknKJiEbT8UnB/uSQmjZGPCniSLhXiPoTIc7i0Y2FxsXu8fEmwtKJecjFxnPaSCwZXZsCqpdtiKx5UnFJcKZiwgtY/BNaS9MVHSfmoOq3JOYqRUgPxdaEBpRksFCALFF8D9Kx57vDfxAAAAAElFTkSuQmCC\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAAAQCAYAAADpunr5AAAAAXNSR0IArs4c6QAAAMtJREFUWIXtmN0NwyAMhJ2WUZoNmv0HIBvQUajoQ0VkWSHEJuJH8feGxBFk6w4rAEofWOeDdT60vsctsc6HiDahLo8SsbrmQrjFVNdcwyQVWufD+/Xc1uvnC8tskucdNelIt6fN7b8N0QU5B2C3UFLa6Mg9rToOcbYYnGJKGjYq1a2cixMabQD/eEvtz51/RtOSLi9WUsRUAzl6zvcUAo2vGpOdjuME/IBzNJLGlY7jhisYAUl8LLOZcAE1ggZC4jaNrEboH4QOwA74AfTRaJAlmo0QAAAAAElFTkSuQmCC\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAAAMCAYAAACqTLVoAAAAAXNSR0IArs4c6QAAARdJREFUWIXtWMsRhCAMDXtLCVwpz4K2D49uMbaSPbHDOApJCGqcfUflvYR8iALgBAsijdaR2CjXWvl2BV5nGOkN0IJIc4xAAMN08jOOjVJHwnMJi+RNKVFvgCT8ms81nSklto1SR8Lr4ZyOK5K3ta+xtSB2+zwSHnz8weLY1drVBmnbXZpuO/LbqnNv/91g4WBvpVsEW+PDlBLl069XyyXyRrUJKIvnDrNOO0qstFxCmzjL4nkK3O9JeuTtJZ+j0SqelkYr0Fcc3UfjxA0s5p5Eo5b8mganeI74kg7V8K1+YUegeREUAMIcIwSAoDUi0Xiv6+6alkZ+L+Xn5HA6lADog7h7B1Djc2PH0fpjACQB1443Ls4eU1/zbuwZCcANBgAAAABJRU5ErkJggg==\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAUCAYAAAB7wJiVAAAAAXNSR0IArs4c6QAAAk5JREFUWIXtmb9uwjAQxs8NO1sRDFTqxBh2JiRWFCHxCjwAAw/BwAPwCkgIsVZi6h7GrlQVVUceALlDdenF+M/ZRClRuSlOnF++fGf7ghFgiVl/LnXn57uZsN1354XztBdMIB/wnRfGuzjhgqXHrQAA6LaGkiOSK84m8j/xcg0KQ+MxkiiWAACHRhvS41ZgQmwideKQWxTv6es91z402hf3VYmXHagwCtqc9zkTsW0z0ZdHWb48XagvXhWecMHQPAyOibqZpiaT8jbnvUiiWJpEhuizvfQt82rYoEtUCuZA8/DBuimoCtic90IVphPM4dleNkSfypt8jjLDls21KJsnZv25pIUagSYDaeCoVmuATqCLZ5t51/C4Bj5+PAPAj2kAAGgktsviPeCBbzJUAbZrHJ5tFoXyuPpU8wAAxqepGJ+mmZnY5xoeHtt4NYDf4uyTCE6E8JIolociRTCCGvfy9mrsk0BsnLk23qq+kJP6iMV7UE/QouMKzqj24fn0LStoDQiJVX2R3T8+TYWLd5EQn0iiWCZRLG1rftViVV/IQaeXHQPkR3xI4P0cXpYQ+pXFGamuIlc0j14rgzfo9GDZXAufom7jIctZ1EM2zugDqfHz3Uwgr9saes0c3fJHeTYN3GtV4OW+sgDcn3UUxinalKcTgssed+nj8HR9ubxlc51b58vmWbdO6I8Yk/mmTUaVlx63QpdM09StylZH0TyniQDurIZutun2xK7hFa3vL3jO7XdaI3RLStW2t2+dd/+D6sZ4Qdmu8l+kt877BrsQ0jZkKPWoAAAAAElFTkSuQmCC\"","import { AABB, Side } from \"../base/math\";\nimport { MapEntity, MapEntityType } from \"../map/interfaces\";\nimport LevelScene from \"../scene/LevelScene\";\nimport Entity, { EscapeBehaviour } from \"./Entity\";\nimport { DamageBurst } from \"./Particle\";\nimport { Terrain } from \"./Terrain\";\n\nexport interface MobInit {\n  maxHealth: number;\n  health?: number;\n  invincible?: boolean;\n}\n\n/**\n * Mob\n * - is an Entity\n * - has health\n * - can be hurt\n */\nexport default abstract class Mob extends Entity {\n  maxHealth: number;\n  health: number;\n  invincible: boolean;\n\n  /** ticks left while entity is immune to damage */\n  immuneTicks = 0;\n\n  constructor(data: MapEntity, init: MobInit) {\n    super(data);\n\n    this.maxHealth = init.maxHealth;\n    this.health = init.health ?? this.maxHealth;\n    this.invincible = init.invincible ?? false;\n  }\n\n  isMob() { return true };\n  isEnemy() {\n    return ![MapEntityType.player].includes(this.type);\n  }\n\n  get hurtBox() {\n    return this.boxByFacing(this.hurtBoxR);\n  }\n  get hurtBoxR(): AABB {\n    return this.collisionBoxR;\n  }\n\n  get dead() { return this.health <= 0; }\n\n  /**\n   * Returns ticks entity will be immune to damage after being hurt.\n  */\n  get hurtImmuneTicks() { return 0; }\n\n  damage(scene: LevelScene, amount: number, source: DamageSource, evenIfInvincible: boolean = false): boolean {\n    if (amount <= 0) return false;\n    if (this.dead) return false;\n    if (!evenIfInvincible && (this.invincible || this.immuneTicks > 0))\n      return false;\n\n    this.health -= amount;\n    if (this.health < 0)\n      this.health = 0;\n\n    this.onDamage(scene, amount, source);\n    if (this.dead) this.die(scene, source);\n\n    this.immuneTicks = this.hurtImmuneTicks;\n    return true;\n  }\n\n  onDamage(scene: LevelScene, amount: number, source: DamageSource): void {\n    scene.addParticle(new DamageBurst(this.collisionBox.center));\n  }\n\n  cure(scene: LevelScene, amount: number): boolean {\n    if (this.dead) return false;\n    if (this.health === this.maxHealth) return false;\n    this.health += amount;\n    if (this.health > this.maxHealth)\n      this.health = this.maxHealth;\n    return true;\n  }\n\n  die(scene: LevelScene, source: DamageSource): void {\n    if (!this.isPlayer())\n      scene.deleteEntity(this);\n  }\n\n  tick(scene: LevelScene) {\n    if (this.dead) return;\n\n    if (this.immuneTicks > 0)\n      this.immuneTicks--;\n\n    super.tick(scene);\n  }\n\n  onCrossBorder(scene: LevelScene, side: Side, fullOut: boolean): EscapeBehaviour {\n    switch (side) {\n      case Side.top:\n        return EscapeBehaviour.none;\n      case Side.left: case Side.right:\n        return EscapeBehaviour.block;\n      case Side.bottom:\n        this.damage(scene, Infinity, null, true);\n        return EscapeBehaviour.none;\n    }\n  }\n}\n\nexport type DamageSource = Terrain | Entity | null;\n","import { AABB, Axis, Coord, Side, Vector } from \"../base/math\";\nimport Sprite from \"./Sprite\";\nimport imgBrick from \"../assets/terrain/brick.png\";\nimport imgSpikes from \"../assets/terrain/spikes.png\";\nimport imgWater from \"../assets/terrain/water.png\";\nimport { Texture, TextureLike, textureManager } from \"../render/TextureManager\";\nimport { MapEntityType, MapTerrain, MapTerrainBrick, MapTerrainFragile, MapTerrainSpikes, MapTerrainType, MapTerrainWater, TERRAIN_SIZE } from \"../map/interfaces\";\nimport Entity from \"./Entity\";\nimport LevelScene from \"../scene/LevelScene\";\nimport { RendererContext } from \"../render/Renderer\";\n\nlet textureBrick: Texture;\nlet textureSpikes: Texture;\nlet textureWater: Texture;\n\ntextureManager.loadTextures([\n  [\"terrain/brick\", imgBrick],\n  [\"terrain/spikes\", imgSpikes],\n  [\"terrain/water\", imgWater],\n]).then(textures => {\n  [textureBrick, textureSpikes, textureWater] = textures;\n  textureBrick.defineClips([['dirt', 'grass', 'wood','brick']], TERRAIN_SIZE, TERRAIN_SIZE);\n  textureSpikes.defineClips([['bottom', 'left', 'top', 'right']], TERRAIN_SIZE, TERRAIN_SIZE);\n  textureWater.defineClips([['surface', 'under']], TERRAIN_SIZE, TERRAIN_SIZE);\n});\n\nexport abstract class Terrain extends Sprite {\n  constructor(position: Coord, public type: MapTerrainType, public texture: TextureLike) {\n    if (!texture)\n      throw new Error(\"texture should not be null\");\n    super(position);\n  }\n\n  static create(x: number, y: number, cell: MapTerrain | null): Terrain | null {\n    if (!cell) return null;\n    const coord = new Coord(x, y);\n    switch (cell.type) {\n      case MapTerrainType.brick: {\n        const c = cell as MapTerrainBrick;\n        return new TerrainBrick(coord, c.variant);\n      }\n\n      case MapTerrainType.spikes: {\n        const c = cell as MapTerrainSpikes;\n        return new TerrainSpikes(coord, c.side);\n      }\n\n      case MapTerrainType.fragile: {\n        const c = cell as MapTerrainFragile;\n        return new TerrainFragile(coord, c.variant);\n      }\n\n      case MapTerrainType.water: {\n        const c = cell as MapTerrainWater;\n        return new TerrainWater(coord, c.surface);\n      }\n\n      default:\n        console.warn(`terrain (${x}, ${y}): unknown type: ${cell.type}`);\n        return null;\n    }\n  }\n\n  get center() {\n    return new Coord((this.x + 0.5) * TERRAIN_SIZE, (this.y + 0.5) * TERRAIN_SIZE);\n  }\n\n  get boundingBox() {\n    return AABB.offset(this.x * TERRAIN_SIZE, this.y * TERRAIN_SIZE, TERRAIN_SIZE, TERRAIN_SIZE);\n  }\n\n  canCollideWith(entity: Entity) {\n    return true;\n  }\n\n  get collisionBox(): AABB | null {\n    return null;\n  }\n\n  setTexture(texture: TextureLike) {\n    this.texture = texture;\n  }\n\n  getRenderInfo() {\n    return {\n      box: AABB.offset(\n        this.x * TERRAIN_SIZE,\n        this.y * TERRAIN_SIZE,\n        TERRAIN_SIZE, TERRAIN_SIZE\n      ),\n      texture: this.texture\n    }\n  }\n\n  tick(scene: LevelScene) {}\n\n  interactEntity(scene: LevelScene, entity: Entity) {}\n\n  collideEntity(scene: LevelScene, entity: Entity, axis: Axis) {\n    if (!this.canCollideWith(entity)) return;\n\n    const selfBox = this.collisionBox;\n    if (!selfBox) return;\n\n    const\n      vel = entity.velocity,\n      pos = entity.position,\n      oldBox = entity.oldCollisionBox,\n      newBox = entity.collisionBox;\n\n    if (axis === Axis.x) {\n      // horizontal movement\n      if (newBox.vertical.intersects(selfBox.vertical)) {\n        if (oldBox.right <= selfBox.left && newBox.right >= selfBox.left) {\n          vel.x = 0;\n          pos.x -= newBox.right - selfBox.left;\n          this.onCollideEntity(scene, entity, Side.left);\n          entity.onCollideTerrain(scene, this, Side.right);\n        } else if (oldBox.left >= selfBox.right && newBox.left <= selfBox.right) {\n          vel.x = 0;\n          pos.x -= newBox.left - selfBox.right;\n          this.onCollideEntity(scene, entity, Side.right);\n          entity.onCollideTerrain(scene, this, Side.left);\n        }\n      }\n    } else {\n      // vertical movement\n      if (newBox.horizontal.intersects(selfBox.horizontal)) {\n        if (oldBox.bottom <= selfBox.top && newBox.bottom >= selfBox.top) {\n          vel.y = 0;\n          pos.y -= newBox.bottom - selfBox.top;\n          entity.onGround = true;\n          this.onCollideEntity(scene, entity, Side.top);\n          entity.onCollideTerrain(scene, this, Side.bottom);\n        } else if (oldBox.top >= selfBox.bottom && newBox.top <= selfBox.bottom) {\n          vel.y = 0;\n          pos.y -= newBox.top - selfBox.bottom;\n          this.onCollideEntity(scene, entity, Side.bottom);\n          entity.onCollideTerrain(scene, this, Side.top);\n        }\n      }\n    }\n  }\n\n  /**\n   * Triggered when colliding with entities.\n   */\n  onCollideEntity(scene: LevelScene, entity: Entity, side: Side) {}\n}\n\nexport class TerrainBrick extends Terrain {\n  static TEXTURE_MAP: Record<string, string> = {\n    brick: \"terrain/brick:brick\",\n    wood: \"terrain/brick:wood\",\n    dirt: \"terrain/brick:dirt\",\n    grass: \"terrain/brick:grass\",\n    tree: \"decoration/tree:platform\",\n  };\n\n  constructor(position: Coord, public variant: string) {\n    super(position, MapTerrainType.brick, textureManager.get(TerrainBrick.TEXTURE_MAP[variant])!);\n  }\n\n  get collisionBox() {\n    switch (this.variant) {\n      case \"tree\":\n        return this.center.expand(4, 4, 4, 2);\n      default:\n        return this.boundingBox;\n    }\n  }\n}\n\nabstract class HarmingTerrain extends Terrain {\n  /**\n   * Returns the hurting box of this block, `null` for no-hurting.\n   */\n  abstract get hurtBox(): AABB | null;\n\n  /**\n   * Called when the `collisionBox` of an Entity touches `hurtBox`.\n   */\n  abstract onHurtEntity(scene: LevelScene, entity: Entity): void;\n\n  /**\n   * Will hurt the entity if it touches `hurtBox`.\n   */\n  interactEntity(scene: LevelScene, entity: Entity) {\n    if (entity.isMob()) {\n      if (this.hurtBox?.intersects(entity.hurtBox))\n        this.onHurtEntity(scene, entity);\n    } else if (entity.isProjectile()) {\n      if (this.hurtBox?.intersects(entity.collisionBox))\n        this.onHurtEntity(scene, entity);\n    }\n  }\n\n  render(rctx: RendererContext) {\n    super.render(rctx);\n    rctx.run(({ ctx, pixelSize, debug }) => {\n      if (debug) {\n        const hbox = this.hurtBox;\n        if (hbox) {\n          ctx.lineWidth = 2 / pixelSize;\n          ctx.strokeStyle = '#f00';\n          ctx.strokeRect(hbox.left, hbox.top, hbox.width, hbox.height);\n        }\n      }\n    });\n  }\n}\n\nexport class TerrainSpikes extends HarmingTerrain {\n  constructor(position: Coord, public side: Side) {\n    super(position, MapTerrainType.spikes, textureSpikes.getClip(Side[side])!)\n  }\n\n  get hurtBox(): AABB {\n    switch (this.side) {\n      case Side.left:\n        return this.center.plus2(-3, 0).expand(1, 3);\n      case Side.top:\n        return this.center.plus2(0, -3).expand(3, 1);\n      case Side.right:\n        return this.center.plus2(3, 0).expand(1, 3);\n      case Side.bottom:\n        return this.center.plus2(0, 3).expand(3, 1);\n      default:\n        throw new Error(`unknown side: ${this.side}`);\n    }\n  }\n\n  onHurtEntity(scene: LevelScene, entity: Entity) {\n    if (entity.isPlayer()) {\n      entity.damage(scene, 1, this);\n    } else if (entity.isMob()) {\n      entity.damage(scene, entity.type === MapEntityType.witch ? 1 : Infinity, this);\n    } else if (entity.isProjectile()) {\n      entity.destroy(scene);\n    }\n  }\n}\n\nexport class TerrainWater extends HarmingTerrain {\n  constructor(position: Coord, public surface: boolean) {\n    super(position, MapTerrainType.water, textureWater.getClip(surface ? \"surface\" : \"under\")!);\n  }\n\n  get hurtBox() {\n    return this.center.expand(4, this.surface ? 2 : 4, 4, 4);\n  }\n\n  onHurtEntity(scene: LevelScene, entity: Entity) {\n    if (entity.isPlayer()) {\n      entity.damage(scene, 1, this);\n    } else if (entity.isMob()) {\n      entity.damage(scene, Infinity, this);\n    } else if (entity.isProjectile()) {\n      entity.destroy(scene);\n    }\n  }\n}\n\nabstract class FragileTerrain extends Terrain {\n  /** ticks complete destruction take */\n  collapseTicks: number;\n  /** ticks having been collapsing */\n  collapsingTicks = -1;\n\n  collapsed = false;\n\n  constructor(position: Coord, type: MapTerrainType, texture: TextureLike, collapseTicks: number) {\n    super(position, type, texture);\n    this.collapseTicks = collapseTicks;\n  }\n\n  onCollideEntity(scene: LevelScene, entity: Entity, side: Side) {\n    if (side === Side.top && entity.isPlayer()) {\n      this.collapse();\n      for (let x = this.x - 1; x >= 0; x--) {\n        const terrain = scene.terrains[this.y][x];\n        if (!(terrain instanceof FragileTerrain)) break;\n        terrain.collapse();\n      }\n      for (let x = this.x + 1; x < scene.mapWidth; x++) {\n        const terrain = scene.terrains[this.y][x];\n        if (!(terrain instanceof FragileTerrain)) break;\n        terrain.collapse();\n      }\n    }\n  }\n\n  /**\n   * Make the block start to collapse.\n   */\n  collapse() {\n    if (this.collapsingTicks < 0)\n      this.collapsingTicks = 0;\n  }\n\n  tick(scene: LevelScene) {\n    if (this.collapsingTicks >= 0) {\n      this.collapsingTicks++;\n      if (this.collapsingTicks === this.collapseTicks) {\n        this.collapsingTicks = -1;\n        this.collapsed = true;\n        this.onCollapsed(scene);\n      }\n    }\n  }\n\n  onCollapsed(scene: LevelScene) {\n    scene.deleteTerrain(this.position);\n  }\n}\n\nexport class TerrainFragile extends FragileTerrain {\n  collapseOffset = new Vector(0, 0);\n\n  recoveringTicks = -1;\n  recoverTicks = 180;\n\n  static TEXTURE_MAP: Record<string, string> = {\n    tree: \"decoration/tree:platform-fragile\"\n  };\n\n  constructor(position: Coord, public variant: string) {\n    super(position, MapTerrainType.fragile, textureManager.get(TerrainFragile.TEXTURE_MAP[variant])!, 60);\n  }\n\n  get terrainBox() {\n    switch (this.variant) {\n      case \"tree\":\n        return this.center.expand(4, 4, 4, 2);\n      default:\n        return this.boundingBox;\n    }\n  }\n\n  get collisionBox() {\n    return this.collapsed ? null : this.terrainBox;\n  }\n\n  tick(scene: LevelScene) {\n    if (this.collapsed) {\n      this.recoveringTicks++;\n      if (this.recoveringTicks >= this.recoverTicks) {\n        if (!scene.getEntitiesInArea(this.terrainBox).length) {\n          this.recoveringTicks = -1;\n          this.collapsed = false;\n        }\n      }\n    } else if (this.collapsingTicks > 0 && this.collapsingTicks % 3 === 0) {\n      this.collapseOffset.x = Math.floor(Math.random() * 3) - 1;\n      this.collapseOffset.y = Math.floor(Math.random() * 3) - 1;\n    }\n    super.tick(scene);\n  }\n\n  onCollapsed(scene: LevelScene) {\n    this.recoveringTicks = 0;\n  }\n\n  getRenderInfo() {\n    let { box, texture } = super.getRenderInfo();\n    if (this.collapsingTicks >= 0) {\n      box = box.offset(this.collapseOffset);\n    }\n    return { box, texture };\n  }\n\n  render(rctx: RendererContext) {\n    rctx.run(({ ctx }) => {\n      if (this.collapsed)\n        ctx.globalAlpha = 0.4;\n      super.render(rctx);\n    });\n  }\n}\n","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAICAIAAAAwSesQAAAAAXNSR0IArs4c6QAAAjxJREFUOI11k01vElEUhl/6AS295UMuwY52SDpJIV1oitHMwp+AO3XVhXsX/QlNty7c+Q/EjX+BpSZAUprGWD6SIXEsQ2AuLeDt1MEoLk4zmUzhLCbnPDP3nDfvPRN6/+Yp5sW7l8pcfvCp1/w5ym8nvjYuZ1PJ78VSm6vpxMb9wmtN0wzDEEJUKpXDw0PDMACUy2UAk8nk5uZmMBhks1nqE4vF5vKVwDxV2QdgWqdh0/XgVI34SwBfzsxQmPmJEEIIwTk3TRNAtVrlnGuaViqV6AMpJQDbthljmUym3+8Tz+3Fs9raWiTcOh9nMpkVABfjZQAP438D4q6aHQDJ/A6puWp2kvmdu561fgzTiQ3SAcCyLACc83q9Xq/XSYc/pJQefPLsgcdze/GTmhF0yLRO/WqOJ/GjZud4EgcAxI+aHXu0CiCXTbV7LoCh/AfAHl1bjuU10XVdCEHKHMfx9w+Uv10XwMfPbw9efaC3oUU7FAjPxbOBM/z1J7W52u65s6kMhdlsKnPZ1NajF5VKJXBKUZRGo0GuOI4TjUYZY2QPY4xciVzZYdmesl03mT6pdZfopKrs0/ZcjJdpth8GIr+d8PLdrQgtE+dc13VFUYrFIknRdb1QKKyvr/vtkVIyxhhjxE9q3XE09m2YcpPp1vmYMRa8skVxd8NSbElc3iZETNNUVVUIQSXnnHJPk3dfROj5/Uw4zvKw1iWVt4K81fEP9uCieP5YtUfXlGuaBsBTo6oqaaLfOyDIDwP8P4zzEqvbTNKSAAAAAElFTkSuQmCC\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAICAYAAACYhf2vAAAAAXNSR0IArs4c6QAAAIVJREFUOI2tUzEOgCAMPNS4mDgaP+Dk/5/CH5gdSUqdaiqJFCKXMBw56LUcgAEfLvbhYksTEz26nJcwWYJjWwAAMREDwDyMzjpTAzFnXibCc1+L2piItbmc633Nu3TTYkDwep7cleY1GfgDJwW/3OfmemfATHDvCcRErJf5C6zwtUImKE3dhF6SaAarw8AAAAAASUVORK5CYII=\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAICAYAAADjoT9jAAAAAXNSR0IArs4c6QAAAM5JREFUKJGtkaEKwlAUhr/Jym7YHFMQbBaDxUWte42BiLhX8B18BEUsgs03sLqkJqtBHKwNJ9zFaxBBg07Y/ngO53yH82nkZDRXy1/9xVgb+p2WWp3O2ns96LlqFh41PQ/wT4RpMfH6KpEZMr0hTAuZ3gDQB/vr9Of0IR9gC4OL0wAHqrXGE3oMnwD90KwXux+iOGa93X28aOL1FUCl6PJvSWQGQGkOgp6rbGEQxTHCtLCFUR7g5eAOVNtdAJKXgzIAicxYbzcfDvxOSwE8ADzlOOUfwQLmAAAAAElFTkSuQmCC\"","import { ForwardAnimation, GeneratorAnimation } from \"../render/Animation\";\nimport { RendererContext } from \"../render/Renderer\";\nimport LevelScene from \"./LevelScene\";\nimport { SCENE_WIDTH } from \"./Scene\";\nimport strings from \"../assets/strings.json\";\n\nexport const STRINGS = strings;\n\ninterface SubtitleContent {\n  text: string;\n}\n\nexport default class Subtitle {\n  current: SubtitleContent | null = null;\n  opacity = 0;\n  animation: ForwardAnimation<void> | null = null;\n\n  constructor(private scene: LevelScene) {}\n\n  show(content: SubtitleContent, ticks: number) {\n    this.animation = new GeneratorAnimation(this.animate(content, ticks));\n  }\n\n  *animate(content: SubtitleContent, ticks: number) {\n    const fadeIn = 30, fadeOut = 45;\n    this.current = content;\n    for (let i = 0; i < fadeIn; i++) {\n      this.opacity = i / fadeIn;\n      yield;\n    }\n    for (let i = 0; i < ticks - fadeIn - fadeOut; i++) {\n      yield;\n    }\n    for (let i = fadeOut; i > 0; i--) {\n      this.opacity = i / fadeOut;\n      yield;\n    }\n    this.current = null;\n  }\n\n  tick() {\n    if (this.animation?.next()) {\n      this.animation = null;\n    }\n  }\n\n  render(rctx: RendererContext) {\n    rctx.run(({ ctx }) => {\n      if (this.current) {\n        ctx.font = \"5px 'Noto Sans SC'\"; \n        ctx.fillStyle = '#f7f7f7';\n        ctx.globalAlpha = this.opacity;\n        ctx.textAlign = 'center';\n        ctx.textBaseline = 'middle';\n        ctx.shadowColor = \"#000\";\n        ctx.shadowBlur = 3;\n        ctx.fillText(this.current.text, SCENE_WIDTH / 2, 145);\n      }\n    });\n  }\n}","import { AABB, Facing, Side } from \"../base/math\";\nimport { Texture, textureManager } from \"../render/TextureManager\";\nimport Entity, { EscapeBehaviour, GRAVITY } from \"./Entity\";\nimport imgPlayer from \"../assets/entity/player.png\";\nimport LevelScene from \"../scene/LevelScene\";\nimport { MapEntityPlayer, MapEntityType, MapTerrainType } from \"../map/interfaces\";\nimport { RendererContext } from \"../render/Renderer\";\nimport Mob, { DamageSource } from \"./Mob\";\nimport { Terrain } from \"./Terrain\";\nimport { FrameSequence } from \"../render/Animation\";\nimport { DiveAttackWave, DiveSideAttackWave, MeleeWave } from \"./Particle\";\nimport { STRINGS } from \"../scene/Subtitle\";\n\nlet texturePlayer: Texture;\n\nconst\n  MAX_GROUND_SPEED = 1.5,\n  MAX_AIR_SPEED = 1.25,\n  MAX_FALL_SPEED = 3,\n  GROUND_ACCELERATION = 1,\n  AIR_ACCELERATION = 0.45,\n  GROUND_FRICTION = 0.6,\n  AIR_FRICTION = 0.15,\n  JUMP_SPEED_X = 2.5,\n  JUMP_SPEED_Y_SIDE = 2.75,\n  JUMP_SPEED_Y_UP = 3,\n  MELEE_KNOCKBACK = 3,\n  DIVE_ATTACK_PUSH_X = 3,\n  DIVE_ATTACK_PUSH_Y = 3,\n  DIVE_ATTACK_REBOUNCE_X = 4,\n  DIVE_ATTACK_REBOUNCE_Y = 3.25;\n\ntextureManager.loadTexture(\"entity/player\", imgPlayer).then(texture => {\n  texturePlayer = texture;\n  texturePlayer.defineClips([\n    [\"normal\", \"attack1\", \"attack2\", \"attack3\", \"attack4\", \"attack5\"]\n  ], 12, 12);\n});\n\nenum State {\n  normal = 0,\n  walk = 1,\n  attack = 2,\n  attackReversed = 3\n}\n\nexport default class Player extends Mob {\n  /** player state */\n  state = State.walk;\n\n  /** damage of single melee attack */\n  meleeDamage = 1;\n  /** cooldown ticks after each melee attack */\n  meleeSpeed = 30;\n\n  /** tick index when the corresponding key was pressed / released */\n  jumpPressedAt = -1;\n  jumpReleasedAt = -1;\n  meleePressedAt = -1;\n\n  jumpedAt = -99;\n\n  meleeCooldown = 0;\n\n  outOfControlTicks = 0;\n\n  animation: FrameSequence = this.createAnimation(State.normal);\n\n  constructor({ health, maxHealth, ...data }: MapEntityPlayer) {\n    super(data, { health, maxHealth });\n  }\n\n  isPlayer() { return true; }\n\n  get collisionBoxR() {\n    return new AABB(-4, -10, 3, 0);\n  }\n\n  get hurtImmuneTicks() { return 60; }\n\n  get meleeBoxHorizontal() {\n    return this.boxByFacing(new AABB(0, -12, 22, 0));\n  }\n\n  get diveBoxCenter() {\n    return this.position.expand(6, 0, 6, 16);\n  }\n\n  get diveBoxLeft() {\n    return this.position.expand(10, 0, 2, 16);\n  }\n\n  get diveBoxRight() {\n    return this.position.expand(2, 0, 10, 16);\n  }\n\n  getRenderInfoR() {\n    return {\n      box: new AABB(-6, -12, 6, 0),\n      texture: this.animation.current()\n    };\n  }\n\n  getMovement(scene: LevelScene): number {\n    let x = 0;\n    if (scene.isKeyPressed(\"move.left\"))\n      x--;\n    if (scene.isKeyPressed(\"move.right\"))\n      x++;\n    return x;\n  }\n\n  receiveInput(scene: LevelScene, command: string, event: string) {\n    switch (command) {\n      case \"move.jump\":\n        if (event === \"down\")\n          this.jumpPressedAt = scene.ticks;\n        else if (event === \"up\")\n          this.jumpReleasedAt = scene.ticks;\n        break;\n\n      case \"skill.melee\":\n        if (event === \"down\") {\n          this.meleePressedAt = scene.ticks;\n          if (this.meleeCooldown === 0)\n            scene.shortPause(2);\n        }\n        break;\n    }\n  }\n\n  createAnimation(state: State): FrameSequence {\n    switch (state) {\n      case State.normal: default:\n        return FrameSequence.fromClips(\"entity/player\", [\"normal\"]).setLoop(true);\n\n      case State.attack:\n        return FrameSequence.fromClipRanges(\"entity/player\", [\n          [\"attack1\", 1],\n          [\"attack2\", 1],\n          [\"attack3\", 1],\n          [\"attack4\", 1],\n          [\"attack5\", 5],\n          [\"attack4\", 3],\n          [\"attack3\", 3],\n          [\"attack2\", 3],\n          [\"attack1\", 3]\n        ]);\n\n      case State.attackReversed:\n        return FrameSequence.fromClipRanges(\"entity/player\", [\n          [\"attack5\", 2],\n          [\"attack4\", 2],\n          [\"attack3\", 2],\n          [\"attack2\", 2],\n          [\"attack1\", 2]\n        ]);\n    }\n  }\n\n  tick(scene: LevelScene) {\n    if (this.dead) return;\n\n    this.applyFriction(this.onGround ? GROUND_FRICTION : AIR_FRICTION);\n\n    if (this.animation.next())\n      this.animation = this.createAnimation(State.normal);\n\n    if (this.outOfControlTicks > 0) {\n      this.outOfControlTicks--;\n    } else {\n      // Move\n      const movement = this.getMovement(scene);\n      if (movement !== 0)\n        this.facing = movement > 0 ? Facing.right : Facing.left;\n  \n      const\n        maxSpeed = this.onGround ? MAX_GROUND_SPEED : MAX_AIR_SPEED,\n        acceleration = this.onGround ? GROUND_ACCELERATION : AIR_ACCELERATION;\n  \n      const { velocity } = this;\n  \n      if (movement !== 0)\n        this.accelerate(movement > 0 ? Facing.right : Facing.left, acceleration, maxSpeed);\n  \n      // Jump\n      if (this.airTicks <= 3 && this.jumpPressedAt === scene.ticks) {\n        velocity.y = movement === 0 ? -JUMP_SPEED_Y_UP : -JUMP_SPEED_Y_SIDE;\n        if (movement > 0)\n          velocity.x = JUMP_SPEED_X;\n        if (movement < 0)\n          velocity.x = -JUMP_SPEED_X;\n        this.jumpedAt = scene.ticks;\n      }\n  \n      const ticksAfterJumped = scene.ticks - this.jumpPressedAt;\n      if (ticksAfterJumped >= 6 && ticksAfterJumped <= 12 && this.jumpReleasedAt < this.jumpPressedAt) {\n        this.velocity.y -= GRAVITY;\n      }\n  \n      // Melee attack\n      if (scene.ticks === this.meleePressedAt && this.meleeCooldown === 0) {\n        this.meleeAttack(scene);\n      } else {\n        if (this.meleeCooldown > 0)\n          this.meleeCooldown--;\n      }\n    }\n\n    this.velocity.y = Math.min(MAX_FALL_SPEED, this.velocity.y);\n\n    super.tick(scene);\n  }\n\n  canAttack(target: Entity) {\n    if (target.isMob())\n      return target.isEnemy();\n    else if (target.isProjectile())\n      return [MapEntityType.arrow].includes(target.type);\n    else\n      return false;\n  }\n\n  meleeAttack(scene: LevelScene) {\n    if (scene.isKeyPressed(\"move.down\")) {\n      // Dive attack\n      let hit = false;\n      const dir = this.getMovement(scene);\n      const targets = scene.getEntitiesInArea(\n        [this.diveBoxLeft, this.diveBoxCenter, this.diveBoxRight][dir + 1]);\n\n      for (const target of targets) {\n        if (target.isMob() && target.isEnemy()) {\n          if (target.damage(scene, this.meleeDamage, this)) {\n            hit = true;\n            target.velocity.y += DIVE_ATTACK_PUSH_Y;\n            target.setImpulse((dir - 0.25 + Math.random() * 0.5) * DIVE_ATTACK_PUSH_X, null, 4);\n          }\n        }\n      }\n\n      this.meleeCooldown = this.meleeSpeed;\n      if (hit) {\n        this.velocity.x += -dir * DIVE_ATTACK_REBOUNCE_X;\n        this.velocity.y = -DIVE_ATTACK_REBOUNCE_Y;\n      }\n\n      this.animation = this.createAnimation(dir === 0 ? State.attackReversed : State.attack);\n      if (dir === 0)\n        scene.addParticle(new DiveAttackWave(this.position.clone()));\n      else\n        scene.addParticle(new DiveSideAttackWave(this.position.clone(), dir > 0 ? Facing.right : Facing.left));\n    } else {\n      // Horizontal attack\n      let targets = scene.getEntitiesInArea(this.meleeBoxHorizontal).filter(x => this.canAttack(x));\n\n      // Check if there are enemies in the opposite direction\n      if (!targets.length) {\n        let was = this.facing;\n        this.facing = was === Facing.right ? Facing.left : Facing.right;\n        targets = scene.getEntitiesInArea(this.meleeBoxHorizontal).filter(x => this.canAttack(x));\n        if (!targets.length)\n          this.facing = was;\n      }\n\n      for (const target of targets) {\n        if (target.isMob()) {\n          if (target.damage(scene, this.meleeDamage, this)) {\n            target.knockback(this.position, this.facing, MELEE_KNOCKBACK);\n          }\n        } else if (target.isProjectile()) {\n          target.destroy(scene);\n        }\n      }\n\n      this.meleeCooldown = this.meleeSpeed;\n      this.animation = this.createAnimation(State.attack);\n\n      scene.addParticle(new MeleeWave(this.position.clone(), this.facing));\n    }\n  }\n\n  onCrossBorder(scene: LevelScene, side: Side, fullOut: boolean): EscapeBehaviour {\n    if (side === Side.bottom) {\n      this.damage(scene, 1, null, true);\n      return EscapeBehaviour.none;\n    } else {\n      return super.onCrossBorder(scene, side, fullOut);\n    }\n  }\n\n  onDamage(scene: LevelScene, amount: number, source: DamageSource) {\n    // Respawn on certain circumstances if not fatal\n    if (!this.dead) {\n      if (!source || source instanceof Terrain) {\n        scene.onPlayerRespawn();\n        if (!scene.playerFallenIntoWater && source instanceof Terrain && source.type === MapTerrainType.water) {\n          scene.playerFallenIntoWater = true;\n          scene.showSubtitle(STRINGS[\"fall-into-water\"], 180);\n        }\n      }\n    }\n  }\n\n  respawn(scene: LevelScene) {\n    this.position = scene.spawnPoint.clone();\n    this.immuneTicks = this.hurtImmuneTicks;\n    this.facing = Facing.right;\n    this.velocity.reset();\n    this.impulseTicks = 0;\n    this.outOfControlTicks = 30;\n  }\n\n  die(scene: LevelScene, source: DamageSource) {\n    super.die(scene, source);\n    scene.gameOver();\n  }\n\n  render(rctx: RendererContext) {\n    rctx.run(({ ctx, pixelSize, debug }) => {\n      // blink when hurt\n      if (this.immuneTicks % 10 >= 5)\n        ctx.globalAlpha = 0.25;\n      super.render(rctx);\n    });\n  }\n}","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAAAMCAYAAADBJPs9AAAAAXNSR0IArs4c6QAAAclJREFUSInlljFLI0EYhp/VoIemCAnXpLDZZkFSOKfFNRYH2xwi4iGnjVhZ2Oh/8A+IxWFpEzwxXHVcI0RIYRFjUqRJsxYJZyEYsLDRyHfV5nYnk2QFQci+sCy783zvfDPzzexaaFrc/ivB5+RTiT/HG5bOxYUf0+G11Swp/l+JiXW+bp2ETOLEJ3T4/Bc8tosho8lkf/NR5xPBBh/+sXTafbfz+3vfEo0DH5qgx3aR57QDwEd7HoCzXY90wWQfD757BqXIml36KC58AmB5W8Tfhymy1A8rQAW7WmUOespzVPmVzDXjXIXYMYDO008mk3dMp7+wWfnEbD5vnE1f78nXoOeLZOKzBwfkXKHjitw7nkThAV5YQOdDKigll6WSFJQSUzJvwfsxNRgaE+Q7rohpwCbez+fe8V7F6+3dM0jcsnRckZXMNY7VAMBTyrhiuj7vf+Bb5ogZx4vEA9zu7ZFzhZwrg1cswNfPLR5aNzQbdpQu8JTiYmqNZsOOlJdpvKEfRX//FXePQoHDzF9YoN3KROYB7GoVgIfWzTC0K08pmg3beK4M6mcOLFNMQamePAcWhbhlv0G/D1SgjCPxPjes/HX+tf5vwf8D6eTr4v8jYVcAAAAASUVORK5CYII=\"","import { AABB, Vector, Facing } from \"../base/math\";\nimport { RendererContext } from \"../render/Renderer\";\nimport LevelScene from \"./LevelScene\";\nimport { SCENE_WIDTH, SCENE_HEIGHT } from \"./Scene\";\n\nconst ORIGIN_BOX = AABB.origin(SCENE_WIDTH, SCENE_HEIGHT);\n\nconst\n  FOCUS_ANCHOR_L = 60,\n  FOCUS_ANCHOR_R = 240,\n  WINDOW_ANCHOR_L = 120,\n  WINDOW_ANCHOR_R = 180,\n  BASE_ANCHOR_Y = 120,\n  WINDOW_ANCHOR_U = 25,\n  WINDOW_ANCHOR_D = 155,\n  MAX_ACCEL = 3,\n  MIN_SPEED = 0.3,\n  MAX_SPEED = 4,\n  LERP_PROPORTION = 0.08;\n\nenum CameraState { still, accelerating, decelerating }\n\nexport default class Camera {\n  offset = new Vector(0, 0);\n  velocity = new Vector(0, 0);\n  facing = Facing.right;\n  stateX = CameraState.still;\n  stateY = CameraState.still;\n  snappedY: number;\n\n  constructor(private scene: LevelScene) {\n    this.snappedY = this.scene.player.y;\n    this.update(true);\n  }\n\n  get viewBox() {\n    return ORIGIN_BOX.offset2(this.offset.x, this.offset.y);\n  }\n\n  rumble() {\n    // TODO\n  }\n\n  /**\n   * Update the camera.\n   * @param init Whether to ignore previous position and facing.\n   */\n  update(init = false) {\n    const player = this.scene.player;\n    /** Player position  */\n    const playerPos = player.position;\n    const playerPosOld = player.oldPosition;\n    /** Player position relative to the camera */\n    const playerOffset = playerPos.minus(this.offset);\n    const playerOffsetOld = playerPosOld.minus(this.offset);\n    const boundary = this.scene.boundary;\n\n    if (boundary.width <= SCENE_WIDTH) {\n      // Scene too small, just put it in the center\n      this.offset.x = boundary.center.x - SCENE_WIDTH / 2;\n      this.stateX = CameraState.still;\n    } else {\n      // Decide facing\n      if (init) {\n        // Set facing to right initially\n        this.facing = Facing.right;\n      } else {\n        // Change facing if player has crossed the focus anchor\n        if (this.facing === Facing.right) {\n          if (playerOffsetOld.x >= FOCUS_ANCHOR_L && playerOffset.x < FOCUS_ANCHOR_L)\n            this.facing = Facing.left;\n        } else {\n          if (playerOffsetOld.x <= FOCUS_ANCHOR_R && playerOffset.x > FOCUS_ANCHOR_R)\n            this.facing = Facing.right;\n        }\n      }\n\n      /** Target absolute offset */\n      const target = Math.max(boundary.left - 0, Math.min(boundary.right - SCENE_WIDTH,\n        playerPos.x - (this.facing === Facing.right ? WINDOW_ANCHOR_L : WINDOW_ANCHOR_R)));\n\n      if (init) {\n        this.offset.x = target;\n        this.stateX = CameraState.still;\n      } else {\n        const delta = target - this.offset.x;\n        const signFacing = this.facing === Facing.right ? 1 : -1;\n        const signDelta = Math.sign(delta);\n\n        let speed = signFacing !== signDelta ? 0 : LERP_PROPORTION * delta;\n        const accel = speed - this.velocity.x, signAccel = Math.sign(accel);\n\n        if (Math.abs(accel) > MAX_ACCEL)\n          speed = this.velocity.x + signAccel * MAX_ACCEL;\n\n        if (Math.abs(delta) < MIN_SPEED) {\n          if (speed !== 0)\n            this.offset.x = target;\n          this.velocity.x = 0;\n          this.stateX = CameraState.still;\n        } else  {\n          speed = Math.sign(speed) * Math.max(MIN_SPEED, Math.min(MAX_SPEED, Math.abs(speed)));\n          this.offset.x += speed;\n          this.velocity.x = speed;\n          this.stateX = signDelta === signAccel ? CameraState.accelerating : CameraState.decelerating;\n        }\n      }\n    }\n\n    if (boundary.height <= SCENE_HEIGHT) {\n      this.offset.y = boundary.center.y - SCENE_HEIGHT / 2;\n      this.stateY = CameraState.still;\n    } else {\n      if (init || player.onGround || playerOffset.y < WINDOW_ANCHOR_U || playerOffset.y > WINDOW_ANCHOR_D)\n        this.snappedY = playerPos.y;\n\n      const target = Math.max(boundary.top - 0, Math.min(boundary.bottom - SCENE_HEIGHT,\n        this.snappedY - BASE_ANCHOR_Y));\n\n      if (init) {\n        this.offset.y = target;\n        this.stateY = CameraState.still;\n      } else {\n        const delta = target - this.offset.y;\n        let speed = delta * LERP_PROPORTION;\n\n        if (Math.abs(delta) < MIN_SPEED) {\n          this.offset.y = target;\n          this.stateY = CameraState.still;\n        } else {\n          speed = Math.sign(speed) * Math.max(MIN_SPEED, Math.min(MAX_SPEED, Math.abs(speed)));\n          this.offset.y += speed;\n          this.stateY = CameraState.accelerating;\n        }\n      }\n    }\n  }\n\n  render(rctx: RendererContext, callback: () => void) {\n    rctx.run(({ ctx }) => {\n      let { x, y } = this.offset.round();\n      ctx.translate(-x, -y);\n      callback();\n    });\n\n    if (rctx.debug) {\n      rctx.run(({ ctx, pixelSize }) => {\n        // Draw anchor lines\n\n        ctx.strokeStyle =\n        this.stateX === CameraState.accelerating ? '#afa' :\n        this.stateX === CameraState.decelerating ? '#faa' : '#aaa';\n\n        ctx.lineWidth = (this.facing === Facing.right ? 4 : 2) / pixelSize;\n        ctx.beginPath();\n        ctx.moveTo(FOCUS_ANCHOR_L, SCENE_HEIGHT * 0.3);\n        ctx.lineTo(FOCUS_ANCHOR_L, SCENE_HEIGHT * 0.7);\n        ctx.moveTo(WINDOW_ANCHOR_L, SCENE_HEIGHT * 0.25);\n        ctx.lineTo(WINDOW_ANCHOR_L, SCENE_HEIGHT * 0.75);\n        ctx.stroke();\n\n        ctx.lineWidth = (this.facing === Facing.left ? 4 : 2) / pixelSize;\n        ctx.beginPath();\n        ctx.moveTo(FOCUS_ANCHOR_R, SCENE_HEIGHT * 0.3);\n        ctx.lineTo(FOCUS_ANCHOR_R, SCENE_HEIGHT * 0.7);\n        ctx.moveTo(WINDOW_ANCHOR_R, SCENE_HEIGHT * 0.25);\n        ctx.lineTo(WINDOW_ANCHOR_R, SCENE_HEIGHT * 0.75);\n        ctx.stroke();\n\n        ctx.strokeStyle =\n          this.stateY === CameraState.accelerating ? '#7bf' : '#aaa';\n\n        ctx.lineWidth = 3 / pixelSize;\n        ctx.beginPath();\n        ctx.moveTo(SCENE_WIDTH * 0.3, BASE_ANCHOR_Y);\n        ctx.lineTo(SCENE_WIDTH * 0.64, BASE_ANCHOR_Y);\n        ctx.stroke();\n\n        ctx.lineWidth = 1.5 / pixelSize;\n        ctx.beginPath();\n        ctx.moveTo(SCENE_WIDTH * 0.34, WINDOW_ANCHOR_U);\n        ctx.lineTo(SCENE_WIDTH * 0.6, WINDOW_ANCHOR_U);\n        ctx.moveTo(SCENE_WIDTH * 0.34, WINDOW_ANCHOR_D);\n        ctx.lineTo(SCENE_WIDTH * 0.6, WINDOW_ANCHOR_D);\n        ctx.stroke();\n      });\n    }\n  }\n}","import { Coord, Facing } from \"../base/math\";\nimport { MapTerrainType, TERRAIN_SIZE } from \"../map/interfaces\";\nimport Entity from \"../model/Entity\";\nimport Mob from \"../model/Mob\";\nimport { Terrain } from \"../model/Terrain\";\nimport LevelScene from \"../scene/LevelScene\";\n\nexport default class PlatformWalkGoal {\n  constructor(private self: Mob) {}\n  \n  canPassThrough(terrain: Terrain | null) {\n    return terrain === null;\n  }\n  canStandOn(terrain: Terrain | null) {\n    return terrain && [MapTerrainType.brick, MapTerrainType.fragile].includes(terrain.type);\n  }\n\n  findFoothold(scene: LevelScene, entity: Entity): Coord | null {\n    const box = entity.collisionBox;\n    let startY = Math.max(0, Math.ceil(box.bottom / TERRAIN_SIZE));\n    let left = Math.max(0, Math.floor(box.left / TERRAIN_SIZE));\n    let right = Math.min(scene.mapWidth, Math.ceil(box.right / TERRAIN_SIZE));\n    for (let y = startY; y < scene.mapHeight; y++) {\n      const row = scene.terrains[y].slice(left, right);\n      const cell = row.find(x => this.canStandOn(x));\n      if (cell) return cell.position.clone();\n    }\n    return null;\n  }\n\n  checkEmptyArea(scene: LevelScene, x: number, y: number) {\n    let boxHeight = Math.ceil(this.self.collisionBox.height / TERRAIN_SIZE);\n    for (let i = 1; i <= boxHeight && y - i >= 0; i++)\n      if (!this.canPassThrough(scene.terrains[y - i][x]))\n        return false;\n    return true;\n  }\n\n  checkFoothold(scene: LevelScene, x: number, y: number) {\n    return this.canStandOn(scene.terrains[y][x]) && this.checkEmptyArea(scene, x, y);\n  }\n\n  isConnected(scene: LevelScene, coord1: Coord, coord2: Coord) {\n    // Check if they are at the same altitude\n    let y = coord1.y;\n    if (coord2.y !== y) return false;\n\n    // Check if the platforms are connected\n    let x1 = coord1.x, x2 = coord2.x;\n    if (x1 > x2) [x1, x2] = [x2, x1];\n\n    const ground = scene.terrains[y];\n    const aboveGround = y < 1 ? null : scene.terrains[y - 1];\n\n    for (let x = x1; x <= x2; x++) {\n      let flag = this.canStandOn(ground[x]) &&\n        (!aboveGround || this.canPassThrough(aboveGround[x]));\n      if (!flag) return false;\n    }\n    return true;\n  }\n\n  keepDistance(scene: LevelScene, target: Entity, accel: number, maxSpeed: number, minDistance: number, maxDistance: number) {\n    const { self } = this;\n    let deltaX = target.x - self.x;\n\n    // Update facing\n    self.facing = deltaX > 0 ? Facing.right : Facing.left;\n\n    // Check foothold\n    const foothold = this.findFoothold(scene, self);\n    if (!foothold) return;\n    const footholdTarget = this.findFoothold(scene, target);\n    if (!footholdTarget) return;\n\n    // Check if on the same platform\n    if (!this.isConnected(scene, foothold, footholdTarget))\n      return;\n\n    const box = self.collisionBox;\n    let distance = Math.abs(deltaX);\n\n    // Decide heading\n    let heading: Facing;\n    if (distance > maxDistance)\n      heading = deltaX > 0 ? Facing.right : Facing.left;\n    else if (distance < minDistance)\n      heading = deltaX > 0 ? Facing.left : Facing.right;\n    else\n      return;\n\n    const blockX = heading === Facing.right ?\n      Math.ceil(box.right / TERRAIN_SIZE) - 1 :\n      Math.floor(box.left / TERRAIN_SIZE);\n\n    // Avoid getting out of the platform\n    if (blockX >= 0 && blockX < scene.mapWidth && this.checkFoothold(scene, blockX, foothold.y)) {\n      self.accelerate(heading, accel, maxSpeed);\n    }\n  }\n}","import { FrameSequence } from \"../render/Animation\";\n\nexport interface StateMeta<S> {\n  next: S;\n  animation: FrameSequence;\n}\n\nexport default class StateMachine<S> {\n  states: Map<S, StateMeta<S>>;\n  animation: FrameSequence;\n  interrupted = false;\n\n  constructor(states: [S, StateMeta<S>][], public current: S) {\n    this.states = new Map(states);\n    this.animation = this.states.get(current)!.animation;\n  }\n\n  set(state: S, index = 0, interrupt = true) {\n    this.current = state;\n    this.animation = this.states.get(this.current)!.animation;\n    this.animation.set(index);\n    this.interrupted = interrupt;\n  }\n\n  next() {\n    if (this.interrupted) {\n      this.interrupted = false;\n      return;\n    }\n    if (this.animation.next()) {\n      this.set(this.states.get(this.current)!.next, 0, false);\n    }\n  }\n}","import { AABB, Coord } from \"../base/math\";\nimport { MapEntityItem, MapEntityItemFlower, MapEntityType, MapItemType } from \"../map/interfaces\";\nimport Entity from \"./Entity\";\nimport imgFlower from \"../assets/entity/flower.png\";\nimport imgRuby from \"../assets/entity/ruby.png\";\nimport { Texture, TextureLike, textureManager } from \"../render/TextureManager\";\nimport LevelScene from \"../scene/LevelScene\";\nimport { STRINGS } from \"../scene/Subtitle\";\nimport { FrameSequence } from \"../render/Animation\";\n\nlet textureFlower: Texture;\nlet textureRuby: Texture;\n\ntextureManager.loadTextures([\n  [\"entity/flower\", imgFlower],\n  [\"entity/ruby\", imgRuby],\n]).then(textures => {\n  [textureFlower, textureRuby] = textures;\n  textureFlower.defineClips([[\"big\", \"small\"]], 8, 8);\n  textureRuby.defineClips([[\"0\", \"1\", \"2\"]], 8, 8);\n});\n\nexport default abstract class EntityItem extends Entity {\n  item: MapItemType;\n\n  constructor(data: MapEntityItem) {\n    super(data);\n\n    this.item = data.item;\n  }\n\n  isItem() { return true; }\n\n  static create(data: MapEntityItem): EntityItem {\n    switch (data.item) {\n      case MapItemType.flower:\n        return new ItemFlower(data as MapEntityItemFlower);\n\n      case MapItemType.ruby:\n        return new ItemRuby(data);\n\n      default:\n        throw new Error(`unknown item type: ${data.type}`);\n    }\n  }\n\n  get underGravity() { return false; }\n\n  tick(scene: LevelScene) {\n    if (scene.player.collisionBox.intersects(this.collisionBox)) {\n      this.onPickup(scene);\n    }\n  }\n\n  /**\n   * Called when the item will be picked up by the player.\n   */\n  onPickup(scene: LevelScene) {\n    scene.deleteEntity(this);\n  }\n}\n\nexport class ItemFlower extends EntityItem {\n  double: boolean;\n  texture: TextureLike;\n\n  constructor(data: MapEntityItemFlower) {\n    super(data);\n    this.double = data.double;\n    this.texture = textureFlower.getClip(this.double ? \"big\" : \"small\");\n  }\n\n  get collisionBoxR() {\n    return new AABB(-4, -8, 4, 0);\n  }\n\n  getRenderInfoR() {\n    return {\n      box: this.collisionBoxR,\n      texture: this.texture\n    };\n  }\n\n  onPickup(scene: LevelScene) {\n    if (scene.player.cure(scene, this.double ? 2 : 1)) {\n      super.onPickup(scene);\n    }\n  }\n\n  static trySpawnAt(scene: LevelScene, position: Coord, p1: number, p2: number) {\n    let seed = Math.random();\n    if (seed < p1 + p2) {\n      scene.addEntity(new ItemFlower({\n        x: position.x, y: position.y,\n        tags: [\"witch-summon-loot\"],\n        type: MapEntityType.item,\n        item: MapItemType.flower,\n        double: seed > p1\n      }));\n\n      if (!scene.skeletonDroppedFlower) {\n        scene.skeletonDroppedFlower = true;\n        scene.showSubtitle(STRINGS[\"drop-flower\"], 180);\n      }\n    }\n  }\n}\n\nexport class ItemRuby extends EntityItem {\n  animation = FrameSequence.fromClipRanges(\"entity/ruby\", [\n    [\"0\", 20],\n    [\"1\", 15],\n    [\"2\", 20],\n    [\"1\", 15],\n  ]).setLoop(true);\n\n  get collisionBoxR() {\n    return new AABB(-4, -4, 4, 4);\n  }\n\n  getRenderInfoR() {\n    return {\n      box: this.collisionBoxR,\n      texture: this.animation.current()\n    };\n  }\n\n  tick(scene: LevelScene) {\n    this.animation.next();\n    super.tick(scene);\n  }\n}\n","import { AABB } from \"../../base/math\";\nimport imgScout from \"../../assets/entity/scout.png\";\nimport imgSkeletonScout from \"../../assets/entity/skeleton-scout.png\";\nimport { Texture, textureManager } from \"../../render/TextureManager\";\nimport LevelScene from \"../../scene/LevelScene\";\nimport { MapEntityScout } from \"../../map/interfaces\";\nimport PlatformWalkGoal from \"../../ai/PlatformWalkGoal\";\nimport Mob, { DamageSource } from \"../Mob\";\nimport StateMachine from \"../StateMachine\";\nimport { FrameSequence } from \"../../render/Animation\";\nimport { ItemFlower } from \"../Item\";\n\nlet textureScout: Texture;\nlet textureSkeletonScout: Texture;\n\ntextureManager.loadTextures([\n  [\"entity/scout\", imgScout],\n  [\"entity/skeleton-scout\", imgSkeletonScout]\n]).then(textures => {\n  [textureScout, textureSkeletonScout] = textures;\n  textureScout.defineClips([\n    [\"0\", \"1\", \"2\", \"3\", \"4\"]\n  ], 8, 10);\n  textureSkeletonScout.defineClips([\n    [\"0\", \"1\", \"2\", \"3\", \"4\"]\n  ], 8, 10);\n});\n\nconst WALK_SPEED = 0.75;\n\nenum State {\n  idle = 0,\n  stabbing = 1,\n  stabbed = 2\n}\n\nenum Variant {\n  normal = 0,\n  skeleton = 1\n}\n\nexport default class EnemyScout extends Mob {\n  stabbingTicks = 0;\n\n  attackCooldown = 0;\n  attackSpeed = 40;\n  attackDamage = 1;\n\n  platformWalkGoal = new PlatformWalkGoal(this);\n\n  variant: Variant;\n\n  state: StateMachine<State>;\n\n  constructor(data: MapEntityScout) {\n    super(data, { maxHealth: 3 });\n\n    this.variant = data.skeleton ? Variant.skeleton : Variant.normal;\n\n    const texture = this.variant === Variant.normal ? \"entity/scout\" : \"entity/skeleton-scout\";\n\n    this.state = new StateMachine<State>([\n      [State.idle,\n        {\n          next: State.idle,\n          animation: FrameSequence.fromClipRanges(texture, [\n            [\"0\", 1]\n          ])\n        }\n      ],\n      [State.stabbing,\n        {\n          next: State.stabbed,\n          animation: FrameSequence.fromClipRanges(texture, [\n            [\"0\", 1],\n            [\"1\", 2],\n            [\"2\", 2],\n          ])\n        }\n      ],\n      [State.stabbed,\n        {\n          next: State.idle,\n          animation: FrameSequence.fromClipRanges(texture, [\n            [\"3\", 5],\n            [\"4\", 5],\n          ])\n        }\n      ],\n    ], State.idle);\n  }\n\n  get collisionBoxR() {\n    return new AABB(-4, -10, 4, 0);\n  }\n\n  get attackBox() {\n    return this.boxByFacing(new AABB(-2, -12, 10, 0));\n  }\n\n  getRenderInfoR() {\n    return {\n      box: new AABB(-4, -10, 4, 0),\n      texture: this.state.animation.current()\n    };\n  }\n\n  tick(scene: LevelScene) {\n    const { player } = scene;\n\n    this.applyFriction(this.onGround ? 0.75 : 0.25);\n\n    this.platformWalkGoal.keepDistance(scene, player, this.onGround ? 1 : 0.25, WALK_SPEED, 8, 10);\n\n    if (this.attackCooldown > 0) {\n      this.attackCooldown--;\n    } else {\n      const playerInTouch = this.attackBox.intersects(scene.player.hurtBox);\n\n      if (playerInTouch) {\n        this.stabbingTicks++;\n        if (this.stabbingTicks > 5)\n          this.stabbingTicks = 5;\n        if (this.state.current === State.idle)\n          this.state.set(State.stabbing);\n      } else if (this.state.current === State.stabbing) {\n        this.stabbingTicks = Math.max(0, this.stabbingTicks - 2);\n        if (this.stabbingTicks > 0)\n          this.state.set(State.stabbing, this.stabbingTicks - 1);\n        else\n          this.state.set(State.idle);\n      }\n\n      if (playerInTouch && this.stabbingTicks >= 5) {\n        if (player.damage(scene, this.attackDamage, this)) {\n          player.knockback(this.position, this.facing, 2.5);\n          this.attackCooldown = this.attackSpeed;\n          this.stabbingTicks = 0;\n          this.state.set(State.stabbed);\n        } else {\n          this.state.set(State.stabbing, 9);\n        }\n      }\n    }\n\n    this.state.next();\n\n    super.tick(scene);\n  }\n\n  die(scene: LevelScene, source: DamageSource) {\n    if (this.tags.includes(\"witch-summon\")) {\n      ItemFlower.trySpawnAt(scene, this.collisionBox.center, 0.6, 0.2);\n    }\n    super.die(scene, source);\n  }\n}","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAICAYAAADwdn+XAAAAAXNSR0IArs4c6QAAAMJJREFUKJGNkDEKwjAYhb807gULpUuh1KVHKDi76wm8Q6B3EAQ3D+ANxNUj9AIuBcGlCPEEyu9iYisV+iDk5395H48oAFs0AhCmOU6Ts1KMUOCGMM3R1R1d3elCu7JFI8+FSNcLbNHINLUAvLYxr23cC/xCNPVwA03tTU2NgwJwTAQgusyUvz875R7I/tQjP24R0WYOy1Z1IeaQsVtfv3tvHhOxReOPC/zKrMrBvYeYVSluHhP2f8CyVeaQ4Wr2K/7XG9DPVXNtpftJAAAAAElFTkSuQmCC\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAICAYAAADjoT9jAAAAAXNSR0IArs4c6QAAAGlJREFUKJFjZKACWGNk9B+beMi5c4yMlBqwxsjov+WXSwxSzUsZntVGw+WO8+gxMDAwMDBSagADAwNDcHk5ihyyGooNgAHLL5ewyjGuMTL6T4kBMF9iaIbKwSXJNQCbODIgGAeEDBhwAAA8eU014igtbQAAAABJRU5ErkJggg==\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAKCAYAAADGmhxQAAAAAXNSR0IArs4c6QAAAV9JREFUOI3N1L9LAmEcx/H3ZWGUB3EclIsaHDQF1ZRD4KLLbTcI/QFG0N7/0erYH+AQtIiD5JaLECKRDS4dghxERkrF06DP+fgj0yX9Tnf3ep7n8/Dc905juIRyrTFe/+7qIHGadqjVqgBUHh6XwrVRbLY6AGyb6+oiC/NV9XybrQ6u2+jfRRmtRboIh6MCEF4pK7xSVtDrB7EULhEQjm0Jx7aEMsl3aZP8YH9v6vy//Lf8ACDa7VcAHNvC9HQ2PoK8fAdx3YYm3bEtgIlu7e7IfuLEjM7t0/JX1PdsejoFN0Akmebm7nmsRyrVLSLJNJnrMvGjtcHzfngqEaVlvFFwA1xkzik/fYlZfFq+/xXLE5J1bIW4vKr4nkoMmja02dtc7rbuu9yA9Pb7J/liY2ZXTc2XJ6iZno7p6eRu65rp6dTvh/6jWqxrEOsa5IsNf6zqZ/HDIY91jblcrj+a/wOpo3o4PVam2QAAAABJRU5ErkJggg==\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAKCAYAAADGmhxQAAAAAXNSR0IArs4c6QAAATxJREFUOI3NlDFLw0AUx38XioMdunUoQb+BmxQRAvoJHHoQ6FJcnELbT1L7Dbo4XUoHFyeHgEjxUwjBwc0hS5ZzkJNLcpcgIvimS373v/97eS8nAJRSGiuklMJ+7uLr1arC58vlj3jb+YFZFCXIpwlFiTPa+GAYMgpD5q8Ltxg6ue/8noEf7znr41tm02p1hgNsTlOOriZeA3WeImVTPwpDwM+7/IFqGx4LrX1c6yYD2NypVn29jfV9Pv/AFphNF4fOGoiiSKeJB1pJuvRFWS1Ca60v+8I5q7a+ZxbP+z0AcRw7k9judmRZJrLMndzD/ba1CJsnJy8IUU3O5y/g6/O/5TnQ/MOM6Gw89nKllDZzOpvKBo+iSF/fJF7e5Q80r4J62O35C+7z/57BwTBs0/86+gft3OcfON/+o/gECCe+EnTdV6IAAAAASUVORK5CYII=\"","import imgGuard from \"../../assets/entity/guard.png\";\nimport { Texture, textureManager } from \"../../render/TextureManager\";\nimport LevelScene from \"../../scene/LevelScene\";\nimport { MapEntity } from \"../../map/interfaces\";\nimport { AABB } from \"../../base/math\";\nimport Mob from \"../Mob\";\n\nlet textureGuard: Texture;\n\ntextureManager.loadTexture(\"entity/guard\", imgGuard).then(texture => {\n  textureGuard = texture;\n});\n\nconst WALK_SPEED = 0.375;\n\nexport default class EnemyGuard extends Mob {\n  constructor(data: MapEntity) {\n    super(data, { maxHealth: 20 });\n  }\n\n  get collisionBoxR() {\n    return new AABB(-3, -14, 3, 0);\n  }\n\n  getRenderInfoR() {\n    return {\n      box: new AABB(-4, -14, 4, 0),\n      texture: textureGuard\n    };\n  }\n\n  tick(scene: LevelScene) {\n    if (scene.player.x > this.position.x) {\n      this.velocity.x = WALK_SPEED;\n    } else {\n      this.velocity.x = -WALK_SPEED;\n    }\n\n    super.tick(scene);\n  }\n}","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAOCAYAAAASVl2WAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAAA/SURBVChTY/wPBAwg0KABpuCg4QaEBin4X68OplAAVIwJogw3oFzB8HAkqgkgQZjrYQDsVLy+QDcaGTRoMAAAKRNtmD2SvQEAAAAASUVORK5CYII=\"","import Scene from \"./Scene\";\n\ninterface MenuItem {\n  disabled: boolean;\n}\n\ntype MenuCallback<T extends MenuItem> = (item: T) => void;\n\nexport default class SelectMenu<T extends MenuItem> {\n  selectedIndex = 0;\n\n  constructor(private scene: Scene, private items: T[], private callback: MenuCallback<T>) {\n    this.validateItems(items);\n    this.selectedIndex = this.findFirstItem(0, 1, true);\n\n    this.keyHandler = this.keyHandler.bind(this);\n    this.scene.listenAllKeys(this.keyHandler);\n  }\n\n  cleanup() {\n    this.scene.removeGlobalListener(this.keyHandler);\n  }\n\n  validateItems(items: T[]) {\n    if (!items.filter(item => !item.disabled).length)\n      throw new Error(\"menu should have at least one enabled item\");\n  }\n\n  get selectedItem() {\n    return this.items[this.selectedIndex];\n  }\n\n  getItems() {\n    return this.items.slice(0);\n  }\n\n  setItems(items: T[], selectedIndex: number = 0) {\n    this.validateItems(items);\n    this.items = items;\n    this.selectedIndex = selectedIndex;\n  }\n\n  findFirstItem(start: number, dir: number, includeFirst: boolean) {\n    let index = start, isFirst = true;\n    while (this.items[index].disabled || (isFirst && !includeFirst)) {\n      index = (index + dir + this.items.length) % this.items.length;\n      isFirst = false;\n    }\n    return index;\n  }\n\n  keyHandler(command: string, event: string) {\n    switch (command) {\n      case \"move.up\":\n        if (event === \"down\" || event === \"repeat\")\n          this.selectedIndex = this.findFirstItem(this.selectedIndex, -1, false);\n        break;\n      case \"move.down\":\n        if (event === \"down\" || event === \"repeat\")\n          this.selectedIndex = this.findFirstItem(this.selectedIndex, 1, false);\n        break;\n      case \"ui.confirm\":\n        if (event === \"down\")\n          this.callback(this.items[this.selectedIndex]);\n        break;\n    }\n  }\n}\n","import { MapDecoration, MapDecorationSign, TERRAIN_SIZE } from \"../map/interfaces\";\nimport Model from \"./Model\";\nimport imgTree from \"../assets/decoration/tree.png\";\nimport imgBrickWall from \"../assets/decoration/brick-wall.png\";\nimport imgBrickWallLight from \"../assets/decoration/brick-wall-light.png\";\nimport imgSign from \"../assets/decoration/sign.png\";\nimport { Texture, TextureLike, textureManager } from \"../render/TextureManager\";\nimport { RendererContext } from \"../render/Renderer\";\n\nexport let textureTree: Texture;\n\ntextureManager.loadTextures([\n  [\"decoration/tree\", imgTree],\n  [\"decoration/brick-wall\", imgBrickWall],\n  [\"decoration/brick-wall-light\", imgBrickWallLight],\n  [\"decoration/sign\", imgSign],\n]).then(textures => {\n  [textureTree] = textures;\n  textureTree.defineClips([\n    [\"branch-end-l\", \"branch\", \"trunk-branch-l\", \"trunk\", \"trunk-branch-r\", \"branch-end-r\", \"platform\", \"platform-fragile\"]\n  ], TERRAIN_SIZE, TERRAIN_SIZE);\n});\n\ninterface DecorationVariantMeta {\n  texture: string;\n  box: [number, number, number, number];\n}\n\nconst VARIANTS = new Map<string, DecorationVariantMeta>([\n  [\"trunk\", { texture: \"decoration/tree:trunk\", box: [4, 4, 4, 4] }],\n  [\"trunk-branch-l\", { texture: \"decoration/tree:trunk-branch-l\", box: [4, 4, 4, 4] }],\n  [\"trunk-branch-r\", { texture: \"decoration/tree:trunk-branch-r\", box: [4, 4, 4, 4] }],\n  [\"branch\", { texture: \"decoration/tree:branch\", box: [4, 4, 4, 4] }],\n  [\"branch-end-l\", { texture: \"decoration/tree:branch-end-l\", box: [4, 4, 4, 4] }],\n  [\"branch-end-r\", { texture: \"decoration/tree:branch-end-r\", box: [4, 4, 4, 4] }],\n  [\"brick-wall\", { texture: \"decoration/brick-wall\", box: [4, 4, 4, 4] }],\n  [\"brick-wall-light\", { texture: \"decoration/brick-wall-light\", box: [4, 4, 4, 4] }],\n  [\"sign\", { texture: \"decoration/sign\", box: [16, 24, 16, 0] }],\n]);\n\nexport default class Decoration extends Model {\n  variant: string;\n  variantMeta: DecorationVariantMeta | null = null;\n  texture: TextureLike | null = null;\n\n  constructor(public data: MapDecoration) {\n    super(data);\n\n    this.variant = data.variant;\n    this.variantMeta = VARIANTS.get(this.variant) ?? null;\n    if (this.variantMeta) {\n      this.texture = textureManager.get(this.variantMeta.texture);\n      if (!this.texture)\n        console.warn(`texture not found: ${this.variantMeta.texture}`)\n    } else {\n      console.warn(`unknown decoration variant: ${this.variant}`);\n    }\n  }\n\n  get renderBox() {\n    return this.position.round().expand(...this.variantMeta!.box);\n  }\n\n  getRenderInfo() {\n    return this.texture && {\n      texture: this.texture,\n      box: this.renderBox\n    };\n  }\n\n  render(rctx: RendererContext) {\n    super.render(rctx);\n    if (this.variant === \"sign\") {\n      rctx.run(({ ctx }) => {\n        ctx.font = \"4.4px 'Noto Sans SC'\"; \n        ctx.fillStyle = '#f7f7f7';\n        ctx.textAlign = 'center';\n        ctx.textBaseline = 'middle';\n        ctx.shadowColor = \"#000\";\n        ctx.shadowBlur = 2;\n\n        const lines = (this.data as MapDecorationSign).text.split('\\n');\n        const box = this.renderBox;\n        let lineHeight = 5.7;\n        let y = box.top + 10.5 - lines.length / 2 * lineHeight;\n\n        for (let i = 0; i < lines.length; i++) {\n          ctx.fillText(lines[i], box.center.x, y + i * lineHeight);\n        }\n      });\n    }\n  }\n}\n","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAICAYAAABuzHg3AAAAAXNSR0IArs4c6QAAAppJREFUSInNlT9o20AUxj8Xmxv8B2FZaKlkQwMOLbg0FIOhU6ClLnTzUi/p2C0EPHjJ1KVDIWTL6qVTx5IGApkaCiUUWgjE4ID/ZEllCWFHw+HhOijvLDmyW5IM+Rbr7t27e/rpe+cYbkE7zar4cniKZUORc5brobV7HAOARr0sTgYu1HQCmpKcG6d8y/UAQMYXqbu3KQAAF/3pZMoMrcnnEqFxr3sqnwu11j/PWKT4TZJJnHMMnRFgKLBcD/Z4AjU9LdrQU/j2qw81rQIAgrCCcesyxx5PQvGFCoDLFx7IZ4JUqLVi3b1NUXj5PgSq+3lN3BQeMAfg9saqGJxfyLGhp8AYw7sPX0MHNuplYbke9o/O8OyxKZ0zK8YYctkMAB9eVJzy7fEEQ2eEEwBrrx4Jcuy8GvaO/gDwPyIOB3Ke6id4s04t1Fqx24Aokxv1sqAXVNMJ6YJZKJWSCc65LJCADJ0RinnfYe2ejTcvHmJ96yCGAAjL9dDu2Xj7+gk456E4ubbds5HLZjB0RshlM5E1ENQlU0Wnb0vwQdF1QblRceD/rolFiu80q6LTtyUMNZ3ASlGXgKhYwHcB5xw/2+cy9vzp/ctxBpWSiU7fvlKsP/ZQKZlyP8aYjBO0SsmUucW8KuvQlCQMPSXXB53YqJeFpiShKZBrgnuTNAWhD1Ep+fdka/f4Gtimis+2xPbGqmCMYclkflsAWN86iO00q4KcF4QaLPb7737kPOBD5JzDcj3ZjiRqb865dOGyYYIxBkNHZOuSPn76cS0H3RQc6codSG01q3kvAPgtSC2hKUnYYxfkagDySiBX7x+dhf4kKJfiuWwGhp5aeOZd0b3b2IQcSb9DZxRqF01JIgg4Kr5S1OV46Iwi2/Au6i/M8VRhLmfKYAAAAABJRU5ErkJggg==\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAAXNSR0IArs4c6QAAAHBJREFUGJV1jTsKQyEQRU/AZmSw1NLtuP9dqJ0MTpkU4UnIS253/4/W2hNgrYW7M8ag1sqF0Hs/xMwAmHOiqpRSCJf4DTPDzAh775v5qYWc82nsvYkxoqrnLogI7n5rq+o7ACAiP+dFhJBS+vufUuIFXw83ViR+W0cAAAAASUVORK5CYII=\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAAXNSR0IArs4c6QAAAL1JREFUGJVVjrFqg1AYRk+MVK9crkiJjg6BCr5EV1+jc6e8U7e+SSBDCAlkcMygqQTl8uud2klJz3Q+OMO3qqrqF2AYBsZxpG1b8jxnxm+aZhlFGZNvQ8LgheulJ8syPGst1lqKMuaZooyp6xpPRBARJueYnOPr+3NxEcFP0xSAMAgIHnd27x/E+g2XbIiiCE8pBcBhf6OPDKfuFZdsuF56tNb4AHN0Pv4gsqbb39Bao5TCN8b8Oyciixtj+AMCEEkG4f4VLQAAAABJRU5ErkJggg==\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAYCAYAAACbU/80AAAAAXNSR0IArs4c6QAAAttJREFUSIm9lktu2zAQhj81ejiyK9kJ8jSCNovCCHyBFOgJsukRcrYeoZueoIteICi6CtDCyANIbDmyLclK3YUwFPVy6yz6r0jqH87wnxlSxuXFcDWZpgi6nsmm0O2bcLrv4LbswprXtjAB3p/tMJ0tCx8AtTaPEgAOd9v1u/cp8HWIrYwlCPFhAiSpUSDfBAlHvq3mYpSkBo9BiNuyuQkSfCf71nJsZb/jdwCI4qRiXw5KKSAQotsqRit4DEI11gOM4tzR9X3O8R0KpwW4fZix43eI4oTvo2kWwGMQqsU6BcqYRwlBnI2DOOf4ThYYQMux1X7lVIo/WNBYcSKrbqgrEsQJp/tVuXXcBBkniusPAmBcXgxX80mI5Vo4jksczxvJQCPHcVzCcYDl5nIv59nJZU1sl/Mllmth2U6mwLu3e9pWxbzLSSCXt44DgL9XmEoqi8jnVz+fsgC8tkWSGkRxopxJAeljPa+SIttcKV6SGmqepAaD41yNMkc6z5xMU6bdvH+rEecKoHVBU4td32frUh+3DzP17XC3rdpYDqCKUBbq+ndw3FbRC+oKq+XYnO7nAenO6+Zdz+RVZZf/DBOKuYWqrALJb/kkAq9tFa7juhtQvykBjI8fBiv7d0Sn5wMQjoPGaPVWlRbr9PzCXG852UvWhCN2R76dt6GqgZo3QK7SvAbKl0t+++l4dCjCy5UR1c2uZzKaLICF4p31PW4fZpVXEWA0Wajnt/p0Lwqz0d2c/oFLGeMo89fvbmMAXF4MV5++XKkSPx+erAAGb7yKMYDOLeN8eLLqvXYYP2WPxUHP5fPXHwW+7s+s27DTMgmjlNHdnDBK+Xb1q9FhHWxzSzlP0ue1B6htw/Z2lkvL2trEr8LdeP17omPtPWCbW3Ram/+ibWLTGEDvdVbCYfT3/7119pKOJjSGulw+q0J6CcZPsaqldahVYLZo/oHYBP+iXmMKXir9prZ/AA+Oc2MACYXZAAAAAElFTkSuQmCC\"","import { Coord, Side } from \"../../base/math\";\nimport { MapEntityType } from \"../../map/interfaces\";\nimport { RendererContext } from \"../../render/Renderer\";\nimport LevelScene from \"../../scene/LevelScene\";\nimport Entity, { EscapeBehaviour } from \"../Entity\";\nimport Mob from \"../Mob\";\n\nexport default abstract class Projectile extends Entity {\n  constructor(position: Coord, type: MapEntityType, public owner: Mob | null) {\n    super({ x: position.x, y: position.y, tags: [], type });\n  }\n\n  isProjectile() { return true; }\n\n  get underGravity() { return false; }\n\n  /**\n   * Called when Projectile hits a Mob.\n   * @returns whether Projectile should be destroyed\n   */\n  abstract onHitMob(scene: LevelScene, mob: Mob): boolean;\n\n  /**\n   * Destroy this Projectile and remove it from the world.\n   */\n  destroy(scene: LevelScene) {\n    scene.deleteEntity(this);\n  }\n\n  tick(scene: LevelScene) {\n    super.tick(scene);\n\n    for (const entity of scene.entities) {\n      if (entity.isMob()) {\n        if (this.collisionBox.intersects(entity.hurtBox) && this.onHitMob(scene, entity)) {\n          this.destroy(scene);\n          break;\n        }\n      }\n    }\n  }\n\n  onCrossBorder(scene: LevelScene, side: Side, fullOut: boolean) {\n    switch (side) {\n      case Side.top:\n        return EscapeBehaviour.none;\n      default:\n        return EscapeBehaviour.delete;\n    }\n  }\n\n  render(rctx: RendererContext) {\n    super.render(rctx);\n    rctx.run(({ ctx, pixelSize, debug }) => {\n      if (debug) {\n        const hbox = this.collisionBox;\n        if (hbox) {\n          ctx.lineWidth = 2 / pixelSize;\n          ctx.strokeStyle = '#f00';\n          ctx.strokeRect(hbox.left, hbox.top, hbox.width, hbox.height);\n        }\n      }\n    });\n  }\n}","import { AABB, Coord, Facing, Side } from \"../../base/math\";\nimport { MapEntityType } from \"../../map/interfaces\";\nimport Mob from \"../Mob\";\nimport Projectile from \".\";\nimport LevelScene from \"../../scene/LevelScene\";\nimport { Terrain } from \"../Terrain\";\nimport imgArrow from \"../../assets/entity/arrow.png\";\nimport { Texture, textureManager } from \"../../render/TextureManager\";\n\nlet textureArrow: Texture;\n\ntextureManager.loadTexture(\"entity/arrow\", imgArrow).then(texture => {\n  textureArrow = texture;\n});\n\nexport default class Arrow extends Projectile {\n  stoppedTicks = -1;\n\n  constructor(position: Coord, owner: Mob | null, public power: number, facing: Facing) {\n    super(position, MapEntityType.arrow, owner);\n    this.facing = facing;\n    this.velocity.x = (facing === Facing.right ? 1 : -1) * 3;\n  }\n\n  canHarmMob(mob: Mob) {\n    return mob.type === MapEntityType.player;\n  }\n\n  get collisionBoxR() {\n    return new AABB(-1, 0, 4, 1);\n  }\n\n  getRenderInfoR() {\n    return {\n      box: new AABB(-4, -1, 4, 2),\n      texture: textureArrow\n    };\n  }\n\n  tick(scene: LevelScene) {\n    if (this.stoppedTicks >= 0) {\n      this.stoppedTicks++;\n      if (this.stoppedTicks >= 600) {\n        this.destroy(scene);\n        return;\n      }\n    }\n    super.tick(scene);\n  }\n\n  onHitMob(scene: LevelScene, mob: Mob) {\n    if (this.stoppedTicks >= 0)\n      return false;\n    if (mob.isPlayer() && mob.damage(scene, this.power, this)) {\n      mob.knockback(this.position.plus2(0, 8), this.facing, 3, 3);\n      return true;\n    }\n    return false;\n  }\n\n  onCollideTerrain(scene: LevelScene, terrain: Terrain, side: Side) {\n    const facingSide = this.facing === Facing.right ? Side.right : Side.left;\n    if (facingSide === side && this.stoppedTicks < 0) {\n      this.stoppedTicks = 0;\n    }\n  }\n}","import { AABB, Facing } from \"../../base/math\";\nimport { MapEntityArcher } from \"../../map/interfaces\";\nimport imgArcher from \"../../assets/entity/archer.png\";\nimport imgSkeletonArcher from \"../../assets/entity/skeleton-archer.png\";\nimport { Texture, textureManager } from \"../../render/TextureManager\";\nimport LevelScene from \"../../scene/LevelScene\";\nimport PlatformWalkGoal from \"../../ai/PlatformWalkGoal\";\nimport Mob, { DamageSource } from \"../Mob\";\nimport Arrow from \"../projectile/Arrow\";\nimport { FrameSequence } from \"../../render/Animation\";\nimport StateMachine from \"../StateMachine\";\nimport { ItemFlower } from \"../Item\";\n\nlet textureArcher: Texture;\nlet textureSkeletonArcher: Texture;\n\ntextureManager.loadTextures([\n  [\"entity/archer\", imgArcher],\n  [\"entity/skeleton-archer\", imgSkeletonArcher],\n]).then(textures => {\n  [textureArcher, textureSkeletonArcher] = textures;\n  textureArcher.defineClips([\n    [\"0\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\", \"8\"]\n  ], 8, 10);\n  textureSkeletonArcher.defineClips([\n    [\"0\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\", \"8\"]\n  ], 8, 10);\n});\n\nenum State {\n  idle = 0,\n  drawing = 1,\n  shot = 2\n}\n\nenum Variant {\n  normal = 0,\n  skeleton = 1\n}\n\nexport default class EnemyArcher extends Mob {\n  attackCooldown = 0;\n  attackSpeed = 30;\n\n  chargeTicks = 0;\n  chargeSpeed = 120;\n\n  platformWalkGoal = new PlatformWalkGoal(this);\n\n  variant: Variant;\n\n  state: StateMachine<State>;\n\n  constructor(data: MapEntityArcher) {\n    super(data, { maxHealth: 3 });\n\n    this.variant = data.skeleton ? Variant.skeleton : Variant.normal;\n\n    const texture = this.variant === Variant.normal ? \"entity/archer\" : \"entity/skeleton-archer\";\n\n    this.state = new StateMachine<State>([\n      [State.idle, {\n        next: State.idle,\n        animation: FrameSequence.fromClipRanges(texture, [\n          [\"0\", 40],\n          [\"1\", 20]\n        ]).setLoop(true)\n      }],\n      [State.drawing, {\n        next: State.idle,\n        animation: FrameSequence.fromClipRanges(texture, [\n          [\"1\", 10],\n          [\"2\", 10],\n          [\"3\", 90],\n          [\"4\", 10]\n        ])\n      }],\n      [State.shot, {\n        next: State.idle,\n        animation: FrameSequence.fromClipRanges(texture, [\n          [\"5\", 6],\n          [\"3\", 6],\n          [\"6\", 6],\n          [\"7\", 6],\n          [\"8\", 6]\n        ])\n      }]\n    ], State.idle);\n  }\n\n  get collisionBoxR() {\n    return this.variant === Variant.normal ? new AABB(-5, -10, 3, 0) : new AABB(-3, -10, 3, 0);\n  }\n\n  getRenderInfoR() {\n    return {\n      box: this.variant === Variant.normal ? new AABB(-5, -10, 3, 0) : new AABB(-3, -10, 5, 0),\n      texture: this.state.animation.current()\n    }\n  }\n\n  tick(scene: LevelScene) {\n    const { player } = scene;\n\n    this.applyFriction(this.onGround ? 0.75 : 0.25);\n\n    this.platformWalkGoal.keepDistance(scene, player, this.onGround ? 0.75 : 0.25, 0.6, 40, 80);\n\n    if (this.attackCooldown > 0) {\n      this.attackCooldown--;\n    } else {\n      const shootPos = this.coordByFacing2(4, -6);\n      const playerBox = player.hurtBox;\n      let deltaX = player.x - this.x;\n      let playerInReach = Math.abs(deltaX) <= 160;\n      let canShoot = playerBox.vertical.contains(shootPos.y);\n      let shot = false;\n  \n      if (playerInReach) {\n        this.chargeTicks++;\n        if (this.chargeTicks >= this.chargeSpeed) {\n          if (canShoot) {\n            scene.addEntity(new Arrow(shootPos, this, 1, deltaX > 0 ? Facing.right : Facing.left));\n            this.attackCooldown = this.attackSpeed;\n            this.chargeTicks = 0;\n            shot = true;\n          } else {\n            this.chargeTicks = this.chargeSpeed;\n          }\n        }\n      } else {\n        this.chargeTicks -= 2;\n        if (this.chargeTicks < 0) this.chargeTicks = 0;\n      }\n\n      if (shot) {\n        this.state.set(State.shot);\n      } else if (this.chargeTicks > 0) {\n        this.state.set(State.drawing, this.chargeTicks - 1);\n      } else {\n        this.state.set(State.idle);\n      }\n    }\n\n    this.state.next();\n\n    super.tick(scene);\n  }\n\n  die(scene: LevelScene, source: DamageSource) {\n    if (this.tags.includes(\"witch-summon\")) {\n      ItemFlower.trySpawnAt(scene, this.collisionBox.center, 0.25, 0.45);\n    }\n    super.die(scene, source);\n  }\n}","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAADCAYAAACuyE5IAAAAAXNSR0IArs4c6QAAAEJJREFUCJl1zCEVgDAABcDDM0mARQCHpAiWACRclVkk+I/nPS7ASZLWWnz03gMDnPuabangem7TWJT5UGvlb0gSeAHvVxzEe7h+PwAAAABJRU5ErkJggg==\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAAAKCAYAAAAXfRggAAAAAXNSR0IArs4c6QAAAktJREFUSInFlLFrE1Ecx78vpLYOR7jkHExC6FWIgzbNUBwa3XsWCk463OBioVOcCg5OHQqZ7GKhk0MGOxUEe+Af0EEc2qKDhZgOlyxpOI4bRCucg/4ev7t7SRBM8pty93nf3/v+vvfyBKIVst8CyRo3H1UT95fmsHu4Ix/yj14kxGPmSoPT9scDQuC3cePWssr4JPjIAKfhL8UftIw5UDwJHvhtzBk5zBm5qeyv4vIYr20u8eON93unkSP+v7l+0UfTcfmasHu4I8PJPthI6H0vQEbXZH/bKobUY1z+03xzKjIRF9MaFSe2mF39+/Z0KN9zXotGvRpu7Z4IALj/ZAHPPryFqri+JGqyf6VsAI6r7G9b/Uh4g7yPmj9Fg2d0DRldw2J2lZn4U74XyDWDODXudjryvW0VZbDUHwC6nQ6+vtkIz84vpUHSlEQNJVGDbRXDRr2q/DBxvap/03EF1xNPd+elf5W/+HzyDtIv+iiJGp7f+xUR81RJOGgNAOQLBckrZQMA4LZ68L1A6vOFAm4/3RfE+dejAV8+fggKgIen0gPAl0/fIpwHyPUqf/H+fL7U2uZS6LZ68OZzMGeOsX1wBHPmGPx4uq0eACBov5NrGvVq2HRcQZwH+OpjGrZVDLd2T0T8v01FHABanzuJALYPjlApG4m7gdfZ+aX0d2d5IcIoQO6fKu5v2Hwp3wvw4/tPAED7agWauY721YpsRtz3Ask0cx00HNfzTSjgOKcifvPubDh7/VribqA9ht0dTccVg/pTAP/iTzXfb2ZJyUAbKvNkAAAAAElFTkSuQmCC\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAAAKCAYAAAAXfRggAAAAAXNSR0IArs4c6QAAAZlJREFUSInFlbFKw1AUhv8bEIuFVsExFLHgppSik3LBzUCgTuEOwVdoXHyILrG6iFuhky/Q/T5AEXFyCCKhkyAIDi4el94Sb26alpr2QpZ85/znP38SwkBeUL/9DDE+1eomhhc/l2AP1wBQOM87K/ZnKbBRKuHj9CTTZ5G8fnNG6mr2BC17/jRuKbi2XsLO8DmzuTBOXpAyOL63lPkzcIC8oNkTBPIC3dx/88O7I9LZ/v05NXticqU0NH3fsVMahfoHACEEdcPQ+HovyjnnJIQgzjkBQKfdmGvB3P6C/U9MZMIZuapJPeEE55yTzpMB+I5NpgCm9ev+8vg8+1lJsW4YpobncXW2KpXJoIO9bSOXUjIpJdO5lJKNRiMAwNvXLp5e3ufqV1wtqXPfsSnJ59nP6g9i1mk3qFaO8P3aQ38Qs2RBHtdN1soRrrqPxpqW65Lv2GTiKoBaOUotmOwHYAxQaZj0+4OYHddj1MoROu3GnxBm3k8I8+9V51l16tPI4nn9LdclFcAq5ufxqQElmaluES6EoCL1F+W/hgXBRLYFRzYAAAAASUVORK5CYII=\"","import { MapBackground, MapBackgroundAxis } from \"../map/interfaces\";\nimport { RendererContext } from \"../render/Renderer\";\nimport { TextureLike, textureManager } from \"../render/TextureManager\";\nimport LevelScene from \"./LevelScene\";\nimport { SCENE_HEIGHT, SCENE_WIDTH } from \"./Scene\";\nimport imgBgForest1 from \"../assets/background/forest1.png\";\nimport imgBgForest2 from \"../assets/background/forest2.png\";\nimport imgBgCloud from \"../assets/background/cloud.png\";\nimport imgBgCastle from \"../assets/background/castle.png\";\n\ntextureManager.loadTextures([\n  [\"bg/forest1\", imgBgForest1],\n  [\"bg/forest2\", imgBgForest2],\n  [\"bg/cloud\", imgBgCloud],\n  [\"bg/castle\", imgBgCastle]\n]);\n\nfunction lerp(a: number, b: number, k: number) {\n  return a + (b - a) * k;\n}\n\ninterface OffsetState {\n  textureSize: number;\n  cameraSize: number;\n  sceneSize: number;\n  cameraOffset: number;\n}\n\ninterface BackgroundPosition {\n  offset: number;\n  start: number;\n  end: number;\n}\n\nexport default class Background {\n  texture: TextureLike;\n  opacity: number;\n  horizontal: MapBackgroundAxis;\n  vertical: MapBackgroundAxis;\n\n  constructor(data: MapBackground) {\n    this.texture = textureManager.get(data.picture);\n    this.opacity = data.opacity;\n    this.horizontal = data.horizontal;\n    this.vertical = data.vertical;\n  }\n\n  getPosition(params: MapBackgroundAxis, state: OffsetState): BackgroundPosition {\n    if (params.repeat) {\n      let offset = Math.round(params.offset + state.cameraOffset * params.factor);\n      let start = Math.floor(offset / state.textureSize);\n      let end = Math.ceil((offset + state.cameraSize) / state.textureSize);\n      return { offset, start, end };\n    } else {\n      let offset = Math.round(lerp(params.marginL,\n        state.cameraSize - params.marginR - state.textureSize,\n        state.cameraOffset / (state.sceneSize - state.cameraSize)));\n      return { offset, start: 0, end: 1 };\n    }\n  }\n\n  render(rctx: RendererContext, scene: LevelScene) {\n    const { camera } = scene;\n\n    let textureWidth = this.texture.width;\n    let textureHeight = this.texture.height;\n\n    let positionX = this.getPosition(this.horizontal, {\n      textureSize: textureWidth,\n      cameraSize: SCENE_WIDTH,\n      sceneSize: scene.width,\n      cameraOffset: camera.offset.x\n    });\n    let positionY = this.getPosition(this.vertical, {\n      textureSize: textureHeight,\n      cameraSize: SCENE_HEIGHT,\n      sceneSize: scene.height,\n      cameraOffset: camera.offset.y\n    });\n\n    rctx.run(({ ctx }) => {\n      ctx.translate(-positionX.offset, -positionY.offset);\n      ctx.globalAlpha = this.opacity;\n      for (let x = positionX.start; x < positionX.end; x++) {\n        for (let y = positionY.start; y < positionY.end; y++) {\n          this.texture.drawTo(rctx, x * textureWidth, y * textureHeight);\n        }\n      }\n    });\n  }\n}\n","export default \"data:image/png;base64,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\"","export default \"data:image/png;base64,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\"","export default \"data:image/png;base64,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\"","export default \"data:image/png;base64,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\"","import { AABB } from \"../base/math\";\nimport { MapLandmark } from \"../map/interfaces\";\n\nexport default class Landmark {\n  box: AABB;\n  tags: string[];\n\n  constructor(data: MapLandmark) {\n    this.box = AABB.offset(data.x, data.y, data.width, data.height);\n    this.tags = data.tags;\n  }\n}","import { Coord } from \"../base/math\";\nimport { MapSpawnPoint } from \"../map/interfaces\";\nimport { RendererContext } from \"../render/Renderer\";\n\nexport default class SpawnPoint {\n  position: Coord;\n  tags: string[];\n\n  constructor(data: MapSpawnPoint) {\n    this.position = new Coord(data.x, data.y);\n    this.tags = data.tags;\n  }\n\n  get effectBox() {\n    return this.position.expand(8, 40, 8, 8);\n  }\n\n  render(rctx: RendererContext) {\n    rctx.run(({ ctx, pixelSize, debug }) => {\n      if (debug) {\n        const { effectBox: box } = this;\n        ctx.lineWidth = 2 / pixelSize;\n        ctx.strokeStyle = '#e345d7';\n        ctx.strokeRect(box.left, box.top, box.width, box.height);\n      }\n    });\n  }\n}","import { Coord } from \"../base/math\";\nimport { ForwardAnimation, GeneratorAnimation } from \"../render/Animation\";\n\ninterface FocusCircleData {\n  center: Coord;\n  radius: number;\n}\n\nexport default abstract class FocusCircle implements ForwardAnimation<FocusCircleData> {\n  radiusGenerator = new GeneratorAnimation(this.generateRadius());\n\n  constructor(public center: Coord) {}\n\n  abstract generateRadius(): Generator<number>;\n\n  current() {\n    return {\n      center: this.center.clone(),\n      radius: this.radiusGenerator.current()\n    };\n  }\n\n  next() {\n    return this.radiusGenerator.next();\n  }\n}\n\nexport class OpeningFocusCircle extends FocusCircle {\n  *generateRadius() {\n    let radius = 0;\n    for (let i = 0; i < 12; i++) {\n      radius += (36 - radius) * 0.2;\n      yield radius;\n    }\n    for (let i = 0; i < 36; i++)\n      yield radius;\n    let step = (360 - radius) / 24;\n    for (let i = 0; i < 24; i++) {\n      radius += step;\n      yield radius;\n    }\n  }\n}\n\nexport class DespawningFocusCircle extends FocusCircle {\n  *generateRadius() {\n    let radius = 360;\n    for (let i = 0; i < 36; i++) {\n      radius -= (radius - 36) * 0.15;\n      yield radius;\n    }\n    for (let i = 0; i < 12; i++)\n      yield radius;\n    let step = radius / 12;\n    for (let i = 0; i < 12; i++) {\n      radius -= step;\n      yield radius;\n    }\n  }\n}\n\nexport class RespawningFocusCirle extends FocusCircle {\n  *generateRadius() {\n    let radius = 0;\n    let step = 360 / 40;\n    for (let i = 0; i < 40; i++) {\n      radius += step;\n      yield radius;\n    }\n  }\n}","import { MapTrigger, MapTriggerType } from \"../map/interfaces\";\nimport LevelScene from \"./LevelScene\";\nimport { STRINGS } from \"./Subtitle\";\n\nexport default abstract class Trigger {\n  triggered = false;\n\n  constructor(public id: string) {}\n\n  static create(data: MapTrigger): Trigger {\n    switch (data.condition.type) {\n      case MapTriggerType.reachPlace:\n        return new TriggerReachPlace(data.id, data.condition.landmarkTag);\n\n      case MapTriggerType.entityKilled:\n        return new TriggerEntityKilled(data.id, data.condition.entityTag);\n\n      default:\n        throw new Error(`unknown trigger type: id=${data.id}`);\n    }\n  }\n\n  abstract checkCondition(scene: LevelScene): boolean;\n\n  tick(scene: LevelScene) {\n    if (!this.triggered && this.checkCondition(scene)) {\n      this.triggered = true;\n      this.execute(scene);\n    }\n  }\n\n  execute(scene: LevelScene) {\n    console.log(`triggered: ${this.id}`);\n    switch (this.id) {\n      case \"level1:1\":\n        scene.boundary.right = scene.getLandmark(\"L2\").box.right;\n        scene.showSubtitle(STRINGS[\"first-enemy\"], 150);\n        break;\n      case \"level1:2\":\n        scene.boundary.right = scene.getLandmark(\"L4\").box.right;\n        break;\n      case \"level1:3\": {\n        const { box } = scene.getLandmark(\"L3\");\n        scene.boundary.left = box.left;\n        scene.boundary.bottom = box.bottom;\n        scene.boundary.right = scene.getLandmark(\"L5\").box.right;\n        break;\n      }\n      case \"level1:4\":\n        scene.boundary.right = scene.getLandmark(\"L6\").box.right;\n        break;\n      case \"level1:5\":\n        scene.boundary.right = scene.getLandmark(\"L9\").box.right;\n        break;\n      case \"level1:6\":\n        scene.boundary.left = scene.getLandmark(\"L7\").box.left;\n        break;\n      case \"level1:7\":\n        scene.boundary.right = scene.width;\n        break;\n      case \"level1:8\":\n        scene.levelComplete();\n        break;\n      case \"level1:9\":\n        scene.showSubtitle(STRINGS[\"level1-start\"], 180);\n        break;\n      case \"level1:10\":\n        scene.showSubtitle(STRINGS[\"flower\"], 120);\n        break;\n      case \"level1:11\":\n        scene.showSubtitle(STRINGS[\"level1-end\"], 240);\n        break;\n\n      default:\n        console.warn(`unknown trigger id: ${this.id}`);\n    }\n  }\n}\n\nexport class TriggerReachPlace extends Trigger {\n  constructor(id: string, public landmarkTag: string) {\n    super(id);\n  }\n\n  checkCondition(scene: LevelScene) {\n    return scene.getLandmarksWithTag(this.landmarkTag)\n      .some(landmark => scene.player.collisionBox.intersects(landmark.box));\n  }\n}\n\nexport class TriggerEntityKilled extends Trigger {\n  constructor(id: string, public entityTag: string) {\n    super(id);\n  }\n\n  checkCondition(scene: LevelScene) {\n    return scene.getEntitiesWithTag(this.entityTag).length === 0;\n  }\n}","import { AABB, Coord, Facing } from \"../../base/math\";\nimport Mob, { DamageSource } from \"../Mob\";\nimport imgWitch from \"../../assets/entity/witch.png\";\nimport imgWitchCurse from \"../../assets/entity/witch-curse.png\";\nimport imgWitchSummon from \"../../assets/entity/witch-summon.png\";\nimport { Texture, textureManager } from \"../../render/TextureManager\";\nimport { MapEntity, MapEntityArcher, MapEntityScout, MapEntityType } from \"../../map/interfaces\";\nimport LevelScene from \"../../scene/LevelScene\";\nimport StateMachine from \"../StateMachine\";\nimport { FrameSequence } from \"../../render/Animation\";\nimport { RendererContext } from \"../../render/Renderer\";\nimport { WitchTeleport } from \"../Particle\";\nimport { Terrain } from \"../Terrain\";\nimport { STRINGS } from \"../../scene/Subtitle\";\n\nlet textureWitch: Texture;\nlet textureWitchCurse: Texture;\nlet textureWitchSummon: Texture;\n\ntextureManager.loadTextures([\n  [\"entity/witch\", imgWitch],\n  [\"entity/witch-curse\", imgWitchCurse],\n  [\"entity/witch-summon\", imgWitchSummon],\n]).then(textures => {\n  [textureWitch, textureWitchCurse, textureWitchSummon] = textures;\n  textureWitch.defineClips([\n    [\"0\"]\n  ], 16, 20);\n  textureWitchCurse.defineClips([\n    [\"0\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\", \"8\", \"9\"]\n  ], 16, 20);\n  textureWitchSummon.defineClips([\n    [\"0\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\"]\n  ], 16, 20);\n});\n\nconst\n  CURSE_MAX_RANGE = 128,\n  CURSE_PREPARE_TICKS = 180,\n  CURSE_DAMAGE_TICKS = 120,\n  CURSE_DAMAGE = 1,\n  CURSE_IMPULSE_POWER = 4,\n  CURSE_IMPULSE_TICKS = 3,\n  CURSE_COOLDOWN_TICKS = 90,\n  SUMMON_PREPARE_TICKS = 120,\n  SUMMON_COOLDOWN_TICKS = 90,\n  TELEPORT_COOLDOWN_TICKS = 120,\n  INITIAL_COOLDOWN_TICKS = 120,\n  MIN_SUMMON_DISTANCE = 48,\n  MAX_SUMMON_DISTANCE = 96,\n  MIN_TELEPORT_DISTANCE = 56,\n  MIN_TELEPORT_LENGTH = 80,\n  MAX_TELEPORT_LENGTH = 280,\n  DAMAGE_REBOUNCE_POWER = 2.5,\n  DAMAGE_REBOUNCE_TICKS = 3;\n\nenum State {\n  idle = 0,\n  cursing = 1,\n  summoning = 2\n}\n\nexport default class EnemyWitch extends Mob {\n  state = new StateMachine<State>([\n    [State.idle, {\n      next: State.idle,\n      animation: FrameSequence.fromClips(\"entity/witch\", [\"0\"])\n    }],\n    [State.cursing, {\n      next: State.idle,\n      animation: FrameSequence.fromClipRanges(\"entity/witch-curse\", [\n        [\"0\", 18],\n        [\"1\", 18],\n        [\"2\", 18],\n        [\"3\", 18],\n        [\"4\", 18],\n        [\"5\", 18],\n        [\"6\", 18],\n        [\"7\", 18],\n        [\"8\", 18],\n        [\"9\", 18],\n        [\"9\", CURSE_DAMAGE_TICKS],\n      ])\n    }],\n    [State.summoning, {\n      next: State.idle,\n      animation: FrameSequence.fromClipRanges(\"entity/witch-summon\", [\n        [\"0\", 15],\n        [\"1\", 15],\n        [\"2\", 15],\n        [\"3\", 15],\n        [\"4\", 15],\n        [\"5\", 15],\n        [\"6\", 15],\n        [\"7\", 15],\n      ])\n    }],\n  ], State.idle);\n\n  curseTicks = 0;\n  summonTicks = 0;\n  cooldownTicks = INITIAL_COOLDOWN_TICKS;\n  damageCount = 0;\n\n  curseTarget: Coord | null = null;\n\n  constructor(data: MapEntity) {\n    super(data, { maxHealth: 20 });\n  }\n\n  get collisionBoxR() {\n    return new AABB(-12, -20, 4, 0);\n  }\n\n  getRenderInfoR() {\n    return {\n      box: new AABB(-12, -20, 4, 0),\n      texture: this.state.animation.current()\n    };\n  }\n\n  tick(scene: LevelScene) {\n    const { player } = scene;\n    const center = this.collisionBox.center;\n    const vector = player.collisionBox.center.diff(center);\n    const distance = vector.length;\n\n    this.applyFriction(this.onGround ? 0.75 : 0.25);\n\n    switch (this.state.current) {\n      case State.idle: {\n        if (this.cooldownTicks > 0) {\n          this.cooldownTicks--;\n        } else {\n          let seed = Math.random() * 100;\n          if (seed < 15) {\n            if (distance < 0.9 * CURSE_MAX_RANGE) {\n              this.state.set(State.cursing);\n            }\n          } else if (seed < 23) {\n            if (scene.getEntitiesWithTag(\"witch-summon\").length < 18)\n              this.state.set(State.summoning);\n          } else if (seed < 25) {\n            this.teleport(scene);\n          }\n        }\n        break;\n      }\n\n      case State.cursing: {\n        if (distance > CURSE_MAX_RANGE) {\n          this.abort();\n        } else {\n          this.curseTarget = player.collisionBox.center;\n          if (this.curseTicks < CURSE_PREPARE_TICKS) {\n            // Preparing Curse\n            this.state.set(State.cursing, this.curseTicks);\n          } else {\n            // Cursing\n            let cursePeriodTicks = (this.curseTicks - CURSE_PREPARE_TICKS) % CURSE_DAMAGE_TICKS;\n\n            if (cursePeriodTicks === 0) {\n              if (player.damage(scene, CURSE_DAMAGE, this)) {\n                player.knockback(player.position, player.x > this.x ? Facing.right : Facing.left,\n                  CURSE_IMPULSE_POWER, CURSE_IMPULSE_TICKS);\n              }\n            }\n\n            this.state.set(State.cursing, CURSE_PREPARE_TICKS + cursePeriodTicks);\n          }\n          this.curseTicks++;\n        }\n        break;\n      }\n\n      case State.summoning: {\n        if (this.summonTicks >= SUMMON_PREPARE_TICKS) {\n          let types = [MapEntityType.scout, MapEntityType.archer];\n          if (scene.getEntitiesWithTag(\"witch-summon\").length >= 10)\n            types.splice(Math.floor(Math.random() * 2), 1);\n\n          let results = types.map(x => this.summon(scene, x));\n          if (results.some(x => x)) {\n            this.abort();\n          }\n        } else {\n          this.state.set(State.summoning, this.summonTicks);\n          this.summonTicks++;\n        }\n        break;\n      }\n    }\n\n    super.tick(scene);\n  }\n\n  teleport(scene: LevelScene): boolean {\n    const choices = scene.getLandmarksWithTag(\"tp\");\n    if (!choices.length) {\n      console.warn(\"failed to teleport\");\n      return false;\n    }\n\n    for (let i = 0; i < 20; i++) {\n      const { box } = choices[Math.floor(Math.random() * choices.length)];\n      let newPos = new Coord(\n        box.left + Math.random() * (box.right - box.left),\n        box.bottom\n      );\n\n      let length = newPos.diff(this.position).length;\n      if (length < MIN_TELEPORT_LENGTH || length > MAX_TELEPORT_LENGTH)\n        continue;\n\n      if (newPos.diff(scene.player.position).length < MIN_TELEPORT_DISTANCE)\n        continue;\n\n      scene.addParticle(new WitchTeleport(this.collisionBox.center));\n      this.position.set(newPos);\n      scene.addParticle(new WitchTeleport(this.collisionBox.center));\n\n      this.cooldownTicks = TELEPORT_COOLDOWN_TICKS;\n      scene.onTickEnd(() => {\n        this.velocity.reset();\n        this.impulseTicks = 0;\n      });\n      return true;\n    }\n\n    return false;\n  }\n\n  summon(scene: LevelScene, type: MapEntityType): boolean {\n    const choices = scene.getLandmarksWithTag(\"summon\");\n    if (!choices.length) {\n      console.warn(\"failed to summon\");\n      return false;\n    }\n\n    for (let i = 0; i < 20; i++) {\n      const { box } = choices[Math.floor(Math.random() * choices.length)];\n\n      let data: MapEntityScout | MapEntityArcher = {\n        x: box.left + Math.random() * (box.right - box.left),\n        y: box.bottom,\n        tags: [\"witch-summon\", \"enemy\"],\n        type,\n        skeleton: Math.random() < 0.5\n      };\n      let mob = scene.createEntity(data)!;\n\n      // Should not be too close to player\n      let distance = mob.position.diff(scene.player.position).length;\n      if (distance < MIN_SUMMON_DISTANCE || distance > MAX_SUMMON_DISTANCE)\n        continue;\n\n      if (data.skeleton && !scene.skeletonSummoned) {\n        scene.skeletonSummoned = true;\n        scene.showSubtitle(STRINGS[\"level2-start\"], 180);\n      }\n  \n      scene.addEntity(mob);\n  \n      return true;\n    }\n\n    return false;\n  }\n\n  abort() {\n    switch (this.state.current) {\n      case State.cursing:\n        this.curseTicks = 0;\n        this.cooldownTicks = CURSE_COOLDOWN_TICKS;\n        this.state.set(State.idle);\n        this.curseTarget = null;\n        break;\n      case State.summoning:\n        this.summonTicks = 0;\n        this.cooldownTicks = SUMMON_COOLDOWN_TICKS;\n        this.state.set(State.idle);\n        break;\n    }\n  }\n\n  onDamage(scene: LevelScene, amount: number, source: DamageSource) {\n    this.damageCount++;\n\n    const { player } = scene;\n\n    if (source === player) {\n      player.knockback(player.position, player.x > this.x ? Facing.right : Facing.left,\n        DAMAGE_REBOUNCE_POWER, DAMAGE_REBOUNCE_TICKS);\n    }\n\n    let seed = Math.random();\n    if (source instanceof Terrain || seed < Math.pow(0.6, 6 - this.damageCount)) {\n      if (this.teleport(scene)) {\n        this.damageCount = 0;\n        if (this.state.current !== State.idle) {\n          this.abort();\n        }\n      }\n    }\n  }\n\n  render(rctx: RendererContext) {\n    super.render(rctx);\n    if (this.state.current === State.cursing && this.curseTarget) {\n      const center = this.collisionBox.center;\n\n      rctx.run(({ ctx }) => {\n        if (this.curseTicks < CURSE_PREPARE_TICKS) {\n          let total = 8;\n          let solid = total * (1 - Math.cos(this.curseTicks / CURSE_PREPARE_TICKS * Math.PI)) / 2;\n          ctx.setLineDash([solid, total - solid]);\n          ctx.lineDashOffset = solid / 2;\n        }\n        ctx.strokeStyle = `hsl(${this.curseTicks / CURSE_PREPARE_TICKS * 360}, 100%, 50%)`;\n        ctx.lineWidth = 0.9 - 0.3 * Math.cos(this.curseTicks / CURSE_DAMAGE_TICKS * 2 * Math.PI);\n\n        ctx.beginPath();\n        ctx.moveTo(center.x, center.y);\n        ctx.lineTo(this.curseTarget!.x, this.curseTarget!.y);\n        ctx.stroke();\n      });\n\n      rctx.run(({ ctx }) => {\n        if (this.curseTicks >= CURSE_PREPARE_TICKS) {\n          ctx.strokeStyle = '#f3f';\n          ctx.lineWidth = 0.8 + 0.2 * Math.sin(this.curseTicks / 60 * Math.PI);\n          ctx.fillStyle = 'rgba(255, 0, 255, 0.1)';\n\n          ctx.beginPath();\n          ctx.arc(center.x, center.y, CURSE_MAX_RANGE, 0, 2 * Math.PI);\n          ctx.stroke();\n          ctx.fill();\n        }\n      });\n    }\n  }\n\n  die(scene: LevelScene, source: DamageSource) {\n    scene.onBossDie(this);\n    super.die(scene, source);\n  }\n}","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAUCAYAAACEYr13AAAAAXNSR0IArs4c6QAAAbFJREFUOI19kjFII0EUhr8JKS4hEG5cwmFhc3JwkPqsbAKCKQLbiGUQPPWagysOlLRKAhaCjSZekzKk0C5WNhZWgoVwjVxhYWFkIBgMnAdzhZnNzO7oD8vOvsf/vTdvnwDI0NBYGrEpzHl/o6YBHkdPUf72/o6ZwjS19p5IZ2jofPqCh6UTAIJuCP8a2oa8pRTAw9IJQTck6IYRyK5u6/b+LgnwyTab9lfCAs1eh2av4wJMZdMJwM3hDo+jJ+fu74Ip0B/5sv2JWntPAIjvoI9oONW/sklRSvqVahT7tvo50aWcXxNpY7BVlPK1mzlmgFRRSsxjm+3qAAe/fntBYr28rJu9jmhJqa+VSnRgg67+TCDd89OXGZhAS0oNYCBx0OXcAgBqOPADbIgPVBp/b80vOl04e9CvVKOW47M5G7/r56fODLyL1K9UuZxboKRUVNmGyFwemcvjXGGn+sNZW3tlf443zwBKSpE9rk8Atjm+63GIrexxHeEzm0nLXN45x2GzMBmiz2z04X0Q5dRwwG55GYAb0Km3zGo4cM52zkASf8GubPT3+TkRM0q9NjSffPD/jq7AEyf1yMwAAAAASUVORK5CYII=\"","export default \"data:image/png;base64,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\"","export default \"data:image/png;base64,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\"","import { AABB, Coord, Facing, Vector } from \"../base/math\";\nimport Scene, { SCENE_HEIGHT, SCENE_WIDTH } from \"./Scene\";\nimport Entity from \"../model/Entity\";\nimport Player from \"../model/Player\";\nimport { RendererContext } from \"../render/Renderer\";\nimport GameManager from \"../GameManager\";\nimport { MapData, MapEntity, MapEntityItem, MapEntityPlayer, MapEntityType, TERRAIN_SIZE } from \"../map/interfaces\";\nimport { Terrain } from \"../model/Terrain\";\nimport Camera from \"./Camera\";\nimport EnemyScout from \"../model/enemy/Scout\";\nimport EnemyGuard from \"../model/enemy/Guard\";\nimport SelectMenu from \"./SelectMenu\";\nimport Decoration from \"../model/Decoration\";\nimport Subtitle, { STRINGS } from \"./Subtitle\";\nimport EnemyArcher from \"../model/enemy/Archer\";\nimport imgHealth from \"../assets/hud/health.png\";\nimport { Texture, textureManager } from \"../render/TextureManager\";\nimport Background from \"./Background\";\nimport Landmark from \"./Landmark\";\nimport SpawnPoint from \"./SpawnPoint\";\nimport FocusCircle, { DespawningFocusCircle, OpeningFocusCircle, RespawningFocusCirle } from \"./FocusCircle\";\nimport { ForwardAnimation, GeneratorAnimation } from \"../render/Animation\";\nimport Trigger from \"./Trigger\";\nimport EntityItem from \"../model/Item\";\nimport Particle, { WitchTeleport } from \"../model/Particle\";\nimport EnemyWitch from \"../model/enemy/Witch\";\nimport Mob from \"../model/Mob\";\n\nlet textureHealth: Texture;\n\ntextureManager.loadTextures([\n  [\"hud/health\", imgHealth]\n]).then(textures => {\n  [textureHealth] = textures;\n  textureHealth.defineClips([['5', '4', '3', '2', '1', '0']], 32, 32);\n});\n\ninterface MenuItem {\n  action: string;\n  text: string;\n  disabled: boolean;\n}\n\ntype TickEndHandler = (scene: LevelScene) => void;\n\nexport default class LevelScene extends Scene {\n  /** Scene width (map.width * TERRAIN_SIZE) */\n  width!: number;\n  /** Scene height (map.height * TERRAIN_SIZE) */\n  height!: number;\n\n  terrains!: (Terrain | null)[][];\n  player!: Player;\n  entities!: Entity[];\n  decorations!: Decoration[];\n  backgrounds!: Background[];\n  landmarks!: Landmark[];\n  spawnPoints!: SpawnPoint[];\n  spawnPoint!: Coord;\n  triggers!: Trigger[];\n  particles!: Particle[];\n\n  tickEndHandlers: TickEndHandler[] = [];\n\n  /** used for block player's move before tasks finished */\n  boundary!: AABB;\n\n  camera!: Camera;\n  subtitle!: Subtitle;\n\n  focusCircle: FocusCircle | null = null;\n\n  /** whether the player is despawning */\n  despawning = false;\n  won = false;\n  animation: ForwardAnimation<void> | null = null;\n\n  /** Ticks passed since level started, reset when retry */\n  ticks: number = 0;\n  /** Ticks passed since scene created */\n  totalTicks: number = 0;\n  /** Ticks left to pause when trigger skills */\n  pauseTicks: number = 0;\n\n  tickTime = 0;\n\n  skeletonSummoned = false;\n  skeletonDroppedFlower = false;\n  playerFallenIntoWater = false;\n\n  paused = false;\n  pauseMenu: SelectMenu<MenuItem> | null = null;\n  gameOverMenu: SelectMenu<MenuItem> | null = null;\n  gameCompletedMenu: SelectMenu<MenuItem> | null = null;\n\n  constructor(gameManager: GameManager, private map: MapData) {\n    super(gameManager);\n\n    this.init();\n\n    this.listenAllKeys((...args) => this.player.receiveInput(this, ...args));\n    this.listenKey(\"ui.pause\", event => {\n      if (event === \"down\" && !this.gameOverMenu && !this.gameCompletedMenu) this.togglePause();\n    });\n  }\n\n  cleanup() {\n    this.pauseMenu?.cleanup();\n  }\n\n  get mapWidth() { return this.map.width; }\n  get mapHeight() { return this.map.height; }\n\n  /**\n   * Initialize scene using data specified in the level map.\n   * Called on creation and retrials.\n   */\n  init() {\n    const { map } = this;\n\n    this.width = map.width * TERRAIN_SIZE;\n    this.height = map.height * TERRAIN_SIZE;\n\n    this.terrains = map.terrain.map((row, y) => row.map((cell, x) => Terrain.create(x, y, cell)));\n    this.entities = [];\n    for (const data of map.entities) {\n      const entity = this.createEntity(data);\n      if (entity) {\n        this.entities.push(entity);\n        if (entity.isPlayer())\n          this.player = entity;\n      }\n    }\n    if (!this.player)\n      throw new Error(\"player not found in map\");\n    this.player.outOfControlTicks = 30;\n\n    this.decorations = map.decorations.map(data => new Decoration(data));\n    this.backgrounds = map.backgrounds.map(data => new Background(data));\n    this.landmarks = map.landmarks.map(data => new Landmark(data));\n    this.spawnPoints = map.spawnPoints.map(data => new SpawnPoint(data));\n    this.spawnPoint = this.player.position.clone();\n    this.triggers = map.triggers.map(data => Trigger.create(data));\n    this.particles = [];\n\n    this.tickEndHandlers = [];\n\n    this.boundary = new AABB(0, 0, this.width, this.height);\n\n    this.camera = new Camera(this);\n    this.subtitle = new Subtitle(this);\n\n    this.despawning = false;\n    this.won = false;\n    this.animation = new GeneratorAnimation(this.animateOpening());\n\n    this.ticks = 0;\n  }\n\n  createEntity(data: MapEntity): Entity | null {\n    switch (data.type) {\n      case MapEntityType.player:\n        return new Player(data as MapEntityPlayer);\n\n      case MapEntityType.scout:\n        return new EnemyScout(data as MapEntity);\n\n      case MapEntityType.guard:\n        return new EnemyGuard(data as MapEntity);\n\n      case MapEntityType.archer:\n        return new EnemyArcher(data as MapEntity);\n\n      case MapEntityType.witch:\n        return new EnemyWitch(data as MapEntity);\n\n      case MapEntityType.item:\n        return EntityItem.create(data as MapEntityItem);\n\n      default:\n        console.warn(`unknown entity type: ${data.type}`);\n        return null;\n    }\n  }\n\n  getEntitiesWithTag(tag: string): Entity[] {\n    return this.entities.filter(entity => entity.tags.includes(tag));\n  }\n\n  getEntitiesInArea(box: AABB): Entity[] {\n    return this.entities.filter(entity => box.intersects(entity.collisionBox));\n  }\n\n  addEntity(entity: Entity) {\n    this.entities.push(entity);\n  }\n\n  deleteEntity(entity: Entity) {\n    this.entities = this.entities.filter(e => e !== entity);\n  }\n\n  shortPause(ticks: number) {\n    this.pauseTicks = ticks;\n  }\n\n  deleteTerrain({ x, y }: Coord) {\n    this.terrains[y][x] = null;\n  }\n\n  addParticle(particle: Particle) {\n    this.particles.push(particle);\n  }\n\n  deleteParticle(particle: Particle) {\n    this.particles = this.particles.filter(p => p !== particle);\n  }\n\n  getLandmark(tag: string) {\n    const landmark = this.landmarks.find(x => x.tags.includes(tag));\n    if (!landmark) throw new Error(`landmark not found: ${tag}`);\n    return landmark;\n  }\n\n  getLandmarksWithTag(tag: string) {\n    return this.landmarks.filter(landmark => landmark.tags.includes(tag));\n  }\n\n  setBoundary(box: AABB) {\n    this.boundary = box;\n  }\n\n  togglePause() {\n    if (this.paused) {\n      this.paused = false;\n      this.pauseMenu!.cleanup();\n      this.pauseMenu = null;\n    } else {\n      this.paused = true;\n      this.pauseMenu = new SelectMenu<MenuItem>(this, [\n        {\n          action: \"resume\",\n          text: \"\",\n          disabled: false\n        },\n        {\n          action: \"retry\",\n          text: \"\",\n          disabled: this.despawning || this.animation !== null || this.player.health <= 1\n        },\n        {\n          action: \"restart\",\n          text: \"\",\n          disabled: false\n        },\n        {\n          action: \"title\",\n          text: \"\",\n          disabled: false\n        }\n      ], ({ action }: MenuItem) => {\n        switch (action) {\n          case \"retry\":\n            this.retry();\n            break;\n          case \"restart\":\n            this.restart();\n            break;\n          case \"title\":\n            this.gameManager.backToTitle();\n            break;\n        }\n        this.togglePause();\n      })\n    }\n  }\n\n  *animateOpening() {\n    this.focusCircle = new OpeningFocusCircle(this.player.collisionBox.center);\n    do yield; while (!this.focusCircle.next());\n    this.focusCircle = null;\n  }\n\n  showSubtitle(text: string, ticks: number) {\n    this.subtitle.show({ text }, ticks);\n  }\n\n  rumble() {\n    this.camera.rumble();\n  }\n\n  onTickEnd(handler: TickEndHandler) {\n    this.tickEndHandlers.push(handler);\n  }\n\n  tick() {\n    const startTime = performance.now();\n    this.totalTicks++;\n    if (!this.paused) {\n      if (this.pauseTicks > 0) {\n        this.pauseTicks--;\n      } else {\n        if (this.animation?.next())\n          this.animation = null;\n\n        if (!this.despawning) {\n          // Terrain\n          for (const row of this.terrains)\n            for (const cell of row)\n              cell?.tick(this);\n  \n          // Entities\n          for (const entity of this.entities)\n            if (entity.collisionBox.intersects(this.boundary))\n              entity.tick(this);\n\n          // Particle\n          for (const particle of this.particles)\n            particle.tick(this);\n  \n          // Spawn Point\n          for (const spawnPoint of this.spawnPoints) {\n            if (spawnPoint.effectBox.intersects(this.player.collisionBox)) {\n              this.spawnPoint = spawnPoint.position.clone();\n            }\n          }\n\n          // Triggers\n          for (const trigger of this.triggers)\n            trigger.tick(this);\n\n          // Handlers\n          for (const handler of this.tickEndHandlers)\n            handler(this);\n          this.tickEndHandlers = [];\n\n          // Misc\n          this.camera.update();\n          this.ticks++;\n        }\n\n        this.subtitle.tick();\n      }\n    }\n    const endTime = performance.now();\n    this.tickTime = endTime - startTime;\n  }\n\n  onPlayerRespawn() {\n    this.animation = new GeneratorAnimation(this.animateRespawn());\n  }\n\n  *animateRespawn() {\n    this.despawning = true;\n    this.focusCircle = new DespawningFocusCircle(this.player.collisionBox.center);\n    do yield; while (!this.focusCircle.next());\n    for (let i = 0; i < 30; i++) yield;\n    this.player.respawn(this);\n    this.camera.update(true);\n    this.despawning = false;\n    this.focusCircle = new RespawningFocusCirle(this.player.collisionBox.center);\n    do yield; while (!this.focusCircle.next());\n    this.focusCircle = null;\n\n    if (this.won) {\n      for (let i = 0; i < 60; i++) yield;\n      yield* this.animateLevelComplete();\n    }\n  }\n\n  onBossDie(boss: EnemyWitch) {\n    this.won = true;\n    this.animation = new GeneratorAnimation(this.animateBossDie(boss));\n  }\n\n  *animateBossDie(boss: EnemyWitch) {\n    for (const entity of this.getEntitiesWithTag(\"witch-summon\")) {\n      const mob = entity as Mob;\n      this.addParticle(new WitchTeleport(mob.collisionBox.center));\n      mob.damage(this, Infinity, null, true);\n    }\n\n    let vector = this.player.position.diff(boss.position);\n    this.player.knockback(this.player.position, vector.x > 0 ? Facing.right : Facing.left,\n      250 / (50 + vector.length), 3);\n    this.player.outOfControlTicks = 600;\n\n    const center = boss.collisionBox.center;\n\n    this.showSubtitle(STRINGS[\"level2-end\"], 240);\n\n    for (let i = 0; i < 8; i++) {\n      let offset = i === 0 ? new Vector(0, 0) :\n        new Vector(Math.random() * 10 - 5, Math.random() * 10 - 5);\n      let particle = new WitchTeleport(center.plus(offset));\n      particle.velocity.x = offset.x / 8;\n      particle.velocity.y = offset.y / 8;\n      this.addParticle(particle);\n      for (let j = 0; j < 6; j++) yield;\n    }\n\n    while (this.subtitle.current) yield;\n    for (let i = 0; i < 20; i++) yield;\n    \n    yield* this.animateLevelComplete();\n  }\n\n  retry() {\n    this.player.damage(this, 1, null, true);\n  }\n\n  restart() {\n    this.init();\n  }\n\n  levelComplete() {\n    this.won = true;\n    this.animation = new GeneratorAnimation(this.animateLevelComplete());\n  }\n\n  *animateLevelComplete() {\n    this.despawning = true;\n    this.focusCircle = new DespawningFocusCircle(this.player.collisionBox.center);\n    do yield; while (!this.focusCircle.next());\n    for (let i = 0; i < 30; i++) yield;\n    this.gameManager.onLevelComplete(this.map.id);\n  }\n\n  gameOver() {\n    this.animation = new GeneratorAnimation(this.animateGameOver());\n  }\n\n  *animateGameOver() {\n    this.despawning = true;\n    this.focusCircle = new DespawningFocusCircle(this.player.collisionBox.center);\n    do yield; while (!this.focusCircle.next());\n    for (let i = 0; i < 20; i++) yield;\n    this.showSubtitle(STRINGS[\"game-over\"], 180);\n    while (this.subtitle.current) yield;\n    for (let i = 0; i < 20; i++) yield;\n    this.gameOverMenu = new SelectMenu<MenuItem>(this, [\n      {\n        action: \"restart\",\n        text: \"\",\n        disabled: false\n      },\n      {\n        action: \"title\",\n        text: \"\",\n        disabled: false\n      }\n    ], ({ action }) => {\n      this.gameOverMenu!.cleanup();\n      this.gameOverMenu = null;\n\n      switch (action) {\n        case \"restart\":\n          this.restart();\n          break;\n\n        case \"title\":\n          this.gameManager.backToTitle();\n          break;\n      }\n    });\n  }\n\n  gameComplete() {\n    this.gameCompletedMenu = new SelectMenu<MenuItem>(this, [\n      {\n        action: \"restart\",\n        text: \"\",\n        disabled: false\n      },\n      {\n        action: \"title\",\n        text: \"\",\n        disabled: false\n      }\n    ], ({ action }) => {\n      this.gameCompletedMenu!.cleanup();\n      this.gameCompletedMenu = null;\n\n      switch (action) {\n        case \"restart\":\n          this.gameManager.startGame();\n          break;\n\n        case \"title\":\n          this.gameManager.backToTitle();\n          break;\n      }\n    });\n  }\n\n  render(rctx: RendererContext) {\n    const { viewBox } = this.camera;\n\n    rctx.run(({ ctx }) => {\n      rctx.run(() => {\n        if (this.focusCircle) {\n          ctx.fillStyle = '#000';\n          ctx.fillRect(0, 0, SCENE_WIDTH, SCENE_HEIGHT);\n          const { center, radius } = this.focusCircle.current();\n          ctx.beginPath();\n          center.setMinus(this.camera.offset);\n          ctx.arc(center.x, center.y, radius, 0, 2 * Math.PI);\n          ctx.clip();\n        }\n        ctx.fillStyle = '#222';\n        ctx.fillRect(0, 0, SCENE_WIDTH, SCENE_HEIGHT);\n        for (const background of this.backgrounds)\n          background.render(rctx, this);\n        this.camera.render(rctx, () => {\n          this.renderTerrain(rctx);\n          for (const decoration of this.decorations)\n            if (decoration.getRenderInfo()?.box.intersects(viewBox))\n              decoration.render(rctx);\n          for (const spawnPoint of this.spawnPoints)\n            spawnPoint.render(rctx);\n          for (const entity of this.entities)\n            entity.render(rctx);\n          for (const particle of this.particles)\n            particle.render(rctx);\n        });\n        this.renderHud(rctx);\n      });\n      this.subtitle.render(rctx);\n      if (this.pauseMenu)\n        this.renderMenu(rctx, this.pauseMenu, \"\");\n      if (this.gameOverMenu)\n        this.renderMenu(rctx, this.gameOverMenu, \"\");\n      if (this.gameCompletedMenu)\n        this.renderMenu(rctx, this.gameCompletedMenu, \"\");\n    });\n  }\n\n  fitTerrain(box: AABB) {\n    return new AABB(\n      Math.max(0, Math.floor(box.left / TERRAIN_SIZE)),\n      Math.max(0, Math.floor(box.top / TERRAIN_SIZE)),\n      Math.min(this.map.width, Math.ceil(box.right / TERRAIN_SIZE)),\n      Math.min(this.map.height, Math.ceil(box.bottom / TERRAIN_SIZE))\n    );\n  }\n\n  renderTerrain(rctx: RendererContext) {\n    const box = this.fitTerrain(this.camera.viewBox);\n\n    for (let y = box.top; y < box.bottom; y++) {\n      const row = this.terrains[y];\n      for (let x = box.left; x < box.right; x++) {\n        row[x]?.render(rctx);\n      }\n    }\n  }\n\n  renderHud(rctx: RendererContext) {\n    rctx.run(({ ctx }) => {\n      // Health\n      let heartCount = Math.ceil(this.player.maxHealth / 5);\n      for (let i = 0; i < heartCount; i++) {\n        let value = Math.max(0, Math.min(5, this.player.health - 5 * i));\n        const clip = textureHealth.getClip('' + value);\n        clip.drawTo(rctx, 6 + 34 * i, 6);\n      }\n    });\n  }\n\n  renderMenu(rctx: RendererContext, menu: SelectMenu<MenuItem>, title: string) {\n    rctx.run(({ ctx }) => {\n      ctx.fillStyle = \"rgba(0, 0, 0, 0.75)\";\n      ctx.fillRect(0, 0, SCENE_WIDTH, SCENE_HEIGHT);\n\n      let x = SCENE_WIDTH / 2, y = 30;\n      const { selectedItem } = menu;\n\n      ctx.font = \"12.5px 'Noto Sans SC'\";\n      ctx.textAlign = \"center\";\n      ctx.textBaseline = \"top\";\n      ctx.shadowColor = \"#000\";\n      ctx.shadowBlur = 2;\n      ctx.fillStyle = \"#999\";\n      ctx.fillText(title, x, y);\n      y += 20;\n\n      ctx.font = \"5.25px 'Noto Sans SC'\";\n      for (const item of menu.getItems()) {\n        ctx.fillStyle = item === selectedItem ?\n          (this.totalTicks % 12 < 6 ? '#90d060' : '#f0e080') :\n          (item.disabled ? '#999' : '#eee');\n        ctx.fillText(item.text, x, y);\n        y += 10;\n      }\n    });\n  }\n\n  get debugText() {\n    return [\n      `Tick: ${this.tickTime.toFixed(1)} ms`,\n      `${this.width}*${this.height} | ${this.map.width}*${this.map.height} ${this.map.id}`,\n      `X: ${this.player.x.toFixed(1)} Y: ${this.player.y.toFixed(1)}`,\n      `Camera: (${this.camera.offset.x.toFixed(0)}, ${this.camera.offset.y.toFixed(0)})`,\n      `Health: ${this.player.health}/${this.player.maxHealth} Immune: ${this.player.immuneTicks}`,\n      `Entities: ${this.entities.length}`\n    ];\n  }\n}\n","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAgCAYAAABEmHeFAAAAAXNSR0IArs4c6QAABDVJREFUeJztnL9r20AUx78u/Qdsz6FDFo/OlAyhUykB0TF7/wCTQqCbcWnIVmhJ8B+QPWMQGI/BQzO1oxcPJbOSP0EdrFPene7OurOvqqT3BVFZurtPJL379e5dARaLxWK1Ux3fjMlgldLf/eW+d1k+OhuNJP71dMp85jvrtWsGYfi9vUS+jvX10BVBPPj7kxP1VgqE/xDMbxb/lc8fkRv/5zfrA8UKEVLi4aMoQhRF0jXmM99FTrUlGaxSyfipvv0BADw99oP1AmejUUofniqOYwDAfDYL1goxv3l8rx4gV2b0VUk8NPOZ7yv/CkCNv4KKQB++ig/B/Gbwt+sB1GHQP5baDTKf+a6SvECqa1NIjOn7y/1OAjIPUKSO/3Xl2eYHm/jZ2C41TXjU8V/VfNVVR8pgvka69DRPCH5eAaQJrqIEq1RrOJahj6k8U1k+fFvXVzWfTtgUpTojaDvfkt6YZxf8DmB4eDG80Xh3dOmt9y1l+fB1D0drf9V89b7oqk2eirbzdeXZ8uySr58D0LE98fNLXeTRnXxk0rpKXSfJJfjRw4N0/C98navOeZLWcj4d21M/Px3SjMdj6fDlm1eChdGQl9HbS5BglfZOb9YXLi7W/04m6J3eILnNjE/zAp1l43eL/KtuF18G1fKRvXzdB2S+m4TR0vyZYaf3iwUA4Pf3XwCA4fkB7heL3Phd+GYvkMGIJOOfTNZH9iLye8D6BW7jKq0h/6rbzdPFcbydq67lfJMRU+Mfnh9geH6QVwRxz4VvHwfqdHT38vCkBciv/fxgzW5aKW4KPz48tGY3rVS2nb9hEpxrPB7nxk97AHHt8vLSiZ8PgYSLU/zeZWzP02M/Pze5IZvMn89m+bnJDdh2vnBxit+7jC2y8Z19woUuUDl/uv1YyOMTG1RX/qfn50Ien9iYtvNNawLqEEg9f3t87MR3DoYDlJcAFIwvVDAc8+18YXwhg9EAMtaviK+bBAMvxu/CL52wMEYkrk8A0tg7REQo8+18OvYOEZFZ8K0T12cVfOr6BCCN/V34pRIVfOtkcQRQ9gcECItmvpn/9d0PKT4+RFiy6lunDAC15luD4ZLBKrXuAdDJtHDmIea7800LRz46G41SWwx+E/jGhTDji3fwp4uFE99JKPO344uFI99JqM7wXPz5deBrewCjT7jMy1fS+LSEzPfnqwbi0xKbfPJljK9u/PL7Acq2PKK12vVeAeaXSiZay13H6pdteevG11aA/nK/QxePAEgb4I3SxI/4TAaZ78fXxc/4TEavp9MOXTwSZW4yqjryy/23KJrWRwp/pptkQmyPZL6ZvwRANomE2J6oK1MxrNryjRXAtjReaJ2ya7o0vq5A5rvx57OZFD4gWlBfV6QtNEFtnevMd1oIE+emj1omja+Yv7lsOtkLsRC1qewm81ksFovFYrEapL+uI5W1uPxDjgAAAABJRU5ErkJggg==\"","import LevelScene from \"../scene/LevelScene\";\nimport Scene, { SCENE_HEIGHT, SCENE_WIDTH } from \"../scene/Scene\";\n\nexport class RendererContext {\n  constructor(public ctx: CanvasRenderingContext2D, public pixelSize: number, public debug: boolean) {}\n\n  run(callback: (rctx: RendererContext) => void) {\n    this.ctx.save();\n    try {\n      callback(this);\n    } finally {\n      this.ctx.restore();\n    }\n  }\n}\n\nexport interface Drawable {\n  render(ctx: RendererContext): void;\n}\n\nexport default class Renderer {\n  private canvas: HTMLCanvasElement;\n  private ctx: CanvasRenderingContext2D;\n  private memCanvas: HTMLCanvasElement;\n  private memCtx: CanvasRenderingContext2D;\n\n  private canvasWidth: number = 0;\n  private canvasHeight: number = 0;\n  private pixelSize: number = 0;\n\n  private scene: Scene | null = null;\n\n  private timer: number | null = null;\n\n  private debugMode: boolean = false;\n\n  constructor(canvas: HTMLCanvasElement) {\n    this.canvas = canvas;\n    this.ctx = this.canvas.getContext(\"2d\")!;\n\n    this.memCanvas = document.createElement(\"canvas\");\n    this.memCtx = this.memCanvas.getContext(\"2d\")!;\n\n    this.adjustSize();\n\n    this.renderHandler = this.renderHandler.bind(this);\n    this.start();\n  }\n\n  cleanup() {\n    this.stop();\n  }\n\n  start() {\n    if (this.timer === null) {\n      this.timer = requestAnimationFrame(this.renderHandler);\n    }\n  }\n\n  stop() {\n    if (this.timer !== null) {\n      cancelAnimationFrame(this.timer);\n      this.timer = null;\n    }\n  }\n\n  adjustSize() {\n    const pixelRatio = window.devicePixelRatio;\n    const logicWidth = document.body.clientWidth;\n    const logicHeight = document.body.clientHeight;\n    const deviceWidth = pixelRatio * logicWidth;\n    const deviceHeight = pixelRatio * logicHeight;\n\n    this.pixelSize = Math.max(1, Math.floor(Math.min(deviceWidth / SCENE_WIDTH, deviceHeight / SCENE_HEIGHT)));\n    this.canvasWidth = this.pixelSize * SCENE_WIDTH;\n    this.canvasHeight = this.pixelSize * SCENE_HEIGHT;\n\n    this.canvas.width = this.canvasWidth;\n    this.canvas.height = this.canvasHeight;\n\n    this.memCanvas.width = this.canvasWidth;\n    this.memCanvas.height = this.canvasHeight;\n    this.memCtx.imageSmoothingEnabled = false;\n\n    this.canvas.style.position = 'absolute';\n    this.canvas.style.width = this.canvasWidth / pixelRatio + 'px';\n    this.canvas.style.height = this.canvasHeight / pixelRatio + 'px';\n    this.canvas.style.left = (logicWidth - this.canvasWidth / pixelRatio) / 2 + 'px';\n    this.canvas.style.top = (logicHeight - this.canvasHeight / pixelRatio) / 2 + 'px';\n  }\n\n  setScene(scene: Scene) {\n    this.scene = scene;\n    this.render();\n  }\n\n  renderHandler() {\n    this.timer = null;\n    this.render();\n    this.timer = requestAnimationFrame(this.renderHandler);\n  }\n\n  render() {\n    if (!this.scene) return;\n\n    const startTime = performance.now();\n  \n    this.memCtx.save();\n    this.memCtx.clearRect(0, 0, this.canvasWidth, this.canvasHeight);\n    this.memCtx.scale(this.pixelSize, this.pixelSize);\n    this.scene.render(new RendererContext(this.memCtx, this.pixelSize, this.debugMode));\n    this.memCtx.restore();\n\n    this.ctx.clearRect(0, 0, this.canvasWidth, this.canvasHeight);\n    this.ctx.drawImage(this.memCanvas, 0, 0);\n\n    const endTime = performance.now();\n\n    if (this.debugMode) {\n      const debugText: string[] = [\n        [\n          `${this.canvasWidth}*${this.canvasHeight} ${this.pixelSize}x`,\n          `[${(endTime - startTime).toFixed(1).padStart(4, ' ')} ms]`\n        ].join(' '),\n        ...this.scene.debugText\n      ];\n      this.ctx.save();\n\n      this.ctx.font = '18px Consolas';\n\n      if (!(this.scene instanceof LevelScene && this.scene.paused)) {\n        let maxWidth = 0;\n        for (const text of debugText)\n          maxWidth = Math.max(maxWidth, this.ctx.measureText(text).width);\n  \n        this.ctx.fillStyle = 'rgba(32, 32, 32, 0.6)';\n        this.ctx.fillRect(4, 4, maxWidth + 8, 20 * debugText.length + 6);\n      }\n\n      this.ctx.textAlign = 'left';\n      this.ctx.textBaseline = 'top';\n      this.ctx.fillStyle = '#eee';\n      let textY = 8;\n      for (const text of debugText) {\n        this.ctx.fillText(text, 8, textY);\n        textY += 20;\n      }\n\n      this.ctx.strokeStyle = '#999';\n      this.ctx.strokeRect(0, 0, this.canvasWidth, this.canvasHeight);\n      this.ctx.restore();\n    }\n  }\n\n  setDebug(flag: boolean) {\n    this.debugMode = flag;\n    this.render();\n  }\n\n  toggleDebug() {\n    this.setDebug(!this.debugMode);\n  }\n}","export default \"data:image/png;base64,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\"","import { RendererContext } from \"../render/Renderer\";\nimport Scene from \"./Scene\";\nimport bg from \"../assets/background/help.png\";\nimport { Texture, textureManager } from \"../render/TextureManager\";\nimport GameManager from \"../GameManager\";\nimport { STRINGS } from \"./Subtitle\";\n\nlet textureBg: Texture;\n\ntextureManager.loadTexture(\"background/help\", bg)\n  .then(result => { textureBg = result; });\n\nexport default class AboutScene extends Scene {\n  constructor(gameManager: GameManager) {\n    super(gameManager);\n\n    this.listenKey(\"ui.pause\", event => {\n      if (event === \"down\")\n        this.backToTitle();\n    });\n  }\n\n  backToTitle() {\n    this.gameManager.backToTitle();\n  }\n\n  render(rctx: RendererContext) {\n    rctx.run(({ ctx }) => {\n      textureBg.drawTo(rctx, 0, 0);\n\n      ctx.font = \"4.5px 'Noto Sans SC'\";\n      ctx.fillStyle = '#f7f7f7';\n      ctx.textAlign = 'right';\n      ctx.textBaseline = 'bottom';\n      ctx.fillText(\"Esc \", 310, 172);\n\n      ctx.font = \"12px 'Noto Sans SC'\";\n      ctx.fillStyle = '#999';\n      ctx.textAlign = 'center';\n      ctx.textBaseline = 'middle';\n      ctx.shadowColor = \"#000\";\n      ctx.shadowBlur = 2;\n      ctx.fillText(\"\", 160, 35);\n\n      let y = 55;\n      ctx.font = \"5px 'Noto Sans SC'\";\n      ctx.fillStyle = '#d7d7d7';\n      for (let text of STRINGS[\"about\"].split('\\n')) {\n        ctx.fillText(text, 160, y);\n        y += 10;\n      }\n    });\n  }\n}","import { RendererContext } from \"../render/Renderer\";\nimport Scene from \"./Scene\";\nimport bg from \"../assets/background/help.png\";\nimport { Texture, textureManager } from \"../render/TextureManager\";\nimport GameManager from \"../GameManager\";\nimport { ForwardAnimation, GeneratorAnimation } from \"../render/Animation\";\nimport { STRINGS } from \"./Subtitle\";\n\nlet textureBg: Texture;\n\ninterface RenderLine {\n  text: string;\n  opacity: number;\n  offset: number;\n}\n\ntextureManager.loadTexture(\"background/help\", bg)\n  .then(result => { textureBg = result; });\n\nexport default class HelpScene extends Scene {\n  animation: ForwardAnimation<void> | null = null;\n\n  renderLines: RenderLine[] = [];\n\n  constructor(gameManager: GameManager) {\n    super(gameManager);\n\n    this.listenKey(\"ui.pause\", event => {\n      if (event === \"down\")\n        this.backToTitle();\n    });\n\n    this.animation = new GeneratorAnimation(this.animate());\n  }\n\n  backToTitle() {\n    this.gameManager.backToTitle();\n  }\n\n  tick() {\n    if (this.animation?.next())\n      this.animation = null;\n  }\n\n  render(rctx: RendererContext) {\n    rctx.run(({ ctx }) => {\n      textureBg.drawTo(rctx, 0, 0);\n\n      ctx.font = \"4.5px 'Noto Sans SC'\";\n      ctx.fillStyle = '#f7f7f7';\n      ctx.textAlign = 'right';\n      ctx.textBaseline = 'bottom';\n      ctx.fillText(\"Esc \", 310, 172);\n\n      ctx.font = \"12px 'Noto Sans SC'\";\n      ctx.fillStyle = '#999';\n      ctx.textAlign = 'center';\n      ctx.textBaseline = 'middle';\n      ctx.shadowColor = \"#000\";\n      ctx.shadowBlur = 2;\n      ctx.fillText(\"\", 160, 35);\n\n      let y = 60;\n      ctx.font = \"5.5px 'Noto Sans SC'\";\n      ctx.fillStyle = '#d7d7d7';\n      for (let { text, opacity, offset } of this.renderLines) {\n        ctx.globalAlpha = opacity;\n        ctx.fillText(text, 160, y + offset);\n        y += 20;\n      }\n    });\n  }\n\n  *animate() {\n    const fadeIn = 45, wait = 90, firstWait = 45;\n    let lines = STRINGS[\"help\"].split('\\n');\n    let first = true;\n\n    for (let line of lines) {\n      let renderLine: RenderLine = {\n        text: line,\n        opacity: 0,\n        offset: 0\n      };\n      this.renderLines.push(renderLine);\n\n      for (let i = first ? firstWait : wait; i > 0; i--)\n        yield;\n      first = false;\n\n      for (let i = 1; i <= fadeIn; i++) {\n        renderLine.opacity = i / fadeIn;\n        renderLine.offset = (1 - i / fadeIn) * 7;\n        yield;\n      }\n    }\n  }\n}","import { RendererContext } from \"../render/Renderer\";\nimport Scene, { SCENE_HEIGHT, SCENE_WIDTH } from \"./Scene\";\n\nexport default class LoadingScene extends Scene {\n  render(rctx: RendererContext) {\n    rctx.run(({ ctx }) => {\n      ctx.font = '12px sans-serif';\n      ctx.textAlign = 'center';\n      ctx.textBaseline = 'middle';\n      ctx.fillStyle = '#474d4e';\n      ctx.fillText(\"Loading...\", SCENE_WIDTH / 2, SCENE_HEIGHT / 2);\n    });\n  }\n}","import { RendererContext } from \"../render/Renderer\";\nimport Scene from \"./Scene\";\nimport bg from \"../assets/background/start.png\";\nimport { Texture, textureManager } from \"../render/TextureManager\";\nimport GameManager from \"../GameManager\";\nimport SelectMenu from \"./SelectMenu\";\n\nlet textureBg: Texture;\n\ntextureManager.loadTexture(\"background/start\", bg)\n  .then(result => { textureBg = result; });\n\ninterface Button {\n  action: string;\n  text: string;\n  disabled: boolean;\n}\n\nexport default class StartScene extends Scene {\n  menu: SelectMenu<Button>;\n  totalTicks = 0;\n\n  constructor(gameManager: GameManager) {\n    super(gameManager);\n\n    this.buttonHandler = this.buttonHandler.bind(this);\n    this.menu = new SelectMenu<Button>(this, [\n      {\n        action: \"start\",\n        text: \"\",\n        disabled: false\n      },\n      {\n        action: \"help\",\n        text: \"\",\n        disabled: false\n      },\n      {\n        action: \"about\",\n        text: \"\",\n        disabled: false\n      }\n    ], this.buttonHandler);\n  }\n\n  cleanup() {\n    this.menu.cleanup();\n  }\n\n  buttonHandler(button: Button) {\n    switch (button.action) {\n      case \"start\":\n        this.gameManager.startGame();\n        break;\n\n      case \"help\":\n        this.gameManager.showHelp();\n        break;\n\n      case \"about\":\n        this.gameManager.showAbout();\n        break;\n    }\n  }\n\n  tick() {\n    this.totalTicks++;\n  }\n\n  render(rctx: RendererContext) {\n    rctx.run(({ ctx }) => {\n      textureBg.drawTo(rctx, 0, 0);\n      this.renderMenu(rctx);\n    });\n  }\n\n  renderMenu(rctx: RendererContext) {\n    rctx.run(({ ctx }) => {\n      let x = 215, y = 105;\n      const { selectedItem } = this.menu;\n\n      ctx.textAlign = \"center\";\n      ctx.textBaseline = \"top\";\n      ctx.shadowColor = \"#000\";\n      ctx.shadowBlur = 3;\n\n      for (const item of this.menu.getItems()) {\n        let header = item.action === \"start\";\n        ctx.font = `${header ? 9 : 7}px 'Noto Sans SC'`;\n        ctx.fillStyle = item === selectedItem ?\n          (this.totalTicks % 12 < 6 ? '#90d060' : '#f0e080') :\n          (item.disabled ? '#999' : '#f7f7f7');\n        ctx.fillText(item.text, x, y);\n        y += header ? 18 : 12;\n      }\n\n      ctx.font = \"4.5px 'Noto Sans SC'\";\n      ctx.fillStyle = '#f7f7f7';\n      ctx.textAlign = 'right';\n      ctx.textBaseline = 'bottom';\n      ctx.fillText(\"Enter \", 310, 172);\n    });\n  }\n}","export default \"data:image/png;base64,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\"","import KeyboardManager from \"./input/KeyboardManager\";\nimport levelManager from \"./map/LevelManager\";\nimport Renderer from \"./render/Renderer\";\nimport { textureManager } from \"./render/TextureManager\";\nimport AboutScene from \"./scene/AboutScene\";\nimport HelpScene from \"./scene/HelpScene\";\nimport LevelScene from \"./scene/LevelScene\";\nimport LoadingScene from \"./scene/LoadingScene\";\nimport Scene from \"./scene/Scene\";\nimport StartScene from \"./scene/StartScene\";\n\nexport const TICK_ELAPSE = 1000 / 60;\n\nexport default class GameManager {\n  private scene: Scene;\n  private renderer: Renderer;\n  private keyboardManager: KeyboardManager;\n  private timer: number | null = null;\n\n  constructor(private canvas: HTMLCanvasElement) {\n    this.scene = new LoadingScene(this);\n    this.renderer = new Renderer(canvas);\n    this.keyboardManager = new KeyboardManager(this);\n\n    this.renderer.setScene(this.scene);\n\n    this.tickHandler = this.tickHandler.bind(this);\n    this.resizeHandler = this.resizeHandler.bind(this);\n\n    window.addEventListener(\"resize\", this.resizeHandler, false);\n\n    textureManager.untilAllLoaded().then(() => {\n      this.switchScene(() => new StartScene(this));\n    });\n\n    this.start();\n  }\n\n  cleanup() {\n    window.removeEventListener(\"resize\", this.resizeHandler, false);\n    this.keyboardManager.cleanup();\n    this.renderer.cleanup();\n  }\n\n  getCanvas() { return this.canvas; }\n  getScene() { return this.scene; }\n\n  private resizeHandler() {\n    this.renderer.adjustSize();\n  }\n\n  onKeyEvent(command: string, event: string) {\n    switch (command) {\n      case 'debug.toggle':\n        if (event === 'down')\n          this.renderer.toggleDebug();\n        break;\n      case 'debug.level':\n        if (event === 'down') {\n          const name = prompt(\"Enter level name to enter:\");\n          if (name) this.startLevel(name);\n        }\n        break;\n      default:\n        this.scene.onKeyEvent(command, event);\n    }\n  }\n\n  isKeyPressed(command: string) {\n    return this.keyboardManager.isKeyPressed(command);\n  }\n\n  start() {\n    if (this.timer === null) {\n      this.timer = window.setInterval(this.tickHandler, TICK_ELAPSE);\n    }\n  }\n\n  stop() {\n    if (this.timer !== null) {\n      window.clearInterval(this.timer);\n      this.timer = null;\n    }\n  }\n\n  tickHandler() {\n    this.scene.tick();\n  }\n\n  switchScene(callback: () => Scene) {\n    this.scene.cleanup();\n    this.scene = callback();\n    this.renderer.setScene(this.scene);\n  }\n\n  startLevel(name: string) {\n    const level = levelManager.get(name);\n    if (!level)\n      throw new Error(`level \"${name}\" can't be found`);\n    this.switchScene(() => new LevelScene(this, level));\n  }\n\n  onLevelComplete(name: string) {\n    switch (name) {\n      case \"level1\":\n        this.startLevel(\"level2\");\n        break;\n      case \"level2\": case \"test0\": {\n        const scene = this.scene as LevelScene;\n        scene.gameComplete();\n        break;\n      }\n      default:\n        throw new Error(`unknown level: ${name}`);\n    }\n  }\n\n  startGame() {\n    this.startLevel(\"level1\");\n  }\n\n  showHelp() {\n    this.switchScene(() => new HelpScene(this));\n  }\n\n  showAbout() {\n    this.switchScene(() => new AboutScene(this));\n  }\n\n  backToTitle() {\n    this.switchScene(() => new StartScene(this));\n  }\n}\n","import React from 'react';\nimport './App.css';\nimport GameManager from './GameManager';\n\nclass App extends React.PureComponent {\n  refCanvas: React.RefObject<HTMLCanvasElement> = React.createRef();\n  gameManager!: GameManager;\n\n  componentDidMount() {\n    this.gameManager = new GameManager(this.refCanvas.current!);\n  }\n\n  componentWillUnmount() {\n    this.gameManager.cleanup();\n  }\n\n  render() {\n    return (\n      <div className=\"App\">\n        <canvas ref={this.refCanvas}></canvas>\n        <audio src=\"/music/bgm.mp3\" style={{ display: \"none\" }} autoPlay={true} loop={true}></audio>\n      </div>\n    );\n  }\n}\n\nexport default App;\n","import React from \"react\";\nimport \"./ItemEditor.css\";\n\nexport type ItemEditorDataEntry = [string, string];\nexport type ItemEditorData = ItemEditorDataEntry[];\n\ninterface ItemEditorProps {\n  data: ItemEditorData;\n  onModify: (field: string, value: string) => void;\n};\n\ninterface ItemEditorState {\n  error: {\n    field: string | null;\n    message: string;\n  } | null;\n};\n\nexport class EditError extends Error {}\n\nexport default class ItemEditor extends React.Component<ItemEditorProps, ItemEditorState> {\n  constructor(props: ItemEditorProps) {\n    super(props);\n    this.state = { error: null };\n    this.modifyHandler = this.modifyHandler.bind(this);\n  }\n\n  modifyHandler(field: string, value: string) {\n    try {\n      this.props.onModify(field, value);\n      this.setState({ error: null });\n    } catch (err: any) {\n      this.setState({ error: { field, message: err.message} });\n      if (!(err instanceof EditError))\n        console.error(err);\n    }\n  }\n\n  render() {\n    const { props: { data: item }, state } = this;\n    return (\n      <div className=\"ItemEditor\">\n        <div className=\"fields\">\n          {item.map(([field, value]) =>\n            <div key={field} className=\"field\">\n              <span className=\"key\">{field}</span>\n              <input type=\"text\" value={value}\n                className={state.error?.field === field ? 'error' : ''}\n                onInput={evt => this.modifyHandler(field, evt.currentTarget.value)} />\n            </div>\n          )}\n        </div>\n        <div>\n          <span style={{ fontSize: \"smaller\" }}>{state.error?.message}</span>\n        </div>\n      </div>\n    );\n  }\n}","import { MapData, MapDecoration, MapTerrain, MapTerrainType, TERRAIN_SIZE } from \"../map/interfaces\";\n\nconst COLORS = {\n  'none': '#ffffff',\n  'wood': '#880015',\n  'dirt': '#b97a57',\n  'grass': '#22b14c',\n  'spikes': '#ed1c24',\n  'trunk': '#382b18',\n  'branch': '#987849',\n  'water': '#99d9ea',\n  'brick': '#aaaaaa',\n  'wall': '#444444',\n};\n\nfunction parseHexColor(hex: string) {\n  return parseInt(hex.slice(1), 16);\n}\n\nfunction toHexColor(color: number) {\n  return '#' + color.toString(16).padStart(6, '0');\n}\n\ninterface PatternContent {\n  terrain: MapTerrain | null;\n  decoration?: {\n    x: number;\n    y: number;\n    variant: string;\n  };\n}\n\ninterface RawMatchPattern extends PatternContent {\n  pixels: (keyof typeof COLORS)[];\n}\n\ninterface MatchPattern extends PatternContent {\n  pixels: number[];\n}\n\nconst PATTERNS_RAW: RawMatchPattern[] = [\n  // Empty\n  {\n    terrain: null,\n    pixels: [\n      'none', 'none',\n      'none', 'none'\n    ]\n  },\n\n  // Bricks\n  {\n    terrain: {\n      type: MapTerrainType.brick,\n      variant: \"wood\"\n    },\n    pixels: [\n      'wood', 'wood',\n      'wood', 'wood'\n    ]\n  },\n  {\n    terrain: {\n      type: MapTerrainType.brick,\n      variant: \"dirt\"\n    },\n    pixels: [\n      'dirt', 'dirt',\n      'dirt', 'dirt'\n    ]\n  },\n  {\n    terrain: {\n      type: MapTerrainType.brick,\n      variant: \"grass\"\n    },\n    pixels: [\n      'grass', 'grass',\n      'grass', 'grass'\n    ]\n  },\n  {\n    terrain: {\n      type: MapTerrainType.brick,\n      variant: \"brick\"\n    },\n    pixels: [\n      'brick', 'brick',\n      'brick', 'brick'\n    ]\n  },\n\n  // Spikes\n  {\n    terrain: {\n      type: MapTerrainType.spikes,\n      side: 0\n    },\n    pixels: [\n      'spikes', 'none',\n      'spikes', 'none'\n    ]\n  },\n  {\n    terrain: {\n      type: MapTerrainType.spikes,\n      side: 1\n    },\n    pixels: [\n      'spikes', 'spikes',\n      'none', 'none'\n    ]\n  },\n  {\n    terrain: {\n      type: MapTerrainType.spikes,\n      side: 2\n    },\n    pixels: [\n      'none', 'spikes',\n      'none', 'spikes'\n    ]\n  },\n  {\n    terrain: {\n      type: MapTerrainType.spikes,\n      side: 3\n    },\n    pixels: [\n      'none', 'none',\n      'spikes', 'spikes'\n    ]\n  },\n\n  // Trunk\n  {\n    terrain: null,\n    decoration: {\n      x: 4, y: 4,\n      variant: \"trunk\"\n    },\n    pixels: [\n      'trunk', 'trunk',\n      'trunk', 'trunk'\n    ]\n  },\n  {\n    terrain: null,\n    decoration: {\n      x: 4, y: 4,\n      variant: \"trunk-branch-r\"\n    },\n    pixels: [\n      'trunk', 'trunk',\n      'trunk', 'none'\n    ]\n  },\n  {\n    terrain: null,\n    decoration: {\n      x: 4, y: 4,\n      variant: \"trunk-branch-l\"\n    },\n    pixels: [\n      'trunk', 'trunk',\n      'none', 'trunk'\n    ]\n  },\n\n  // Brick Wall\n  {\n    terrain: null,\n    decoration: {\n      x: 4, y: 4,\n      variant: \"brick-wall\"\n    },\n    pixels: [\n      'wall', 'wall',\n      'wall', 'wall'\n    ]\n  },\n  {\n    terrain: null,\n    decoration: {\n      x: 4, y: 4,\n      variant: \"brick-wall-light\"\n    },\n    pixels: [\n      'wall', 'none',\n      'none', 'wall'\n    ]\n  },\n\n  // Branch\n  {\n    terrain: null,\n    decoration: {\n      x: 4, y: 4,\n      variant: \"branch\"\n    },\n    pixels: [\n      'branch', 'branch',\n      'branch', 'branch'\n    ]\n  },\n  {\n    terrain: null,\n    decoration: {\n      x: 4, y: 4,\n      variant: \"branch-end-r\"\n    },\n    pixels: [\n      'branch', 'none',\n      'branch', 'none'\n    ]\n  },\n  {\n    terrain: null,\n    decoration: {\n      x: 4, y: 4,\n      variant: \"branch-end-l\"\n    },\n    pixels: [\n      'none', 'branch',\n      'none', 'branch'\n    ]\n  },\n\n  // Tree platform\n  {\n    terrain: {\n      type: MapTerrainType.brick,\n      variant: \"tree\"\n    },\n    pixels: [\n      'trunk', 'trunk',\n      'branch', 'branch'\n    ]\n  },\n  {\n    terrain: {\n      type: MapTerrainType.fragile,\n      variant: \"tree\"\n    },\n    pixels: [\n      'trunk', 'trunk',\n      'none', 'none'\n    ]\n  },\n\n  // Water\n  {\n    terrain: {\n      type: MapTerrainType.water,\n      surface: true\n    },\n    pixels: [\n      'none', 'none',\n      'water', 'water'\n    ]\n  },\n  {\n    terrain: {\n      type: MapTerrainType.water,\n      surface: false\n    },\n    pixels: [\n      'water', 'water',\n      'water', 'water'\n    ]\n  },\n] as RawMatchPattern[];\n\nconst PATTERNS: MatchPattern[] = PATTERNS_RAW.map(({ pixels, ...more }) => ({\n  ...more,\n  pixels: pixels.map(s => parseHexColor(COLORS[s]))\n}));\n\nfunction parseImage(img: HTMLImageElement, name: string): MapData {\n  const { naturalWidth: imgWidth, naturalHeight: imgHeight } = img;\n  if (imgWidth % 2 !== 0 || imgHeight % 2 !== 0)\n    throw new Error(\"image size should be even\");\n\n  const mapWidth = imgWidth / 2;\n  const mapHeight = imgHeight / 2;\n\n  const canvas = document.createElement(\"canvas\");\n  const ctx = canvas.getContext(\"2d\")!;\n\n  canvas.width = imgWidth;\n  canvas.height = imgHeight;\n  ctx.clearRect(0, 0, imgWidth, imgHeight);\n  ctx.drawImage(img, 0, 0);\n\n  const imgData = ctx.getImageData(0, 0, imgWidth, imgHeight);\n\n  const pixelAt = (x: number, y: number) => {\n    const offset = (y * imgWidth + x) * 4;\n    return (imgData.data[offset] << 16) |\n      (imgData.data[offset + 1] << 8) |\n      imgData.data[offset + 2];\n  };\n\n  const mapDecorations: MapDecoration[] = [];\n\n  const mapTerrain: (MapTerrain | null)[][] = new Array(mapHeight).fill(null)\n    .map((_, y) => new Array(mapWidth).fill(null)\n    .map((_, x) => {\n      const A = pixelAt(2 * x, 2 * y);\n      const B = pixelAt(2 * x + 1, 2 * y);\n      const C = pixelAt(2 * x, 2 * y + 1);\n      const D = pixelAt(2 * x + 1, 2 * y + 1);\n\n      for (const { terrain, decoration, pixels } of PATTERNS) {\n        if (pixels[0] === A && pixels[1] === B && pixels[2] === C && pixels[3] === D) {\n          if (decoration) {\n            mapDecorations.push({\n              x: x * TERRAIN_SIZE + decoration.x,\n              y: y * TERRAIN_SIZE + decoration.y,\n              tags: [],\n              variant: decoration.variant\n            });\n          }\n          return terrain;\n        }\n      }\n\n      console.warn(`unknown pixel at (${x}, ${y}): ${[A, B, C, D].map(x => toHexColor(x)).join(' ')}`);\n      return null;\n    }));\n\n  const map: MapData = {\n    id: name,\n    width: mapWidth,\n    height: mapHeight,\n    terrain: mapTerrain,\n    entities: [],\n    decorations: mapDecorations,\n    triggers: [],\n    backgrounds: [],\n    landmarks: [],\n    spawnPoints: []\n  };\n\n  console.log(map);\n\n  return map;\n}\n\nexport default parseImage;\n","import React from \"react\";\nimport { MapTerrain, TERRAIN_SIZE } from \"../map/interfaces\";\nimport { RendererContext } from \"../render/Renderer\";\nimport { Terrain } from \"../model/Terrain\";\n\ninterface TerrainCanvasProps {\n  width: number;\n  height: number;\n  scale: number;\n  terrains: (MapTerrain | null)[][];\n  debug: boolean;\n}\n\nexport default class TerrainCanvas extends React.PureComponent<TerrainCanvasProps> {\n  refCanvas = React.createRef<HTMLCanvasElement>();\n\n  componentDidMount() {\n    const { width, height, scale, terrains, debug } = this.props;\n\n    if (width === 0 || height === 0)\n      return;\n\n    const canvas = this.refCanvas.current!;\n\n    const pxGrid = TERRAIN_SIZE * scale;\n    const canvasWidth = width * pxGrid;\n    const canvasHeight = height * pxGrid;\n    const ratio = window.devicePixelRatio;\n\n    canvas.width = canvasWidth;\n    canvas.height = canvasHeight;\n    canvas.style.imageRendering = 'pixelated';\n    canvas.style.width = canvasWidth / ratio + 'px';\n    canvas.style.height = canvasHeight / ratio + 'px';\n\n    const ctx = canvas.getContext('2d')!;\n    const rctx = new RendererContext(ctx, scale, debug);\n\n    ctx.imageSmoothingEnabled = false;\n\n    ctx.save();\n    ctx.scale(scale, scale);\n\n    for (let y = 0; y < height; y++) {\n      for (let x = 0; x < width; x++) {\n        const terrain = Terrain.create(x, y, terrains[y][x]);\n        terrain?.render(rctx);\n      }\n    }\n\n    ctx.restore();\n\n    ctx.lineWidth = 0.5;\n    ctx.strokeStyle = '#aaa';\n    ctx.beginPath();\n    for (let x = 0; x <= width; x++) {\n      ctx.moveTo(x * pxGrid, 0);\n      ctx.lineTo(x * pxGrid, canvasHeight);\n    }\n    for (let y = 0; y <= height; y++) {\n      ctx.moveTo(0, y * pxGrid);\n      ctx.lineTo(canvasWidth, y * pxGrid);\n    }\n    ctx.stroke();\n  }\n\n  render() {\n    return (\n      <canvas ref={this.refCanvas}></canvas>\n    );\n  }\n}","import React from 'react';\nimport { AABB, Coord } from '../base/math';\nimport { MapBackground, MapData, MapDecoration, MapEntity, MapEntityType, MapItemType, MapLandmark, MapSpawnPoint, MapSprite, MapTerrain, MapTrigger, MapTriggerType, TERRAIN_SIZE } from '../map/interfaces';\nimport ItemEditor, { EditError, ItemEditorData, ItemEditorDataEntry } from './ItemEditor';\nimport './MapEditor.css';\nimport parseImage from './parseImage';\nimport TerrainCanvas from './TerrainCanvas';\n\n/******** MapEditor ********/\n\ntype MapItem = {\n  id: number;\n  category: 'entity' | 'decoration' | 'landmark' | 'spawnPoint';\n  item: MapSprite;\n}\n\ntype MapToolType = {\n  category: 'entity';\n  type: MapEntityType\n} | {\n  category: 'decoration';\n} | {\n  category: 'landmark';\n} | {\n  category: 'spawnPoint';\n};\n\nconst ENTITY_TEMPLATES = new Map([\n  [MapEntityType.player, {\n    health: 6,\n    maxHealth: 6\n  }],\n  [MapEntityType.scout, {}],\n  [MapEntityType.guard, {}],\n  [MapEntityType.archer, {}],\n  [MapEntityType.witch, {}],\n  [MapEntityType.boss, {}],\n  [MapEntityType.item, {\n    item: MapItemType.flower,\n    double: false\n  }],\n]);\n\nconst ENTITY_TYPES: MapEntityType[] = [...ENTITY_TEMPLATES.keys()];\n\nconst TOOLS: MapToolType[] = [\n  { category: 'decoration' },\n  { category: 'landmark' },\n  { category: 'spawnPoint' },\n  ...ENTITY_TYPES.map(type => ({ category: 'entity', type } as MapToolType))\n];\n\ninterface MapEditorState {\n  loaded: boolean;\n  // used for rendering terrain\n  mapCounter: number;\n  mapId: string;\n  // dimension of pixels\n  width: number;\n  height: number;\n  // dimension of terrain\n  mapWidth: number;\n  mapHeight: number;\n  terrains: (MapTerrain | null)[][];\n  backgrounds: MapBackground[];\n  backgroundDrafts: ItemEditorData[];\n  triggers: MapTrigger[];\n  triggerDrafts: ItemEditorData[];\n  scale: number;\n  pxAtom: number;\n  pxGrid: number;\n  items: MapItem[];\n  selectedItems: MapItem[];\n  itemDraft: ItemEditorData | null;\n  currentTool: MapToolType;\n  sidebarDock: 'l' | 'r';\n  dragCorner: Coord | null;\n  dragCorner2: Coord | null;\n  mouseCoord: Coord | null;\n  debugRender: boolean;\n}\n\nexport default class MapEditor extends React.Component<{}, MapEditorState> {\n  currentItemId = 0;\n\n  refFileInput = React.createRef<HTMLInputElement>();\n  refContainer = React.createRef<HTMLDivElement>();\n\n  constructor(props: {}) {\n    super(props);\n\n    this.state = {\n      loaded: false,\n      mapCounter: 0,\n      mapId: '',\n      width: 0,\n      height: 0,\n      mapWidth: 0,\n      mapHeight: 0,\n      terrains: [],\n      backgrounds: [],\n      backgroundDrafts: [],\n      triggers: [],\n      triggerDrafts: [],\n      scale: 4,\n      pxAtom: 4 / window.devicePixelRatio,\n      pxGrid: 4 * TERRAIN_SIZE / window.devicePixelRatio,\n      items: [],\n      selectedItems: [],\n      itemDraft: null,\n      currentTool: {\n        category: 'entity',\n        type: MapEntityType.player\n      },\n      sidebarDock: 'r',\n      dragCorner: null,\n      dragCorner2: null,\n      mouseCoord: null,\n      debugRender: true\n    };\n\n    this.importHandler = this.importHandler.bind(this);\n    this.exportHandler = this.exportHandler.bind(this);\n    this.fileHandler = this.fileHandler.bind(this);\n    this.mouseHandler = this.mouseHandler.bind(this);\n    this.keyHandler = this.keyHandler.bind(this);\n    this.itemMouseHandler = this.itemMouseHandler.bind(this);\n    this.itemModifyHandler = this.itemModifyHandler.bind(this);\n  }\n\n  componentDidMount() {\n    window.addEventListener(\"keydown\", this.keyHandler, false);\n  }\n\n  componentWillUnmount() {\n    window.removeEventListener(\"keydown\", this.keyHandler, false);\n  }\n\n  importHandler() {\n    this.refFileInput.current!.click();\n  }\n\n  async fileHandler(evt: React.FormEvent<HTMLInputElement>) {\n    const input = evt.currentTarget;\n    if (input.files?.length === 1) {\n      const [file] = input.files;\n      if (file.name.endsWith(\".png\")) {\n        const url = URL.createObjectURL(file);\n        const img = new Image();\n        img.src = url;\n        img.onload = () => {\n          try {\n            const map = parseImage(img, file.name.slice(0, file.name.indexOf('.')));\n            this.loadMap(map, true);\n          } catch (err: any) {\n            console.error(err);\n            alert(err.message);\n          } finally {\n            URL.revokeObjectURL(url);\n          }\n        };\n      } else if (file.name.endsWith(\".json\")) {\n        const reader = new FileReader();\n        reader.onload = () => {\n          try {\n            const data = JSON.parse(reader.result as string) as MapData;\n            data.backgrounds = data.backgrounds ?? [];\n            data.landmarks = data.landmarks ?? [];\n            data.spawnPoints = data.spawnPoints ?? [];\n            this.loadMap(data);\n          } catch (err: any) {\n            console.error(err);\n            alert(err.message);\n          }\n        };\n        reader.readAsText(file);\n      } else {\n        alert(\"supports .png and .json files only\");\n      }\n    }\n  }\n\n  createItem<T extends MapSprite>(category: MapItem[\"category\"], item: T): MapItem {\n    return { id: this.currentItemId++, category, item };\n  }\n\n  loadMap(map: MapData, keepItems = false) {\n    this.setState(state => ({\n      loaded: true,\n      mapCounter: state.mapCounter + 1,\n      mapId: map.id,\n      width: map.width * TERRAIN_SIZE,\n      height: map.height * TERRAIN_SIZE,\n      mapWidth: map.width,\n      mapHeight: map.height,\n      terrains: map.terrain,\n      backgrounds: keepItems ? state.backgrounds : map.backgrounds,\n      backgroundDrafts: keepItems ? state.backgroundDrafts : map.backgrounds.map(x => this.makeBackgroundDraft(x)),\n      triggers: keepItems ? state.triggers : map.triggers,\n      triggerDrafts: keepItems ? state.triggerDrafts : map.triggers.map(x => this.makeTriggerDraft(x)),\n      items: [\n        ...map.entities.map(entity => this.createItem('entity', entity)),\n        ...map.decorations.map(decoration => this.createItem('decoration', decoration)),\n        ...map.landmarks.map(landmark => this.createItem('landmark', landmark)),\n        ...map.spawnPoints.map(spawnPoint => this.createItem('spawnPoint', spawnPoint)),\n        ...(keepItems ? [...state.items.filter(x => x.category !== 'decoration')] : [])\n      ],\n      selectedItems: [],\n      itemDraft: null\n    }));\n  }\n\n  exportMap(): MapData {\n    const {\n      mapId, mapWidth, mapHeight,\n      terrains, items, backgrounds, triggers\n    } = this.state;\n    return {\n      id: mapId,\n      width: mapWidth,\n      height: mapHeight,\n      terrain: terrains,\n      entities: items.filter(x => x.category === 'entity').map(x => x.item as MapEntity),\n      decorations: items.filter(x => x.category === 'decoration').map(x => x.item as MapDecoration),\n      triggers: triggers,\n      backgrounds: backgrounds,\n      landmarks: items.filter(x => x.category === 'landmark').map(x => x.item as MapLandmark),\n      spawnPoints: items.filter(x => x.category === 'spawnPoint').map(x => x.item as MapSpawnPoint)\n    };\n  }\n\n  exportHandler() {\n    const map = this.exportMap();\n    const blob = new Blob([JSON.stringify(map)], { type: 'application/json' });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = map.id + '.json';\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    URL.revokeObjectURL(url);\n  }\n\n  toggleSidebarDock() {\n    this.setState(({ sidebarDock }) => ({\n      sidebarDock: sidebarDock === 'l' ? 'r' : 'l'\n    }));\n  }\n\n  editMapId() {\n    let str = prompt(\"Enter map id:\", this.state.mapId);\n    if (str) this.setState({ mapId: str });\n  }\n\n  mouseHandler(evt: React.MouseEvent<HTMLDivElement>) {\n    evt.preventDefault();\n    const box = this.refContainer.current!.getBoundingClientRect();\n    const offsetX = evt.clientX - box.left;\n    const offsetY = evt.clientY - box.top;\n    const sceneX = Math.round(offsetX / this.state.pxAtom);\n    const sceneY = Math.round(offsetY / this.state.pxAtom);\n\n    if (evt.type === 'mousedown') {\n      if (evt.button === 0) {\n        this.selectItems([]);\n        this.setState({\n          dragCorner: new Coord(offsetX, offsetY)\n        });\n      } else if (evt.button === 2) {\n        this.placeItem(sceneX, sceneY);\n      }\n    } else if (evt.type === 'mousemove') {\n      if (this.state.dragCorner) {\n        this.setState({\n          dragCorner2: new Coord(offsetX, offsetY)\n        });\n      }\n      this.setState({\n        mouseCoord: new Coord(sceneX, sceneY)\n      });\n    } else if (evt.type === 'mouseup') {\n      if (evt.button === 0) {\n        const { dragCorner: corner, dragCorner2: corner2 } = this.state;\n        this.selectItems([]);\n        if (corner) {\n          if (corner2) {\n            const rect = AABB.cornered(corner, corner2);\n            this.selectItems(this.getItemsInRect(rect));\n          }\n          this.setState({\n            dragCorner: null,\n            dragCorner2: null\n          });\n        }\n      }\n    }\n  }\n\n  getItemsInRect(rect: AABB) {\n    const { items, pxAtom } = this.state;\n    return items.filter(({ category, item }) => {\n      switch (category) {\n        case 'landmark': {\n          const landmark = item as MapLandmark;\n          return AABB.offset(landmark.x, landmark.y, landmark.width, landmark.height).inside(rect);\n        }\n        default: {\n          const sprite = item as MapSprite;\n          return new Coord(sprite.x * pxAtom, sprite.y * pxAtom).inside(rect);\n        }\n      }\n    });\n  }\n\n  keyHandler(evt: KeyboardEvent) {\n    if (evt.target instanceof HTMLInputElement || evt.target instanceof HTMLTextAreaElement)\n      return;  \n    switch (evt.key) {\n      case 'ArrowLeft':\n      case 'ArrowUp':\n      case 'ArrowRight':\n      case 'ArrowDown': {\n        const [dx, dy] = {\n          L: [-1, 0], R: [1, 0],\n          U: [0, -1], D: [0, 1]\n        }[evt.key[5]]!;\n        const { selectedItems } = this.state;\n        for (const { item } of selectedItems) {\n          item.x += dx;\n          item.y += dy;\n        }\n        this.setState({\n          itemDraft: selectedItems.length === 1 ? this.makeItemDraft(selectedItems[0].item) : null\n        });\n        break;\n      }\n      case '1': case '2': case '3': case '4': case '5':\n      case '6': case '7': case '8': case '9': {\n        this.switchTool(TOOLS[parseInt(evt.key) - 1]);\n        break;\n      }\n      case 'a': {\n        if (evt.ctrlKey) {\n          this.selectItems(this.state.items.slice(0));\n        }\n        break;\n      }\n      case 'Delete': {\n        const { selectedItems } = this.state;\n        this.selectItems([]);\n        this.setState(state => ({\n          items: state.items.filter(x => !selectedItems.includes(x))\n        }));\n        break;\n      }\n      default: return;\n    }\n    evt.preventDefault();\n  }\n\n  update() {\n    this.setState({}); // force React to update\n  }\n\n  getItemToPlace(x: number, y: number): MapItem | null {\n    const tool = this.state.currentTool;\n    switch (tool.category) {\n      case 'entity':\n        return this.createItem('entity', {\n          tags: [], x, y,\n          type: tool.type,\n          ...(ENTITY_TEMPLATES.get(tool.type) ?? {})\n        });\n      case 'decoration':\n        return this.createItem('decoration', {\n          tags: [], x, y,\n          variant: ''\n        });\n      case 'landmark':\n        return this.createItem('landmark', {\n          tags: [], x, y,\n          width: 8, height: 8\n        });\n      case 'spawnPoint':\n        return this.createItem('spawnPoint', {\n          tags: [], x, y\n        });\n      default:\n        return null;\n    }\n  }\n\n  placeItem(x: number, y: number) {\n    const item = this.getItemToPlace(x, y);\n    if (item) {\n      this.state.items.push(item);\n      this.selectItems([item]);\n    }\n  }\n\n  selectItems(items: MapItem[]) {\n    let itemDraft: ItemEditorData | null = null;\n    if (items.length === 1) {\n      const [{ item }] = items;\n      itemDraft = this.makeItemDraft(item);\n    }\n    this.setState({ selectedItems: items, itemDraft });\n  }\n\n  switchTool(tool: MapToolType) {\n    this.setState({ currentTool: tool });\n  }\n\n  itemMouseHandler(evt: React.MouseEvent, item: MapItem) {\n    if (evt.type === 'mousedown') {\n      if (evt.button === 0) {\n        if (evt.ctrlKey) {\n          const items = new Set(this.state.selectedItems);\n          if (items.has(item))\n            items.delete(item);\n          else\n            items.add(item);\n          this.selectItems([...items])\n        } else {\n          this.selectItems([item]);\n        }\n      }\n      evt.stopPropagation();\n    } else if (evt.type === 'mouseup') {\n      evt.stopPropagation();\n    }\n  }\n\n  makeItemDraft({ tags, ...more }: MapSprite): ItemEditorData {\n    return [\n      ['tags', tags.join(',')],\n      ...Object.keys(more).map(key => [key, JSON.stringify((more as any)[key])] as ItemEditorDataEntry)\n    ];\n  }\n\n  itemModifyHandler(field: string, value: string) {\n    const entry = this.state.itemDraft!.find(x => x[0] === field);\n    if (!entry)\n      throw new EditError(\"field does not exist\");\n    entry[1] = value;\n    this.update();\n\n    let parsed: any;\n    switch (field) {\n      case 'tags': {\n        const tags = value === '' ? [] : value.split(',');\n        if (tags.some(x => !x.length))\n          throw new EditError(\"tag name should not be empty\");\n        if (tags.length !== new Set(tags).size)\n          throw new EditError(\"duplicate tag\");\n        parsed = tags;\n        break;\n      }\n      case 'x': case 'y':\n        parsed = parseInt(value);\n        if (isNaN(parsed))\n          throw new EditError(\"coordinate should be number\");\n        break;\n      default:\n        try {\n          parsed = JSON.parse(value);\n        } catch (err: any) {\n          throw new EditError(err.message);\n        }\n    }\n\n    Object.assign(this.state.selectedItems[0].item, { [field]: parsed });\n    this.update();\n  }\n\n  /* ======== Background ======== */\n\n  makeBackgroundDraft(data: MapBackground): ItemEditorData {\n    return Object.keys(data).map(key => [key, JSON.stringify((data as any)[key])] as ItemEditorDataEntry);\n  }\n\n  backgroundsEditHandler(index: number, field: string, value: string) {\n    const item = this.state.backgrounds[index];\n    const draft = this.state.backgroundDrafts[index];\n\n    const entry = draft.find(x => x[0] === field);\n    if (!entry)\n      throw new EditError(\"field does not exist\");\n    entry[1] = value;\n    this.update();\n\n    let parsed: any = JSON.parse(value);\n    switch (field) {\n      case 'picture': {\n        if (typeof parsed !== 'string')\n          throw new EditError(\"picture name should be string\");\n        break;\n      }\n      case 'opacity':\n        if (typeof parsed !== 'number')\n          throw new EditError(\"opacity should be number\");\n        break;\n      case 'horizontal': case 'vertical':\n        if (!parsed || typeof parsed !== 'object')\n          throw new EditError(`${field} should be object`);\n        if (typeof parsed.repeat !== \"boolean\")\n          throw new EditError(`${field}.repeat should be boolean`);\n        if (parsed.repeat) {\n          if (typeof parsed.factor !== \"number\")\n            throw new EditError(`${field}.factor should be number`);\n          if (typeof parsed.offset !== \"number\")\n            throw new EditError(`${field}.offset should be number`);\n        } else {\n          if (typeof parsed.marginL !== \"number\")\n            throw new EditError(`${field}.marginL should be number`);\n          if (typeof parsed.marginR !== \"number\")\n            throw new EditError(`${field}.marginR should be number`);\n        }\n        break;\n    }\n\n    Object.assign(item, { [field]: parsed });\n    this.update();\n  }\n\n  backgroundAddHandler() {\n    const data: MapBackground = {\n      picture: \"bg/\",\n      opacity: 1,\n      horizontal: {\n        repeat: true,\n        factor: 0.5,\n        offset: 0\n      },\n      vertical: {\n        repeat: false,\n        marginL: 0,\n        marginR: 0\n      }\n    };\n    this.state.backgrounds.push(data);\n    this.state.backgroundDrafts.push(this.makeBackgroundDraft(data));\n    this.update();\n  }\n\n  backgroundRemoveHandler(index: number) {\n    this.state.backgrounds.splice(index, 1);\n    this.state.backgroundDrafts.splice(index, 1);\n    this.update();\n  }\n\n  /* ======== Trigger ======== */\n\n  makeTriggerDraft(data: MapTrigger): ItemEditorData {\n    return Object.keys(data).map(key => [key, JSON.stringify((data as any)[key])] as ItemEditorDataEntry);\n  }\n\n  triggersEditHandler(index: number, field: string, value: string) {\n    const item = this.state.triggers[index];\n    const draft = this.state.triggerDrafts[index];\n\n    const entry = draft.find(x => x[0] === field);\n    if (!entry)\n      throw new EditError(\"field does not exist\");\n    entry[1] = value;\n    this.update();\n\n    let parsed: any = JSON.parse(value);\n\n    Object.assign(item, { [field]: parsed });\n    this.update();\n  }\n\n  triggerAddHandler() {\n    const data: MapTrigger = {\n      id: `${this.state.mapId}:`,\n      condition: {\n        type: MapTriggerType.entityKilled,\n        entityTag: ''\n      }\n    };\n    this.state.triggers.push(data);\n    this.state.triggerDrafts.push(this.makeTriggerDraft(data));\n    this.update();\n  }\n\n  triggerRemoveHandler(index: number) {\n    this.state.triggers.splice(index, 1);\n    this.state.triggerDrafts.splice(index, 1);\n    this.update();\n  }\n\n  toggleDebugRender() {\n    this.setState(({ mapCounter, debugRender }) => ({\n      mapCounter: mapCounter + 1,\n      debugRender: !debugRender\n    }));\n  }\n\n  render() {\n    return (\n      <div className={`MapEditor dock-${this.state.sidebarDock}`}>\n        <input ref={this.refFileInput} type=\"file\" onInput={this.fileHandler} style={{ display: 'none' }} />\n        <Toolbar parent={this} />\n        <Sidebar parent={this} />\n        <Container refMain={this.refContainer} parent={this} />\n      </div>\n    );\n  }\n}\n\ninterface EditorChildProps {\n  parent: MapEditor;\n}\n\n/******** Toolbar ********/\n\nfunction Toolbar({ parent }: EditorChildProps) {\n  const { state } = parent;\n  const { currentTool: tool } = state;\n\n  return (\n    <div className=\"Toolbar\">\n      <button onClick={parent.importHandler}>Import</button>\n      <button onClick={parent.exportHandler}>Export</button>\n      <span className=\"gap\"></span>\n      <button onClick={() => parent.toggleDebugRender()}>\n        Render: {state.debugRender ? \"debug\" : \"normal\"}\n      </button>\n      <span className=\"gap\"></span>\n      <button\n        className={tool.category === \"decoration\" ? \"tool selected\" : \"tool\"}\n        onClick={() => parent.switchTool({ category: 'decoration' })}\n      >decoration</button>\n      <button\n        className={tool.category === \"landmark\" ? \"tool selected\" : \"tool\"}\n        onClick={() => parent.switchTool({ category: 'landmark' })}\n      >landmark</button>\n      <button\n        className={tool.category === \"spawnPoint\" ? \"tool selected\" : \"tool\"}\n        onClick={() => parent.switchTool({ category: 'spawnPoint' })}\n      >spawnPoint</button>\n      {ENTITY_TYPES.map(type => {\n        const classList = [\"tool\"];\n        if (tool.category === \"entity\" && tool.type === type)\n          classList.push(\"selected\");\n        return (\n          <button key={type}\n            className={classList.join(' ')}\n            onClick={() => parent.switchTool({ category: 'entity', type })}\n          >\n            {type}\n          </button>\n        );\n      })}\n    </div>\n  );\n}\n\n/******** Sidebar ********/\n\nfunction Sidebar({ parent }: EditorChildProps) {\n  const { state } = parent;\n  const { itemDraft, sidebarDock, selectedItems, mouseCoord, dragCorner, pxAtom } = state;\n  const toggledSide = { l: 'right', r: 'left' }[sidebarDock];\n\n  const dragCoord = dragCorner && new Coord(dragCorner.x / pxAtom, dragCorner.y / pxAtom).round();\n\n  return (\n    <div className=\"Sidebar\">\n      <div>\n        <strong>Sidebar</strong>&nbsp;\n        <button onClick={() => parent.toggleSidebarDock()}>Dock to {toggledSide}</button>\n      </div>\n      <div>\n        <div><strong>Map Information</strong></div>\n        <div>ID: {state.mapId}&nbsp;<button onClick={() => parent.editMapId()}>Edit</button></div>\n        <div>Map: {state.mapWidth} x {state.mapHeight}</div>\n        <div>Scene: {state.width} x {state.height}</div>\n        <div>Entities: {state.items.filter(x => x.category === 'entity').length}</div>\n        <div>Decorations: {state.items.filter(x => x.category === 'decoration').length}</div>\n        <div>Landmarks: {state.items.filter(x => x.category === 'landmark').length}</div>\n        <div>Spawn Points: {state.items.filter(x => x.category === 'spawnPoint').length}</div>\n        {mouseCoord &&\n          <div>Cursor: ({mouseCoord.x}, {mouseCoord.y}) ({Math.floor(mouseCoord.x / TERRAIN_SIZE)}, {Math.floor(mouseCoord.y / TERRAIN_SIZE)})</div>\n        }\n        {dragCoord &&\n          <div>Drag: ({dragCoord.x}, {dragCoord.y}) {Math.abs(mouseCoord!.x - dragCoord.x)}x{Math.abs(mouseCoord!.y - dragCoord.y)}</div>\n        }\n        {selectedItems.length > 0 &&\n          <div>Selected: {`${selectedItems.length} ${selectedItems.length > 1 ? 'items' : 'item'}`}</div>\n        }\n      </div>\n      {itemDraft &&\n        <div>\n          <strong>Selected Item</strong>\n          <ItemEditor data={itemDraft} onModify={parent.itemModifyHandler} />\n        </div>\n      }\n      {!itemDraft &&\n        <div>\n          <div>\n            <strong>Map Triggers</strong>&nbsp;\n            <button onClick={() => parent.triggerAddHandler()}>Add</button>\n          </div>\n          <div>\n            {state.triggerDrafts.map((draft, index) => (\n              <div key={index}>\n                <div>\n                  <span>Trigger #{index + 1}</span>&nbsp;\n                  <button onClick={() => parent.triggerRemoveHandler(index)}>Remove</button>\n                </div>\n                <ItemEditor data={draft}\n                  onModify={(field, value) => parent.triggersEditHandler(index, field, value)} />\n              </div>\n            ))}\n          </div>\n        </div>\n      }\n      {!itemDraft &&\n        <div>\n          <div>\n            <strong>Map Backgrounds</strong>&nbsp;\n            <button onClick={() => parent.backgroundAddHandler()}>Add</button>\n          </div>\n          <div>\n            {state.backgroundDrafts.map((draft, index) => (\n              <div key={index}>\n                <div>\n                  <span>Layer #{index + 1}</span>&nbsp;\n                  <button onClick={() => parent.backgroundRemoveHandler(index)}>Remove</button>\n                </div>\n                <ItemEditor data={draft}\n                  onModify={(field, value) => parent.backgroundsEditHandler(index, field, value)} />\n              </div>\n            ))}\n          </div>\n        </div>\n      }\n    </div>\n  );\n}\n\n/******** Container ********/\n\ninterface ContainerProps extends EditorChildProps {\n  refMain: React.Ref<HTMLDivElement>;\n}\n\nfunction Container({ parent, refMain }: ContainerProps) {\n  const { state } = parent;\n  const { pxAtom, items, selectedItems, dragCorner, dragCorner2 } = state;\n  const PX = (x: number) => x * pxAtom + 'px';\n  const dragArea = dragCorner2 && AABB.cornered(dragCorner!, dragCorner2);\n\n  return (\n    <div className=\"Container\"\n      onMouseDown={parent.mouseHandler}\n      onMouseUp={parent.mouseHandler}\n      onMouseMove={parent.mouseHandler}\n    >\n      <div ref={refMain} className=\"ContainerBox\"\n        onContextMenu={evt => evt.preventDefault()}\n      >\n        <TerrainCanvas\n          key={state.mapCounter}\n          width={state.mapWidth}\n          height={state.mapHeight}\n          scale={state.scale}\n          terrains={state.terrains}\n          debug={state.debugRender}\n        />\n        {items.map((mapItem) => {\n          const { id, category, item } = mapItem;\n          const handler = (evt: React.MouseEvent) => parent.itemMouseHandler(evt, mapItem);\n          const props = {\n            key: id,\n            style: {\n              left: PX(item.x),\n              top: PX(item.y),\n              '--label': '\"\"'\n            },\n            onMouseDown: handler,\n            onMouseUp: handler,\n            onMouseMove: handler\n          } as any;\n          const classList = ['sprite'];\n          if (selectedItems.includes(mapItem))\n            classList.push('selected');\n          switch (category) {\n            case 'entity': {\n              const { type } = item as MapEntity;\n              classList.push('entity', type);\n              props.style['--label'] = `\"${type}\"`;\n              break;\n            }\n\n            case 'decoration': {\n              const { variant } = item as MapDecoration;\n              classList.push('decoration', variant);\n              props.style['--label'] = `\"${variant}\"`;\n              break;\n            }\n\n            case 'landmark': {\n              const { width, height } = item as MapLandmark;\n              classList.push('landmark');\n              props.style['--label'] = `\"${item.tags.join(',') || 'landmark'}\"`;\n              props.style.width = PX(width);\n              props.style.height = PX(height);\n              break;\n            }\n\n            case 'spawnPoint': {\n              classList.push('spawnPoint');\n              props.style['--label'] = '\"spawn point\"';\n              break;\n            }\n          }\n          console.info(props);\n          return (\n            <div className={classList.join(\" \")} {...props}>\n              <div className=\"box\"></div>\n            </div>\n          );\n        })}\n        {dragArea &&\n          <div className=\"drag-area\" style={{\n            left: dragArea.left + 'px',\n            top: dragArea.top + 'px',\n            width: dragArea.width + 'px',\n            height: dragArea.height + 'px'\n          }}></div>\n        }\n      </div>\n    </div>\n  );\n}\n","import { ReportHandler } from 'web-vitals';\n\nconst reportWebVitals = (onPerfEntry?: ReportHandler) => {\n  if (onPerfEntry && onPerfEntry instanceof Function) {\n    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {\n      getCLS(onPerfEntry);\n      getFID(onPerfEntry);\n      getFCP(onPerfEntry);\n      getLCP(onPerfEntry);\n      getTTFB(onPerfEntry);\n    });\n  }\n};\n\nexport default reportWebVitals;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\nimport MapEditor from './editor/MapEditor';\nimport reportWebVitals from './reportWebVitals';\n\nconst params = new URL(window.location.href).searchParams;\n\nReactDOM.render(\n  <React.StrictMode>\n    {params.has('mapedit') ? <MapEditor /> : <App />}\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n\n// If you want to start measuring performance in your app, pass a function\n// to log results (for example: reportWebVitals(console.log))\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\nreportWebVitals();\n"],"sourceRoot":""}